<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Task Hub - Admin & User Panels</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .claimed-overlay {
            background: rgba(0,0,0,0.7);
        }
        .timer-warning {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-orange-500 to-red-500 rounded-full mx-auto flex items-center justify-center mb-4">
                    <i class="fab fa-reddit-alien text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Reddit Task Hub</h1>
                <p class="text-gray-500 mt-2">Complete Reddit tasks & earn!</p>
            </div>
            <button id="googleLoginBtn" class="w-full bg-white border-2 border-gray-200 rounded-xl px-6 py-3 flex items-center justify-center gap-3 hover:bg-gray-50 transition-all duration-300 shadow-sm hover:shadow">
                <svg class="w-6 h-6" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="text-gray-700 font-medium">Continue with Google</span>
            </button>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- Reddit Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-500 rounded-full mx-auto flex items-center justify-center mb-4">
                    <i class="fab fa-reddit-alien text-3xl text-white"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Complete Your Profile</h2>
                <p class="text-gray-500 text-sm mt-2">Enter your Reddit details (Min 200+ Karma Required)</p>
            </div>
            <form id="profileForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reddit Username</label>
                    <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                        <span class="bg-gray-100 px-3 py-2 text-gray-500">u/</span>
                        <input type="text" id="redditUsername" required class="flex-1 px-4 py-2 focus:outline-none" placeholder="your_username">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Karma</label>
                    <input type="number" id="redditKarma" required min="200" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Your total karma">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reddit Profile Link</label>
                    <input type="url" id="redditProfileLink" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="https://reddit.com/user/your_username">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all">
                    Save Profile
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                        <i class="fab fa-reddit-alien text-xl text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800 hidden sm:block">Reddit Task Hub</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div id="userPoints" class="bg-yellow-100 px-4 py-2 rounded-full flex items-center gap-2">
                        <i class="fas fa-coins text-yellow-500"></i>
                        <span class="font-semibold text-yellow-700">0 Points</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <img id="userAvatar" src="" alt="User" class="w-10 h-10 rounded-full border-2 border-purple-500">
                        <span id="userName" class="font-medium text-gray-700 hidden sm:block"></span>
                        <button id="logoutBtn" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Admin Navigation -->
            <div class="bg-white border-b">
                <div class="max-w-7xl mx-auto px-4 py-3 flex gap-4 overflow-x-auto">
                    <button id="adminTabTasks" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium">Create Tasks</button>
                    <button id="adminTabUsers" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">All Users</button>
                    <button id="adminTabManage" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">Manage Tasks</button>
                </div>
            </div>

            <main class="max-w-7xl mx-auto px-4 py-6">
                <!-- Create Tasks Tab -->
                <div id="adminTasksTab" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-plus-circle text-purple-500"></i>
                            Create New Task
                        </h2>
                        <form id="adminTaskForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Task Type</label>
                                <select id="taskType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="post">üìù Post Task</option>
                                    <option value="comment">üí¨ Comment Task</option>
                                </select>
                            </div>
                            
                            <!-- Post Task Fields -->
                            <div id="postFields" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Post Title *</label>
                                    <input type="text" id="postTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter post title...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Post Body *</label>
                                    <textarea id="postBody" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Write your post content..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Subreddit *</label>
                                    <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                                        <span class="bg-gray-100 px-3 py-2 text-gray-500">r/</span>
                                        <input type="text" id="subreddit" class="flex-1 px-4 py-2 focus:outline-none" placeholder="subreddit_name">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL (Optional)</label>
                                    <input type="url" id="postImage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="https://example.com/image.jpg">
                                </div>
                            </div>

                            <!-- Comment Task Fields -->
                            <div id="commentFields" class="space-y-4 hidden">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reddit Post Link *</label>
                                    <input type="url" id="commentPostLink" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="https://reddit.com/r/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comment Text *</label>
                                    <textarea id="commentText" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="What to comment..."></textarea>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Points Reward *</label>
                                <input type="number" id="taskPoints" min="1" value="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i>
                                Create Task
                            </button>
                        </form>
                    </div>
                </div>

                <!-- All Users Tab -->
                <div id="adminUsersTab" class="hidden">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-users text-purple-500"></i>
                            All Registered Users
                        </h2>
                        <div id="usersList" class="space-y-3">
                            <div class="flex justify-center py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Tasks Tab -->
                <div id="adminManageTab" class="hidden">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-tasks text-purple-500"></i>
                            Manage Tasks
                        </h2>
                        <div id="manageTasksList" class="space-y-4">
                            <div class="flex justify-center py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="hidden">
            <!-- User Navigation -->
            <div class="bg-white border-b">
                <div class="max-w-7xl mx-auto px-4 py-3 flex gap-4 overflow-x-auto">
                    <button id="userTabAvailable" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium">Available Tasks</button>
                    <button id="userTabClaimed" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">My Claimed Tasks</button>
                    <button id="userTabCompleted" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">Completed</button>
                </div>
            </div>

            <main class="max-w-7xl mx-auto px-4 py-6">
                <!-- User Profile Card -->
                <div id="userProfileCard" class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="flex items-center gap-4">
                        <img id="userRedditAvatar" src="" alt="Reddit" class="w-16 h-16 rounded-full border-2 border-orange-500">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800" id="userRedditName">-</h3>
                            <p class="text-gray-500" id="userRedditLink">-</p>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-500" id="userKarma">0</div>
                            <div class="text-sm text-gray-500">Karma</div>
                        </div>
                    </div>
                </div>

                <!-- Available Tasks -->
                <div id="userAvailableTab" class="space-y-4">
                    <div id="availableTasks" class="space-y-4">
                        <div class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div id="noAvailableTasks" class="hidden text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No tasks available right now. Check back later!</p>
                    </div>
                </div>

                <!-- Claimed Tasks -->
                <div id="userClaimedTab" class="hidden space-y-4">
                    <div id="claimedTasks" class="space-y-4">
                        <div class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div id="noClaimedTasks" class="hidden text-center py-12">
                        <i class="fas fa-hand-paper text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">You haven't claimed any tasks yet.</p>
                    </div>
                </div>

                <!-- Completed Tasks -->
                <div id="userCompletedTab" class="hidden space-y-4">
                    <div id="completedTasks" class="space-y-4">
                        <div class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div id="noCompletedTasks" class="hidden text-center py-12">
                        <i class="fas fa-check-circle text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No completed tasks yet.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div id="completionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Submit Task Completion</h2>
            <p class="text-gray-500 text-sm mb-4">Provide the link to your completed task</p>
            <form id="completionForm" class="space-y-4">
                <input type="hidden" id="completionTaskId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Completion Link *</label>
                    <input type="url" id="completionLink" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="https://reddit.com/...">
                </div>
                <div class="flex gap-3">
                    <button type="button" id="cancelCompletion" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all">Cancel</button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion, increment, setDoc, getDoc, deleteDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBRJEmHXbHysb0weZfsVNTzUl0TDTjyuVI",
            authDomain: "earnwithsimpletasks.firebaseapp.com",
            projectId: "earnwithsimpletasks",
            storageBucket: "earnwithsimpletasks.firebasestorage.app",
            messagingSenderId: "942400388770",
            appId: "1:942400388770:web:47475e0a0b60c1fb1b21fb",
            measurementId: "G-132E8PF7LT"
        };

        // Admin emails - Add your admin emails here
        const ADMIN_EMAILS = ['axel197193@gmail.com'];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let userData = null;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userPoints = document.getElementById('userPoints');
        const profileModal = document.getElementById('profileModal');
        const profileForm = document.getElementById('profileForm');
        const adminPanel = document.getElementById('adminPanel');
        const userPanel = document.getElementById('userPanel');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const completionModal = document.getElementById('completionModal');
        const completionForm = document.getElementById('completionForm');

        // Show toast notification
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center gap-2 z-50`;
            setTimeout(() => {
                toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50`;
            }, 3000);
        }

        // Check or create user document
        async function checkOrCreateUser(user) {
            const userRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    points: 0,
                    redditUsername: null,
                    redditKarma: null,
                    redditProfileLink: null,
                    isAdmin: ADMIN_EMAILS.includes(user.email),
                    createdAt: new Date().toISOString()
                });
                return { isNew: true, isAdmin: ADMIN_EMAILS.includes(user.email) };
            }
            return { isNew: false, ...userDoc.data(), isAdmin: userDoc.data().isAdmin || ADMIN_EMAILS.includes(user.email) };
        }

        // Update user points display
        async function updatePointsDisplay() {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                userData = data;
                const points = data.points || 0;
                userPoints.innerHTML = `<i class="fas fa-coins text-yellow-500"></i><span class="font-semibold text-yellow-700">${points} Points</span>`;
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // Format time remaining
        function formatTimeRemaining(claimedAt) {
            const claimed = new Date(claimedAt);
            const now = new Date();
            const elapsed = now - claimed;
            const remaining = 30 * 60 * 1000 - elapsed; // 30 minutes in ms
            
            if (remaining <= 0) return 'Expired';
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            return `${minutes}m ${seconds}s`;
        }

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userAvatar.src = user.photoURL;
                userName.textContent = user.displayName;
                
                const result = await checkOrCreateUser(user);
                userData = result;
                isAdmin = result.isAdmin;
                
                await updatePointsDisplay();
                
                // Check if user has Reddit profile
                if (result.isNew || !result.redditUsername) {
                    if (!isAdmin) {
                        profileModal.classList.remove('hidden');
                    }
                }
                
                if (isAdmin) {
                    adminPanel.classList.remove('hidden');
                    userPanel.classList.add('hidden');
                    loadAdminData();
                } else {
                    adminPanel.classList.add('hidden');
                    userPanel.classList.remove('hidden');
                    loadUserData();
                }
            } else {
                currentUser = null;
                userData = null;
                isAdmin = false;
                loginPage.classList.remove('hidden');
                mainApp.classList.add('hidden');
                profileModal.classList.add('hidden');
            }
        });

        // Google Login
        googleLoginBtn.addEventListener('click', () => {
            googleLoginBtn.disabled = true;
            googleLoginBtn.innerHTML = '<div class="loader mx-auto"></div>';
            
            signInWithPopup(auth, provider)
                .then(() => {
                    googleLoginBtn.innerHTML = `
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span class="text-gray-700 font-medium">Continue with Google</span>
                    `;
                    googleLoginBtn.disabled = false;
                })
                .catch((error) => {
                    console.error(error);
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                    googleLoginBtn.innerHTML = `
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span class="text-gray-700 font-medium">Continue with Google</span>
                    `;
                    googleLoginBtn.disabled = false;
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Profile Form Submit
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const karma = parseInt(document.getElementById('redditKarma').value);
            if (karma < 200) {
                showToast('Minimum 200 karma required!', true);
                return;
            }
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    redditUsername: document.getElementById('redditUsername').value,
                    redditKarma: karma,
                    redditProfileLink: document.getElementById('redditProfileLink').value
                });
                
                profileModal.classList.add('hidden');
                showToast('Profile saved successfully!');
                
                // Reload user data
                userData = await getDoc(userRef).then(doc => doc.data());
                updateUserProfileCard();
            } catch (error) {
                console.error(error);
                showToast('Error saving profile', true);
            }
        });

        // Update User Profile Card
        function updateUserProfileCard() {
            if (!userData) return;
            document.getElementById('userRedditName').textContent = userData.redditUsername ? `u/${userData.redditUsername}` : '-';
            document.getElementById('userRedditLink').textContent = userData.redditProfileLink || '-';
            document.getElementById('userRedditLink').innerHTML = userData.redditProfileLink ? `<a href="${userData.redditProfileLink}" target="_blank" class="text-blue-500 hover:underline">View Profile</a>` : '-';
            document.getElementById('userKarma').textContent = userData.redditKarma || 0;
            document.getElementById('userRedditAvatar').src = `https://www.redditstatic.com/avatars/defaults/v2/avatar_default_1.png`;
        }

        // Task Type Toggle
        document.getElementById('taskType').addEventListener('change', (e) => {
            const type = e.target.value;
            if (type === 'post') {
                document.getElementById('postFields').classList.remove('hidden');
                document.getElementById('commentFields').classList.add('hidden');
            } else {
                document.getElementById('postFields').classList.add('hidden');
                document.getElementById('commentFields').classList.remove('hidden');
            }
        });

        // ==================== ADMIN FUNCTIONS ====================

        // Admin Tab Navigation
        document.getElementById('adminTabTasks').addEventListener('click', () => {
            showAdminTab('tasks');
        });
        document.getElementById('adminTabUsers').addEventListener('click', () => {
            showAdminTab('users');
        });
        document.getElementById('adminTabManage').addEventListener('click', () => {
            showAdminTab('manage');
        });

        function showAdminTab(tab) {
            document.getElementById('adminTasksTab').classList.toggle('hidden', tab !== 'tasks');
            document.getElementById('adminUsersTab').classList.toggle('hidden', tab !== 'users');
            document.getElementById('adminManageTab').classList.toggle('hidden', tab !== 'manage');
            
            document.getElementById('adminTabTasks').className = tab === 'tasks' ? 'px-4 py-2 bg-purple-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
            document.getElementById('adminTabUsers').className = tab === 'users' ? 'px-4 py-2 bg-purple-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
            document.getElementById('adminTabManage').className = tab === 'manage' ? 'px-4 py-2 bg-purple-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
            
            if (tab === 'users') loadUsers();
            if (tab === 'manage') loadManageTasks();
        }

        // Load Admin Data
        function loadAdminData() {
            showAdminTab('tasks');
        }

        // Create Task
        document.getElementById('adminTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const taskType = document.getElementById('taskType').value;
                let taskData = {
                    type: taskType,
                    points: parseInt(document.getElementById('taskPoints').value),
                    status: 'available',
                    createdBy: {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL
                    },
                    createdAt: new Date().toISOString()
                };

                if (taskType === 'post') {
                    taskData.title = document.getElementById('postTitle').value;
                    taskData.body = document.getElementById('postBody').value;
                    taskData.subreddit = document.getElementById('subreddit').value;
                    taskData.image = document.getElementById('postImage').value || null;
                } else {
                    taskData.postLink = document.getElementById('commentPostLink').value;
                    taskData.commentText = document.getElementById('commentText').value;
                }

                await addDoc(collection(db, 'tasks'), taskData);
                e.target.reset();
                document.getElementById('taskPoints').value = 10;
                showToast('Task created successfully!');
            } catch (error) {
                console.error(error);
                showToast('Error creating task', true);
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Create Task';
        });

        // Load All Users
        function loadUsers() {
            const usersList = document.getElementById('usersList');
            const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const users = [];
                snapshot.forEach((doc) => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                if (users.length === 0) {
                    usersList.innerHTML = '<p class="text-center text-gray-500 py-8">No users found</p>';
                    return;
                }

                usersList.innerHTML = users.map(user => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <img src="${user.photoURL}" alt="${user.displayName}" class="w-12 h-12 rounded-full">
                            <div>
                                <h4 class="font-semibold text-gray-800">${user.displayName}</h4>
                                <p class="text-sm text-gray-500">${user.email}</p>
                                <p class="text-sm text-gray-500">
                                    <span class="text-orange-500"><i class="fab fa-reddit"></i></span> 
                                    ${user.redditUsername ? `u/${user.redditUsername} (${user.redditKarma} karma)` : 'No Reddit profile'}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 text-yellow-600 font-medium">
                                <i class="fas fa-coins"></i>
                                ${user.points || 0} pts
                            </div>
                            <p class="text-sm text-gray-400">${formatDate(user.createdAt)}</p>
                            ${user.isAdmin ? '<span class="inline-block mt-1 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">Admin</span>' : ''}
                        </div>
                    </div>
                `).join('');
            });
        }

        // Load Manage Tasks
        function loadManageTasks() {
            const manageTasksList = document.getElementById('manageTasksList');
            const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                
                if (tasks.length === 0) {
                    manageTasksList.innerHTML = '<p class="text-center text-gray-500 py-8">No tasks found</p>';
                    return;
                }

                manageTasksList.innerHTML = tasks.map(task => {
                    const statusColors = {
                        available: 'bg-green-100 text-green-700',
                        claimed: 'bg-yellow-100 text-yellow-700',
                        completed: 'bg-blue-100 text-blue-700',
                        expired: 'bg-red-100 text-red-700'
                    };
                    
                    let taskDetails = '';
                    if (task.type === 'post') {
                        taskDetails = `<p class="text-sm text-gray-600 mt-1"><strong>Subreddit:</strong> r/${task.subreddit}</p>
                                      <p class="text-sm text-gray-600"><strong>Title:</strong> ${task.title}</p>`;
                    } else {
                        taskDetails = `<p class="text-sm text-gray-600 mt-1"><strong>Comment on:</strong> ${task.postLink}</p>`;
                    }

                    return `
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${task.type === 'post' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                                            ${task.type === 'post' ? 'üìù Post' : 'üí¨ Comment'}
                                        </span>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[task.status] || 'bg-gray-100 text-gray-700'}">
                                            ${task.status.toUpperCase()}
                                        </span>
                                        <span class="text-yellow-600 font-medium text-sm">
                                            <i class="fas fa-coins"></i> ${task.points} pts
                                        </span>
                                    </div>
                                    ${taskDetails}
                                    ${task.claimedBy ? `<p class="text-sm text-gray-500 mt-2"><strong>Claimed by:</strong> ${task.claimedBy.displayName}</p>` : ''}
                                    ${task.completedBy ? `<p class="text-sm text-green-600 mt-1"><strong>Completed by:</strong> ${task.completedBy.displayName}</p>` : ''}
                                    <p class="text-xs text-gray-400 mt-2">${formatDate(task.createdAt)}</p>
                                </div>
                                <button onclick="deleteTask('${task.id}')" class="ml-4 text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Delete Task
        window.deleteTask = async function(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                await deleteDoc(doc(db, 'tasks', taskId));
                showToast('Task deleted successfully!');
            } catch (error) {
                console.error(error);
                showToast('Error deleting task', true);
            }
        };

        // ==================== USER FUNCTIONS ====================

        // Load User Data
        function loadUserData() {
            updateUserProfileCard();
            loadAvailableTasks();
            loadClaimedTasks();
            loadCompletedTasks();
        }

        // User Tab Navigation
        document.getElementById('userTabAvailable').addEventListener('click', () => {
            showUserTab('available');
        });
        document.getElementById('userTabClaimed').addEventListener('click', () => {
            showUserTab('claimed');
        });
        document.getElementById('userTabCompleted').addEventListener('click', () => {
            showUserTab('completed');
        });

        function showUserTab(tab) {
            document.getElementById('userAvailableTab').classList.toggle('hidden', tab !== 'available');
            document.getElementById('userClaimedTab').classList.toggle('hidden', tab !== 'claimed');
            document.getElementById('userCompletedTab').classList.toggle('hidden', tab !== 'completed');
            
            document.getElementById('userTabAvailable').className = tab === 'available' ? 'px-4 py-2 bg-green-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
            document.getElementById('userTabClaimed').className = tab === 'claimed' ? 'px-4 py-2 bg-green-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
            document.getElementById('userTabCompleted').className = tab === 'completed' ? 'px-4 py-2 bg-green-500 text-white rounded-lg font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300';
        }

        // Load Available Tasks
        function loadAvailableTasks() {
            const availableTasks = document.getElementById('availableTasks');
            const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    const task = doc.data();
                    // Only show available tasks or tasks claimed by others that have expired
                    if (task.status === 'available' || 
                        (task.status === 'claimed' && isTaskExpired(task.claimedAt))) {
                        tasks.push({ id: doc.id, ...task });
                    }
                });
                
                if (tasks.length === 0) {
                    availableTasks.innerHTML = '';
                    document.getElementById('noAvailableTasks').classList.remove('hidden');
                    return;
                }

                document.getElementById('noAvailableTasks').classList.add('hidden');
                availableTasks.innerHTML = tasks.map(task => renderTaskCard(task)).join('');
            });
        }

        // Check if task is expired
        function isTaskExpired(claimedAt) {
            if (!claimedAt) return true;
            const claimed = new Date(claimedAt);
            const now = new Date();
            const elapsed = now - claimed;
            return elapsed > 30 * 60 * 1000; // 30 minutes
        }

        // Render Task Card
        function renderTaskCard(task) {
            const isExpired = task.status === 'claimed' && isTaskExpired(task.claimedAt);
            
            if (task.type === 'post') {
                return `
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300 ${isExpired ? 'opacity-70' : ''}">
                        <div class="flex items-start gap-2 mb-3">
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">üìù Post Task</span>
                            <span class="text-yellow-600 font-medium text-sm">
                                <i class="fas fa-coins"></i> ${task.points} pts
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${task.title}</h3>
                        ${task.image ? `<img src="${task.image}" alt="Task" class="w-full h-48 object-cover rounded-lg mb-3">` : ''}
                        <p class="text-gray-600 mb-3">${task.body}</p>
                        <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">
                                <i class="fab fa-reddit"></i> r/${task.subreddit}
                            </span>
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <span class="text-sm text-gray-400">${formatDate(task.createdAt)}</span>
                            <button onclick="claimTask('${task.id}')" 
                                class="px-6 py-2 rounded-lg font-medium transition-all bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90"
                                ${isExpired ? '' : ''}>
                                <i class="fas fa-hand-paper mr-1"></i> Claim Task
                            </button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300 ${isExpired ? 'opacity-70' : ''}">
                        <div class="flex items-start gap-2 mb-3">
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">üí¨ Comment Task</span>
                            <span class="text-yellow-600 font-medium text-sm">
                                <i class="fas fa-coins"></i> ${task.points} pts
                            </span>
                        </div>
                        <p class="text-gray-600 mb-3">Comment on this post:</p>
                        <a href="${task.postLink}" target="_blank" class="text-blue-500 hover:underline break-all mb-3 block">
                            <i class="fab fa-reddit"></i> ${task.postLink}
                        </a>
                        <div class="bg-gray-50 p-3 rounded-lg mb-4">
                            <p class="text-sm text-gray-600"><strong>Comment:</strong> ${task.commentText}</p>
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <span class="text-sm text-gray-400">${formatDate(task.createdAt)}</span>
                            <button onclick="claimTask('${task.id}')" 
                                class="px-6 py-2 rounded-lg font-medium transition-all bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90">
                                <i class="fas fa-hand-paper mr-1"></i> Claim Task
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Claim Task
        window.claimTask = async function(taskId) {
            if (!currentUser) return;
            
            try {
                // Check if user has enough karma
                if (!userData || !userData.redditUsername || userData.redditKarma < 200) {
                    showToast('Minimum 200+ karma required!', true);
                    return;
                }
                
                const taskRef = doc(db, 'tasks', taskId);
                await updateDoc(taskRef, {
                    status: 'claimed',
                    claimedBy: {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL
                    },
                    claimedAt: new Date().toISOString()
                });
                
                showToast('Task claimed! Complete within 30 minutes');
            } catch (error) {
                console.error(error);
                showToast('Error claiming task', true);
            }
        };

        // Load Claimed Tasks
        function loadClaimedTasks() {
            const claimedTasks = document.getElementById('claimedTasks');
            const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    const task = doc.data();
                    // Show tasks claimed by current user that are not completed or expired
                    if (task.status === 'claimed' && 
                        task.claimedBy && 
                        task.claimedBy.uid === currentUser.uid &&
                        !isTaskExpired(task.claimedAt)) {
                        tasks.push({ id: doc.id, ...task });
                    }
                });
                
                if (tasks.length === 0) {
                    claimedTasks.innerHTML = '';
                    document.getElementById('noClaimedTasks').classList.remove('hidden');
                    return;
                }

                document.getElementById('noClaimedTasks').classList.add('hidden');
                claimedTasks.innerHTML = tasks.map(task => {
                    const timeRemaining = formatTimeRemaining(task.claimedAt);
                    const isExpired = timeRemaining === 'Expired';
                    
                    if (task.type === 'post') {
                        return `
                            <div class="bg-white rounded-xl shadow-md p-6 border-2 ${isExpired ? 'border-red-300' : 'border-yellow-300'}">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">üìù Post Task</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${isExpired ? 'bg-red-100 text-red-700 timer-warning' : 'bg-yellow-100 text-yellow-700'}">
                                        <i class="fas fa-clock"></i> ${timeRemaining}
                                    </span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">${task.title}</h3>
                                <p class="text-gray-600 mb-3">${task.body}</p>
                                <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">
                                        <i class="fab fa-reddit"></i> r/${task.subreddit}
                                    </span>
                                    <span class="text-yellow-600 font-medium">
                                        <i class="fas fa-coins"></i> ${task.points} pts
                                    </span>
                                </div>
                                ${!isExpired ? `
                                    <button onclick="openCompletionModal('${task.id}')" class="w-full px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90">
                                        <i class="fas fa-check-circle mr-1"></i> Submit Completion Link
                                    </button>
                                ` : `
                                    <div class="text-center text-red-500 font-medium">Time expired! Task released back to pool.</div>
                                `}
                            </div>
                        `;
                    } else {
                        return `
                            <div class="bg-white rounded-xl shadow-md p-6 border-2 ${isExpired ? 'border-red-300' : 'border-yellow-300'}">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">üí¨ Comment Task</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${isExpired ? 'bg-red-100 text-red-700 timer-warning' : 'bg-yellow-100 text-yellow-700'}">
                                        <i class="fas fa-clock"></i> ${timeRemaining}
                                    </span>
                                </div>
                                <a href="${task.postLink}" target="_blank" class="text-blue-500 hover:underline break-all mb-2 block">
                                    <i class="fab fa-reddit"></i> ${task.postLink}
                                </a>
                                <div class="bg-gray-50 p-3 rounded-lg mb-3">
                                    <p class="text-sm text-gray-600"><strong>Comment:</strong> ${task.commentText}</p>
                                </div>
                                <div class="text-sm text-gray-500 mb-4">
                                    <span class="text-yellow-600 font-medium">
                                        <i class="fas fa-coins"></i> ${task.points} pts
                                    </span>
                                </div>
                                ${!isExpired ? `
                                    <button onclick="openCompletionModal('${task.id}')" class="w-full px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90">
                                        <i class="fas fa-check-circle mr-1"></i> Submit Completion Link
                                    </button>
                                ` : `
                                    <div class="text-center text-red-500 font-medium">Time expired! Task released back to pool.</div>
                                `}
                            </div>
                        `;
                    }
                }).join('');
                
                // Update timer every second
                updateClaimedTimers();
            });
        }

        // Update claimed task timers
        function updateClaimedTimers() {
            // This will be called periodically to update timers
        }

        // Open Completion Modal
        window.openCompletionModal = function(taskId) {
            document.getElementById('completionTaskId').value = taskId;
            document.getElementById('completionLink').value = '';
            completionModal.classList.remove('hidden');
        };

        // Close Completion Modal
        document.getElementById('cancelCompletion').addEventListener('click', () => {
            completionModal.classList.add('hidden');
        });

        // Submit Completion
        completionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskId = document.getElementById('completionTaskId').value;
            const completionLink = document.getElementById('completionLink').value;
            
            try {
                const taskRef = doc(db, 'tasks', taskId);
                const userRef = doc(db, 'users', currentUser.uid);
                
                // Get task points
                const taskDoc = await getDoc(taskRef);
                const points = taskDoc.data().points;
                
                // Update task status
                await updateDoc(taskRef, {
                    status: 'completed',
                    completedBy: {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL
                    },
                    completedAt: new Date().toISOString(),
                    completionLink: completionLink
                });
                
                // Increment user points
                await updateDoc(userRef, {
                    points: increment(points)
                });
                
                completionModal.classList.add('hidden');
                await updatePointsDisplay();
                showToast(`Task completed! +${points} Points earned! üéâ`);
            } catch (error) {
                console.error(error);
                showToast('Error submitting completion', true);
            }
        });

        // Load Completed Tasks
        function loadCompletedTasks() {
            const completedTasks = document.getElementById('completedTasks');
            const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    const task = doc.data();
                    // Show tasks completed by current user
                    if (task.status === 'completed' && 
                        task.completedBy && 
                        task.completedBy.uid === currentUser.uid) {
                        tasks.push({ id: doc.id, ...task });
                    }
                });
                
                if (tasks.length === 0) {
                    completedTasks.innerHTML = '';
                    document.getElementById('noCompletedTasks').classList.remove('hidden');
                    return;
                }

                document.getElementById('noCompletedTasks').classList.add('hidden');
                completedTasks.innerHTML = tasks.map(task => {
                    if (task.type === 'post') {
                        return `
                            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-green-300">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                        <i class="fas fa-check"></i> Completed
                                    </span>
                                    <span class="text-yellow-600 font-medium text-sm">
                                        <i class="fas fa-coins"></i> ${task.points} pts earned
                                    </span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">${task.title}</h3>
                                <p class="text-gray-600 mb-3">${task.body}</p>
                                <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
                                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">
                                        <i class="fab fa-reddit"></i> r/${task.subreddit}
                                    </span>
                                </div>
                                <a href="${task.completionLink}" target="_blank" class="text-blue-500 hover:underline text-sm">
                                    <i class="fas fa-external-link-alt"></i> View your post
                                </a>
                                <p class="text-xs text-gray-400 mt-3">Completed: ${formatDate(task.completedAt)}</p>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-green-300">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                        <i class="fas fa-check"></i> Completed
                                    </span>
                                    <span class="text-yellow-600 font-medium text-sm">
                                        <i class="fas fa-coins"></i> ${task.points} pts earned
                                    </span>
                                </div>
                                <a href="${task.postLink}" target="_blank" class="text-blue-500 hover:underline break-all mb-2 block">
                                    <i class="fab fa-reddit"></i> ${task.postLink}
                                </a>
                                <div class="bg-gray-50 p-3 rounded-lg mb-3">
                                    <p class="text-sm text-gray-600"><strong>Comment:</strong> ${task.commentText}</p>
                                </div>
                                <a href="${task.completionLink}" target="_blank" class="text-blue-500 hover:underline text-sm">
                                    <i class="fas fa-external-link-alt"></i> View your comment
                                </a>
                                <p class="text-xs text-gray-400 mt-3">Completed: ${formatDate(task.completedAt)}</p>
                            </div>
                        `;
                    }
                }).join('');
            });
        }

        // Check for expired tasks periodically
        setInterval(async () => {
            if (!currentUser) return;
            
            const q = query(collection(db, 'tasks'), where('status', '==', 'claimed'));
            const snapshot = await getDocs(q);
            
            snapshot.forEach(async (taskDoc) => {
                const task = taskDoc.data();
                if (isTaskExpired(task.claimedAt)) {
                    await updateDoc(doc(db, 'tasks', taskDoc.id), {
                        status: 'available',
                        claimedBy: null,
                        claimedAt: null
                    });
                }
            });
        }, 60000); // Check every minute
    </script>
</body>
</html>
