<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Task Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .task-card:hover { transform: translateY(-2px); }
        .timer-warning { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .google-btn {
            background: linear-gradient(135deg, #4285F4, #34A853, #FBBC05, #EA4335);
            background-size: 300% 300%;
            animation: gradient-shift 3s ease infinite;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
        }
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #4B5563;
        }
        .divider span {
            padding: 0 10px;
            color: #9CA3AF;
            font-size: 0.875rem;
        }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #F97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .big-spinner {
            width: 48px;
            height: 48px;
            border-width: 4px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        .binance-gradient {
            background: linear-gradient(135deg, #F0B90B, #F8D12F);
        }
        .upi-gradient {
            background: linear-gradient(135deg, #5F259F, #8B5CF6);
        }
        .copy-btn {
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            transform: scale(1.05);
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <div id="app" class="flex-grow">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner big-spinner mx-auto mb-4"></div>
                <p class="text-gray-400">Connecting to Firebase...</p>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300" id="loadingText">Loading...</p>
        </div>
    </div>
    
    <!-- Footer -->
    <footer id="appFooter" class="bg-gray-800 border-t border-gray-700 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center space-x-2">
                    <i class="fab fa-reddit text-orange-500 text-xl"></i>
                    <span class="font-semibold">Reddit Task Platform</span>
                    <span class="text-gray-500 text-sm">Â© 2024</span>
                </div>
                
                <div class="flex items-center space-x-2 text-gray-400 text-sm">
                    <span>Need help or have questions?</span>
                </div>
                
                <a href="https://discord.gg/PUBdGxrKGg" target="_blank" 
                    class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition group">
                    <svg class="w-5 h-5 text-white group-hover:scale-110 transition-transform" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    <span class="text-white font-medium">Join Discord Server</span>
                </a>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700 text-center text-gray-500 text-xs">
                <p>For any issues, discussions, or support, please reach out on our Discord server.</p>
            </div>
        </div>
    </footer>
    
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status bg-yellow-600 text-white">
        <i class="fas fa-circle-notch fa-spin mr-2"></i>Connecting...
    </div>

    <!-- Firebase v10 Modular SDK -->
    <script type="module">
        // ============================================
        // FIREBASE v10 MODULAR IMPORTS
        // ============================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            addDoc,
            query, 
            where, 
            orderBy, 
            onSnapshot,
            runTransaction,
            serverTimestamp,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // =====================================================
        // FIREBASE CONFIGURATION
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBRJEmHXbHysb0weZfsVNTzUl0TDTjyuVI",
            authDomain: "earnwithsimpletasks.firebaseapp.com",
            projectId: "earnwithsimpletasks",
            storageBucket: "earnwithsimpletasks.firebasestorage.app",
            messagingSenderId: "942400388770",
            appId: "1:942400388770:web:47475e0a0b60c1fb1b21fb",
            measurementId: "G-132E8PF7LT"
        };

        // Initialize Firebase v10
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const googleProvider = new GoogleAuthProvider();
        
        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseGoogleProvider = googleProvider;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = signOut;

        // ============================================
        // FIRESTORE DATABASE OPERATIONS
        // ============================================
        const FirestoreDB = {
            // Initialize admin user if not exists
            async initAdmin() {
                try {
                    const adminRef = doc(db, 'users', 'admin_axel769');
                    const adminDoc = await getDoc(adminRef);
                    
                    if (!adminDoc.exists()) {
                        await setDoc(adminRef, {
                            id: 'admin_axel769',
                            username: 'axel769',
                            password: 'axel8129',
                            email: 'admin@redditplatform.com',
                            redditKarma: 10000,
                            accountAge: 24,
                            walletBalance: 0,
                            role: 'admin',
                            authProvider: 'local',
                            createdAt: serverTimestamp()
                        });
                        console.log('Admin user created in Firestore');
                    }
                } catch (error) {
                    console.error('Error initializing admin:', error);
                }
            },

            // USER OPERATIONS
            async getUser(userId) {
                try {
                    const userRef = doc(db, 'users', userId);
                    const userDoc = await getDoc(userRef);
                    return userDoc.exists() ? { id: userDoc.id, ...userDoc.data() } : null;
                } catch (error) {
                    console.error('Error getting user:', error);
                    return null;
                }
            },

            async getUserByUsername(username) {
                try {
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('username', '==', username));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) return null;
                    const docSnap = snapshot.docs[0];
                    return { id: docSnap.id, ...docSnap.data() };
                } catch (error) {
                    console.error('Error getting user by username:', error);
                    return null;
                }
            },

            async getUserByEmail(email) {
                try {
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('email', '==', email));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) return null;
                    const docSnap = snapshot.docs[0];
                    return { id: docSnap.id, ...docSnap.data() };
                } catch (error) {
                    console.error('Error getting user by email:', error);
                    return null;
                }
            },

            async createUser(userData) {
                try {
                    const userRef = doc(db, 'users', userData.id);
                    await setDoc(userRef, {
                        ...userData,
                        createdAt: serverTimestamp()
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error creating user:', error);
                    return { success: false, error: error.message };
                }
            },

            async updateUser(userId, updates) {
                try {
                    const userRef = doc(db, 'users', userId);
                    await updateDoc(userRef, updates);
                    return { success: true };
                } catch (error) {
                    console.error('Error updating user:', error);
                    return { success: false, error: error.message };
                }
            },

            async getAllUsers() {
                try {
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('role', '==', 'user'));
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting all users:', error);
                    return [];
                }
            },

            // TASK OPERATIONS
            async createTask(taskData) {
                try {
                    const taskRef = doc(db, 'tasks', taskData.taskId);
                    await setDoc(taskRef, {
                        ...taskData,
                        createdAt: serverTimestamp()
                    });
                    return { success: true, task: taskData };
                } catch (error) {
                    console.error('Error creating task:', error);
                    return { success: false, error: error.message };
                }
            },

            async getTask(taskId) {
                try {
                    const taskRef = doc(db, 'tasks', taskId);
                    const taskDoc = await getDoc(taskRef);
                    return taskDoc.exists() ? { id: taskDoc.id, ...taskDoc.data() } : null;
                } catch (error) {
                    console.error('Error getting task:', error);
                    return null;
                }
            },

            async updateTask(taskId, updates) {
                try {
                    const taskRef = doc(db, 'tasks', taskId);
                    await updateDoc(taskRef, updates);
                    return { success: true };
                } catch (error) {
                    console.error('Error updating task:', error);
                    return { success: false, error: error.message };
                }
            },

            async deleteTask(taskId) {
                try {
                    const taskRef = doc(db, 'tasks', taskId);
                    await deleteDoc(taskRef);
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting task:', error);
                    return { success: false, error: error.message };
                }
            },

            async getAllTasks() {
                try {
                    const tasksRef = collection(db, 'tasks');
                    const snapshot = await getDocs(tasksRef);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting all tasks:', error);
                    return [];
                }
            },

            async getAvailableTasks() {
                try {
                    await this.checkExpiredReservations();
                    
                    const tasksRef = collection(db, 'tasks');
                    const q = query(tasksRef, where('status', '==', 'available'));
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting available tasks:', error);
                    return [];
                }
            },

            async getReservedTasks(userId) {
                try {
                    await this.checkExpiredReservations();
                    
                    const tasksRef = collection(db, 'tasks');
                    const q = query(
                        tasksRef, 
                        where('status', '==', 'reserved'),
                        where('reservedBy', '==', userId)
                    );
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting reserved tasks:', error);
                    return [];
                }
            },

            // FCFS Task Accept with Transaction
            async acceptTask(taskId, userId) {
                try {
                    const taskRef = doc(db, 'tasks', taskId);
                    
                    const result = await runTransaction(db, async (transaction) => {
                        const taskDoc = await transaction.get(taskRef);
                        
                        if (!taskDoc.exists()) {
                            throw new Error('Task not found');
                        }
                        
                        const task = taskDoc.data();
                        
                        if (task.status !== 'available') {
                            throw new Error('Task is no longer available');
                        }
                        
                        const submissionsRef = collection(db, 'submissions');
                        const q = query(
                            submissionsRef,
                            where('taskId', '==', taskId),
                            where('userId', '==', userId)
                        );
                        const existingSubmissions = await getDocs(q);
                        
                        if (!existingSubmissions.empty) {
                            throw new Error('You have already worked on this task');
                        }
                        
                        transaction.update(taskRef, {
                            status: 'reserved',
                            reservedBy: userId,
                            reservedAt: Date.now()
                        });
                        
                        return { success: true };
                    });
                    
                    return result;
                } catch (error) {
                    console.error('Error accepting task:', error);
                    return { success: false, error: error.message };
                }
            },

            async checkExpiredReservations() {
                try {
                    const thirtyMinutesAgo = Date.now() - (30 * 60 * 1000);
                    const tasksRef = collection(db, 'tasks');
                    const q = query(tasksRef, where('status', '==', 'reserved'));
                    const snapshot = await getDocs(q);
                    
                    const updatePromises = [];
                    snapshot.docs.forEach(doc => {
                        const task = doc.data();
                        if (task.reservedAt && task.reservedAt < thirtyMinutesAgo) {
                            updatePromises.push(
                                updateDoc(doc.ref, {
                                    status: 'available',
                                    reservedBy: null,
                                    reservedAt: null
                                })
                            );
                        }
                    });
                    
                    await Promise.all(updatePromises);
                } catch (error) {
                    console.error('Error checking expired reservations:', error);
                }
            },

            // SUBMISSION OPERATIONS
            async createSubmission(submissionData) {
                try {
                    const subRef = doc(db, 'submissions', submissionData.id);
                    await setDoc(subRef, {
                        ...submissionData,
                        submittedAt: Date.now()
                    });
                    return { success: true, submission: submissionData };
                } catch (error) {
                    console.error('Error creating submission:', error);
                    return { success: false, error: error.message };
                }
            },

            async getSubmission(submissionId) {
                try {
                    const subRef = doc(db, 'submissions', submissionId);
                    const subDoc = await getDoc(subRef);
                    return subDoc.exists() ? { id: subDoc.id, ...subDoc.data() } : null;
                } catch (error) {
                    console.error('Error getting submission:', error);
                    return null;
                }
            },

            async updateSubmission(submissionId, updates) {
                try {
                    const subRef = doc(db, 'submissions', submissionId);
                    await updateDoc(subRef, updates);
                    return { success: true };
                } catch (error) {
                    console.error('Error updating submission:', error);
                    return { success: false, error: error.message };
                }
            },

            async getAllSubmissions() {
                try {
                    const subsRef = collection(db, 'submissions');
                    const snapshot = await getDocs(subsRef);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting all submissions:', error);
                    return [];
                }
            },

            async getUserSubmissions(userId) {
                try {
                    const subsRef = collection(db, 'submissions');
                    const q = query(subsRef, where('userId', '==', userId));
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting user submissions:', error);
                    return [];
                }
            },

            // Approve submission with wallet update
            async approveSubmission(submissionId) {
                try {
                    const subRef = doc(db, 'submissions', submissionId);
                    
                    const result = await runTransaction(db, async (transaction) => {
                        const subDoc = await transaction.get(subRef);
                        
                        if (!subDoc.exists()) {
                            throw new Error('Submission not found');
                        }
                        
                        const submission = subDoc.data();
                        
                        if (submission.status !== 'pending') {
                            throw new Error('Submission already processed');
                        }
                        
                        const taskRef = doc(db, 'tasks', submission.taskId);
                        const taskDoc = await transaction.get(taskRef);
                        
                        if (!taskDoc.exists()) {
                            throw new Error('Task not found');
                        }
                        
                        const task = taskDoc.data();
                        
                        const userRef = doc(db, 'users', submission.userId);
                        const userDoc = await transaction.get(userRef);
                        
                        if (!userDoc.exists()) {
                            throw new Error('User not found');
                        }
                        
                        const user = userDoc.data();
                        
                        transaction.update(subRef, { status: 'approved' });
                        transaction.update(taskRef, { status: 'approved' });
                        transaction.update(userRef, { 
                            walletBalance: (user.walletBalance || 0) + task.price 
                        });
                        
                        return { success: true };
                    });
                    
                    return result;
                } catch (error) {
                    console.error('Error approving submission:', error);
                    return { success: false, error: error.message };
                }
            },

            async rejectSubmission(submissionId) {
                try {
                    const subRef = doc(db, 'submissions', submissionId);
                    const subDoc = await getDoc(subRef);
                    
                    if (!subDoc.exists()) {
                        return { success: false, error: 'Submission not found' };
                    }
                    
                    const submission = subDoc.data();
                    
                    if (submission.status !== 'pending') {
                        return { success: false, error: 'Submission already processed' };
                    }
                    
                    await updateDoc(subRef, { status: 'rejected' });
                    
                    const taskRef = doc(db, 'tasks', submission.taskId);
                    await updateDoc(taskRef, { status: 'rejected' });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error rejecting submission:', error);
                    return { success: false, error: error.message };
                }
            },

            // WITHDRAWAL OPERATIONS
            async createWithdrawal(withdrawalData) {
                try {
                    const withdrawalRef = doc(db, 'withdrawals', withdrawalData.id);
                    await setDoc(withdrawalRef, {
                        ...withdrawalData,
                        createdAt: Date.now()
                    });
                    return { success: true, withdrawal: withdrawalData };
                } catch (error) {
                    console.error('Error creating withdrawal:', error);
                    return { success: false, error: error.message };
                }
            },

            async getAllWithdrawals() {
                try {
                    const withdrawalsRef = collection(db, 'withdrawals');
                    const snapshot = await getDocs(withdrawalsRef);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting withdrawals:', error);
                    return [];
                }
            },

            async getUserWithdrawals(userId) {
                try {
                    const withdrawalsRef = collection(db, 'withdrawals');
                    const q = query(withdrawalsRef, where('userId', '==', userId));
                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error getting user withdrawals:', error);
                    return [];
                }
            },

            async approveWithdrawal(withdrawalId) {
                try {
                    const withdrawalRef = doc(db, 'withdrawals', withdrawalId);
                    
                    const result = await runTransaction(db, async (transaction) => {
                        const withdrawalDoc = await transaction.get(withdrawalRef);
                        
                        if (!withdrawalDoc.exists()) {
                            throw new Error('Withdrawal not found');
                        }
                        
                        const withdrawal = withdrawalDoc.data();
                        
                        if (withdrawal.status !== 'pending') {
                            throw new Error('Withdrawal already processed');
                        }
                        
                        const userRef = doc(db, 'users', withdrawal.userId);
                        const userDoc = await transaction.get(userRef);
                        
                        if (!userDoc.exists()) {
                            throw new Error('User not found');
                        }
                        
                        const user = userDoc.data();
                        
                        if ((user.walletBalance || 0) < withdrawal.amount) {
                            throw new Error('Insufficient balance');
                        }
                        
                        transaction.update(withdrawalRef, { 
                            status: 'approved',
                            processedAt: Date.now()
                        });
                        transaction.update(userRef, { 
                            walletBalance: (user.walletBalance || 0) - withdrawal.amount 
                        });
                        
                        return { success: true };
                    });
                    
                    return result;
                } catch (error) {
                    console.error('Error approving withdrawal:', error);
                    return { success: false, error: error.message };
                }
            },

            async rejectWithdrawal(withdrawalId) {
                try {
                    const withdrawalRef = doc(db, 'withdrawals', withdrawalId);
                    await updateDoc(withdrawalRef, { 
                        status: 'rejected',
                        processedAt: Date.now()
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error rejecting withdrawal:', error);
                    return { success: false, error: error.message };
                }
            }
        };

        // ============================================
        // AUTH MANAGER
        // ============================================
        const Auth = {
            currentUser: null,
            
            async init() {
                const session = localStorage.getItem('reddit_platform_session');
                if (session) {
                    const userData = JSON.parse(session);
                    const user = await FirestoreDB.getUser(userData.id);
                    if (user) {
                        this.currentUser = user;
                    } else {
                        localStorage.removeItem('reddit_platform_session');
                    }
                }
            },
            
            async login(username, password) {
                showLoading('Logging in...');
                
                const user = await FirestoreDB.getUserByUsername(username);
                
                if (!user || user.password !== password) {
                    hideLoading();
                    return { success: false, error: 'Invalid credentials' };
                }
                
                this.currentUser = user;
                localStorage.setItem('reddit_platform_session', JSON.stringify(user));
                
                hideLoading();
                return { success: true, user };
            },
            
            async loginWithGoogle() {
                try {
                    showLoading('Signing in with Google...');
                    
                    const result = await signInWithPopup(auth, googleProvider);
                    const googleUser = result.user;
                    
                    let user = await FirestoreDB.getUserByEmail(googleUser.email);
                    
                    if (!user) {
                        const newUser = {
                            id: 'google_' + googleUser.uid,
                            username: googleUser.displayName || googleUser.email.split('@')[0],
                            email: googleUser.email,
                            photoURL: googleUser.photoURL,
                            password: null,
                            authProvider: 'google',
                            redditKarma: 0,
                            accountAge: 0,
                            walletBalance: 0,
                            role: 'user',
                            needsRedditInfo: true
                        };
                        
                        await FirestoreDB.createUser(newUser);
                        user = newUser;
                    }
                    
                    this.currentUser = user;
                    localStorage.setItem('reddit_platform_session', JSON.stringify(user));
                    
                    hideLoading();
                    return { success: true, user, needsRedditInfo: user.needsRedditInfo };
                } catch (error) {
                    hideLoading();
                    console.error('Google sign-in error:', error);
                    
                    let errorMessage = 'Google sign-in failed';
                    
                    if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = 'Domain not authorized. Add this domain to Firebase Console.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Popup blocked. Please allow popups.';
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in cancelled.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    return { success: false, error: errorMessage };
                }
            },
            
            async register(username, password, redditProfileLink, redditKarma, accountAge) {
                showLoading('Creating account...');
                
                const existing = await FirestoreDB.getUserByUsername(username);
                if (existing) {
                    hideLoading();
                    return { success: false, error: 'Username already exists' };
                }
                
                // Validate Reddit profile link
                if (!redditProfileLink || !redditProfileLink.includes('reddit.com/user/')) {
                    hideLoading();
                    return { success: false, error: 'Please enter a valid Reddit profile link (e.g., https://reddit.com/user/yourname)' };
                }
                
                const newUser = {
                    id: 'user_' + Date.now(),
                    username,
                    password,
                    email: null,
                    redditProfileLink,
                    redditKarma: parseInt(redditKarma),
                    accountAge: parseInt(accountAge),
                    walletBalance: 0,
                    role: 'user',
                    authProvider: 'local',
                    needsRedditInfo: false
                };
                
                const result = await FirestoreDB.createUser(newUser);
                
                if (!result.success) {
                    hideLoading();
                    return result;
                }
                
                this.currentUser = newUser;
                localStorage.setItem('reddit_platform_session', JSON.stringify(newUser));
                
                hideLoading();
                return { success: true, user: newUser };
            },
            
            async updateRedditInfo(redditProfileLink, karma, accountAge) {
                showLoading('Saving Reddit info...');
                
                // Validate Reddit profile link
                if (!redditProfileLink || !redditProfileLink.includes('reddit.com/user/')) {
                    hideLoading();
                    return { success: false, error: 'Please enter a valid Reddit profile link (e.g., https://reddit.com/user/yourname)' };
                }
                
                const result = await FirestoreDB.updateUser(this.currentUser.id, {
                    redditProfileLink,
                    redditKarma: parseInt(karma),
                    accountAge: parseInt(accountAge),
                    needsRedditInfo: false
                });
                
                if (result.success) {
                    this.currentUser.redditProfileLink = redditProfileLink;
                    this.currentUser.redditKarma = parseInt(karma);
                    this.currentUser.accountAge = parseInt(accountAge);
                    this.currentUser.needsRedditInfo = false;
                    localStorage.setItem('reddit_platform_session', JSON.stringify(this.currentUser));
                }
                
                hideLoading();
                return result;
            },
            
            async refreshUser() {
                if (!this.currentUser) return;
                const user = await FirestoreDB.getUser(this.currentUser.id);
                if (user) {
                    this.currentUser = user;
                    localStorage.setItem('reddit_platform_session', JSON.stringify(user));
                }
            },
            
            logout() {
                signOut(auth).catch(err => console.log('Firebase signout:', err));
                this.currentUser = null;
                localStorage.removeItem('reddit_platform_session');
            },
            
            isEligible(user = this.currentUser) {
                if (!user) return false;
                return user.redditKarma >= 200 && user.accountAge >= 1;
            }
        };

        // ============================================
        // TASK MANAGER
        // ============================================
        const TaskManager = {
            async generateTaskId() {
                // Get all tasks to find the highest ID
                const allTasks = await FirestoreDB.getAllTasks();
                let maxId = 999;
                allTasks.forEach(task => {
                    const taskNum = parseInt(task.taskId);
                    if (!isNaN(taskNum) && taskNum > maxId) {
                        maxId = taskNum;
                    }
                });
                return String(maxId + 1);
            },
            
            async getUserDailyTaskCounts(userId) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStart = today.getTime();
                
                const submissions = await FirestoreDB.getUserSubmissions(userId);
                const allTasks = await FirestoreDB.getAllTasks();
                
                let postCount = 0;
                let commentCount = 0;
                
                submissions.forEach(sub => {
                    if (sub.submittedAt >= todayStart) {
                        const task = allTasks.find(t => t.taskId === sub.taskId);
                        if (task) {
                            if (task.type === 'post') postCount++;
                            else if (task.type === 'comment') commentCount++;
                        }
                    }
                });
                
                // Also count reserved tasks for today
                const reservedTasks = await FirestoreDB.getReservedTasks(userId);
                reservedTasks.forEach(task => {
                    if (task.reservedAt >= todayStart) {
                        if (task.type === 'post') postCount++;
                        else if (task.type === 'comment') commentCount++;
                    }
                });
                
                return { postCount, commentCount };
            },
            
            canAcceptTask(taskType, dailyCounts) {
                if (taskType === 'post') {
                    return dailyCounts.postCount < 3;
                } else if (taskType === 'comment') {
                    return dailyCounts.commentCount < 10;
                }
                return false;
            },
            
            async createTask(taskData) {
                const taskId = await this.generateTaskId();
                const task = {
                    taskId: taskId,
                    type: taskData.type,
                    title: taskData.title || '',
                    body: taskData.body || '',
                    image: taskData.image || '',
                    postLink: taskData.postLink || '',
                    commentText: taskData.commentText || '',
                    price: parseFloat(taskData.price),
                    status: 'available',
                    reservedBy: null,
                    reservedAt: null
                };
                
                return await FirestoreDB.createTask(task);
            },
            
            async updateTask(taskId, updates) {
                const task = await FirestoreDB.getTask(taskId);
                if (!task) return { success: false, error: 'Task not found' };
                if (task.status !== 'available') {
                    return { success: false, error: 'Cannot edit task that is not available' };
                }
                return await FirestoreDB.updateTask(taskId, updates);
            },
            
            async deleteTask(taskId) {
                const task = await FirestoreDB.getTask(taskId);
                if (!task) return { success: false, error: 'Task not found' };
                if (task.status !== 'available') {
                    return { success: false, error: 'Cannot delete task that is not available' };
                }
                return await FirestoreDB.deleteTask(taskId);
            },
            
            async getAvailableTasks() {
                return await FirestoreDB.getAvailableTasks();
            },
            
            async getMyReservedTasks(userId) {
                return await FirestoreDB.getReservedTasks(userId);
            },
            
            async acceptTask(taskId, userId) {
                // Check daily limits first
                const task = await FirestoreDB.getTask(taskId);
                if (!task) return { success: false, error: 'Task not found' };
                
                const dailyCounts = await this.getUserDailyTaskCounts(userId);
                
                if (!this.canAcceptTask(task.type, dailyCounts)) {
                    if (task.type === 'post') {
                        return { success: false, error: 'Daily limit reached! You can only accept 3 post tasks per day.' };
                    } else {
                        return { success: false, error: 'Daily limit reached! You can only accept 10 comment tasks per day.' };
                    }
                }
                
                return await FirestoreDB.acceptTask(taskId, userId);
            },
            
            getRemainingTime(task) {
                if (!task.reservedAt) return 0;
                const thirtyMinutes = 30 * 60 * 1000;
                const elapsed = Date.now() - task.reservedAt;
                return Math.max(0, thirtyMinutes - elapsed);
            },
            
            async submitTask(taskId, userId, redditLink) {
                const task = await FirestoreDB.getTask(taskId);
                
                if (!task) return { success: false, error: 'Task not found' };
                if (task.status !== 'reserved' || task.reservedBy !== userId) {
                    return { success: false, error: 'You cannot submit this task' };
                }
                
                const isValidRedditLink = redditLink.includes('reddit.com') || redditLink.includes('redd.it');
                if (!isValidRedditLink) {
                    return { success: false, error: 'Please provide a valid Reddit link' };
                }
                
                const submission = {
                    id: 'sub_' + Date.now(),
                    taskId,
                    userId,
                    redditLink,
                    status: 'pending'
                };
                
                const result = await FirestoreDB.createSubmission(submission);
                
                if (result.success) {
                    await FirestoreDB.updateTask(taskId, { status: 'submitted' });
                }
                
                return result;
            }
        };

        // ============================================
        // WITHDRAWAL MANAGER
        // ============================================
        const WithdrawalManager = {
            async createWithdrawal(userId, amount, method, details) {
                const user = await FirestoreDB.getUser(userId);
                
                if (!user) return { success: false, error: 'User not found' };
                if ((user.walletBalance || 0) < amount) {
                    return { success: false, error: 'Insufficient balance' };
                }
                if (amount < 2) {
                    return { success: false, error: 'Minimum withdrawal is $2.00' };
                }
                
                const withdrawal = {
                    id: 'wd_' + Date.now(),
                    userId,
                    username: user.username,
                    amount: parseFloat(amount),
                    method,
                    details,
                    status: 'pending'
                };
                
                return await FirestoreDB.createWithdrawal(withdrawal);
            },
            
            async getUserWithdrawals(userId) {
                return await FirestoreDB.getUserWithdrawals(userId);
            },
            
            async getAllWithdrawals() {
                const withdrawals = await FirestoreDB.getAllWithdrawals();
                const users = await FirestoreDB.getAllUsers();
                
                return withdrawals.map(wd => {
                    const user = users.find(u => u.id === wd.userId);
                    return { ...wd, user };
                });
            },
            
            async approveWithdrawal(withdrawalId) {
                return await FirestoreDB.approveWithdrawal(withdrawalId);
            },
            
            async rejectWithdrawal(withdrawalId) {
                return await FirestoreDB.rejectWithdrawal(withdrawalId);
            }
        };

        // ============================================
        // ADMIN MANAGER
        // ============================================
        const AdminManager = {
            async getAllSubmissions() {
                const submissions = await FirestoreDB.getAllSubmissions();
                const tasks = await FirestoreDB.getAllTasks();
                const users = await FirestoreDB.getAllUsers();
                
                return submissions.map(sub => {
                    const task = tasks.find(t => t.taskId === sub.taskId);
                    const user = users.find(u => u.id === sub.userId);
                    return { ...sub, task, user };
                });
            },
            
            async approveSubmission(submissionId) {
                return await FirestoreDB.approveSubmission(submissionId);
            },
            
            async rejectSubmission(submissionId) {
                return await FirestoreDB.rejectSubmission(submissionId);
            },
            
            async getAllUsers() {
                return await FirestoreDB.getAllUsers();
            },
            
            async getAllTasks() {
                await FirestoreDB.checkExpiredReservations();
                return await FirestoreDB.getAllTasks();
            }
        };

        // ============================================
        // UI HELPERS
        // ============================================
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateFirebaseStatus(connected, message) {
            const statusEl = document.getElementById('firebaseStatus');
            if (connected) {
                statusEl.className = 'firebase-status bg-green-600 text-white';
                statusEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + message;
            } else {
                statusEl.className = 'firebase-status bg-red-600 text-white';
                statusEl.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + message;
            }
            
            if (connected) {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // ============================================
        // UI RENDERING
        // ============================================
        let activeTab = 'available';
        let adminTab = 'tasks';

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        async function render() {
            const app = document.getElementById('app');
            
            if (!Auth.currentUser) {
                app.innerHTML = renderAuthPage();
            } else if (Auth.currentUser.needsRedditInfo) {
                app.innerHTML = renderRedditInfoPage();
            } else if (Auth.currentUser.role === 'admin') {
                app.innerHTML = await renderAdminPanel();
            } else {
                app.innerHTML = await renderUserPanel();
            }
            
            attachEventListeners();
        }

        function renderNavbar(isAdmin = false) {
            const eligible = Auth.isEligible();
            const photoURL = Auth.currentUser.photoURL;
            
            return `
                <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <i class="fab fa-reddit text-orange-500 text-2xl"></i>
                                    <span class="text-xl font-bold">Reddit Tasks</span>
                                </div>
                                <span class="bg-green-600 text-xs px-2 py-1 rounded-full">
                                    <i class="fas fa-database mr-1"></i>Firebase
                                </span>
                                ${isAdmin ? '<span class="bg-purple-600 text-xs px-2 py-1 rounded-full">ADMIN</span>' : ''}
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                ${!isAdmin ? `
                                    <button onclick="openWalletModal()" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-lg transition cursor-pointer">
                                        <i class="fas fa-wallet text-green-400"></i>
                                        <span class="font-semibold">$${(Auth.currentUser.walletBalance || 0).toFixed(2)}</span>
                                        <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                                    </button>
                                ` : ''}
                                
                                <div class="flex items-center space-x-2">
                                    ${photoURL ? `
                                        <img src="${photoURL}" alt="Profile" class="w-8 h-8 rounded-full border-2 border-orange-500">
                                    ` : `
                                        <i class="fas fa-user text-gray-400"></i>
                                    `}
                                    <span>${Auth.currentUser.username}</span>
                                    ${Auth.currentUser.authProvider === 'google' ? '<i class="fab fa-google text-xs text-blue-400"></i>' : ''}
                                </div>
                                
                                <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm transition">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    ${!isAdmin ? `
                        <div class="bg-gradient-to-r ${eligible ? 'from-green-900 to-green-800' : 'from-red-900 to-red-800'} px-4 py-2">
                            <div class="max-w-7xl mx-auto flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i class="fas ${eligible ? 'fa-check-circle text-green-400' : 'fa-exclamation-triangle text-yellow-400'}"></i>
                                    <span class="text-sm">
                                        ${eligible 
                                            ? 'You are eligible to accept tasks! Your Comment or Post Must be live for 5 day for payout Qualification' 
                                            : 'Eligibility Required: Minimum 200 karma & 1 month old Reddit account'}
                                    </span>
                                </div>
                                <div class="flex items-center space-x-4 text-sm">
                                    <span class="${Auth.currentUser.redditKarma >= 200 ? 'text-green-400' : 'text-red-400'}">
                                        <i class="fas fa-arrow-up mr-1"></i>${Auth.currentUser.redditKarma || 0} karma
                                    </span>
                                    <span class="${Auth.currentUser.accountAge >= 1 ? 'text-green-400' : 'text-red-400'}">
                                        <i class="fas fa-calendar mr-1"></i>${Auth.currentUser.accountAge || 0} month(s) old
                                    </span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </nav>
            `;
        }

        function renderAuthPage() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 px-4">
                    <div class="max-w-md w-full">
                        <div class="text-center mb-8">
                            <i class="fab fa-reddit text-orange-500 text-6xl mb-4"></i>
                            <h1 class="text-3xl font-bold">Reddit Task Platform</h1>
                            <p class="text-gray-400 mt-2">Complete Reddit tasks and earn rewards</p>
                            <div class="mt-3 inline-flex items-center px-3 py-1 bg-green-900/50 border border-green-700 rounded-full text-sm text-green-400">
                                <i class="fas fa-database mr-2"></i>Powered by Firebase
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl border border-gray-700">
                            <button onclick="handleGoogleLogin()" 
                                class="w-full google-btn text-white py-3 rounded-lg font-semibold transition flex items-center justify-center space-x-3 mb-6 hover:opacity-90">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span>Continue with Google</span>
                            </button>
                            
                            <div class="divider mb-6">
                                <span>or sign in with credentials</span>
                            </div>
                            
                            <div class="flex mb-6">
                                <button onclick="switchAuthTab('login')" id="loginTab" 
                                    class="flex-1 py-2 text-center border-b-2 border-orange-500 text-orange-500 font-semibold">
                                    Login
                                </button>
                                <button onclick="switchAuthTab('register')" id="registerTab"
                                    class="flex-1 py-2 text-center border-b-2 border-gray-600 text-gray-400 hover:text-white">
                                    Register
                                </button>
                            </div>
                            
                            <div id="loginForm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Username</label>
                                        <input type="text" id="loginUsername" 
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="Enter username">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                                        <input type="password" id="loginPassword"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="Enter password">
                                    </div>
                                    <button onclick="handleLogin()" 
                                        class="w-full bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-semibold transition">
                                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                                    </button>
                                </div>
                              
                            </div>
                            
                            <div id="registerForm" class="hidden">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Username</label>
                                        <input type="text" id="regUsername"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="Choose username">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                                        <input type="password" id="regPassword"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="Choose password">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">
                                            <i class="fab fa-reddit text-orange-500 mr-1"></i>Reddit Profile Link
                                        </label>
                                        <input type="url" id="regRedditProfile"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="https://reddit.com/user/yourname">
                                        <p class="text-xs text-gray-500 mt-1">Required to verify your Reddit account</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Your Reddit Karma</label>
                                        <input type="number" id="regKarma"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="e.g. 500">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Account Age (months)</label>
                                        <input type="number" id="regAge"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                                            placeholder="e.g. 6">
                                    </div>
                                    <button onclick="handleRegister()"
                                        class="w-full bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-semibold transition">
                                        <i class="fas fa-user-plus mr-2"></i>Register
                                    </button>
                                </div>
                            </div>
                            
                            <div id="authError" class="hidden mt-4 bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg text-sm"></div>
                        </div>
                        
                        <div class="mt-6 bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                            <h3 class="font-semibold text-orange-400 mb-2"><i class="fas fa-info-circle mr-2"></i>Eligibility Requirements</h3>
                            <ul class="text-sm text-gray-400 space-y-1">
                                <li>â¢ Minimum 200 Reddit karma</li>
                                <li>â¢ Account age at least 1 month</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRedditInfoPage() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 px-4">
                    <div class="max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-full border-4 border-orange-500 overflow-hidden">
                                ${Auth.currentUser.photoURL 
                                    ? `<img src="${Auth.currentUser.photoURL}" alt="Profile" class="w-full h-full object-cover">`
                                    : `<div class="w-full h-full bg-gray-700 flex items-center justify-center"><i class="fas fa-user text-3xl text-gray-400"></i></div>`
                                }
                            </div>
                            <h1 class="text-2xl font-bold">Welcome, ${Auth.currentUser.username}!</h1>
                            <p class="text-gray-400 mt-2">Almost there! We need your Reddit account details</p>
                        </div>
                        
                        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl border border-gray-700">
                            <div class="flex items-center space-x-3 mb-6 p-3 bg-blue-900/30 rounded-lg border border-blue-700">
                                <i class="fab fa-google text-blue-400"></i>
                                <span class="text-sm text-blue-300">Signed in with ${Auth.currentUser.email}</span>
                            </div>
                            
                            <h2 class="text-lg font-semibold mb-4">
                                <i class="fab fa-reddit text-orange-500 mr-2"></i>
                                Reddit Account Details
                            </h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">
                                        <i class="fab fa-reddit text-orange-500 mr-1"></i>Reddit Profile Link
                                    </label>
                                    <input type="url" id="redditProfileLink"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-orange-500 focus:outline-none"
                                        placeholder="https://reddit.com/user/yourname">
                                    <p class="text-xs text-gray-500 mt-1">Required to verify your Reddit account</p>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Your Reddit Karma</label>
                                    <input type="number" id="redditKarma"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-orange-500 focus:outline-none"
                                        placeholder="Enter your Reddit karma (e.g. 500)">
                                    <p class="text-xs text-gray-500 mt-1">You can find this on your Reddit profile</p>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Account Age (months)</label>
                                    <input type="number" id="redditAge"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-orange-500 focus:outline-none"
                                        placeholder="How many months old is your Reddit account?">
                                </div>
                                
                                <div id="redditInfoError" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg text-sm"></div>
                                
                                <button onclick="saveRedditInfo()"
                                    class="w-full bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-semibold transition">
                                    <i class="fas fa-check mr-2"></i>Complete Setup
                                </button>
                                
                                <button onclick="handleLogout()"
                                    class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm transition">
                                    <i class="fas fa-arrow-left mr-2"></i>Sign out and use different account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderUserPanel() {
            await Auth.refreshUser();
            const eligible = Auth.isEligible();
            const availableTasks = await TaskManager.getAvailableTasks();
            const myReservedTasks = await TaskManager.getMyReservedTasks(Auth.currentUser.id);
            const allTasks = await FirestoreDB.getAllTasks();
            const mySubmissions = await FirestoreDB.getUserSubmissions(Auth.currentUser.id);
            const myWithdrawals = await WithdrawalManager.getUserWithdrawals(Auth.currentUser.id);
            const dailyCounts = await TaskManager.getUserDailyTaskCounts(Auth.currentUser.id);
            
            return `
                ${renderNavbar(false)}
                
                <div class="max-w-7xl mx-auto px-4 py-6">
                    <!-- Reddit Profile Link -->
                    <div class="bg-gradient-to-r from-orange-900/50 to-orange-800/50 rounded-xl p-4 border border-orange-700 mb-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center space-x-3">
                                <i class="fab fa-reddit text-orange-500 text-2xl"></i>
                                <div>
                                    <p class="text-sm text-gray-400">Your Reddit Profile</p>
                                    <a href="${Auth.currentUser.redditProfileLink || '#'}" target="_blank" 
                                        class="text-orange-400 hover:text-orange-300 hover:underline font-medium">
                                        ${Auth.currentUser.redditProfileLink || 'Not provided'}
                                    </a>
                                </div>
                            </div>
                            <div class="flex items-center space-x-6">
                                <div class="text-center">
                                    <p class="text-xs text-gray-500">Daily Post Tasks</p>
                                    <p class="font-bold ${dailyCounts.postCount >= 3 ? 'text-red-400' : 'text-green-400'}">${dailyCounts.postCount}/3</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-500">Daily Comment Tasks</p>
                                    <p class="font-bold ${dailyCounts.commentCount >= 10 ? 'text-red-400' : 'text-green-400'}">${dailyCounts.commentCount}/10</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Available Tasks</p>
                                    <p class="text-2xl font-bold">${availableTasks.length}</p>
                                </div>
                                <i class="fas fa-tasks text-3xl text-blue-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">My Active Tasks</p>
                                    <p class="text-2xl font-bold">${myReservedTasks.length}</p>
                                </div>
                                <i class="fas fa-clock text-3xl text-yellow-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Completed</p>
                                    <p class="text-2xl font-bold">${mySubmissions.filter(s => s.status === 'approved').length}</p>
                                </div>
                                <i class="fas fa-check-circle text-3xl text-green-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 cursor-pointer hover:border-green-500 transition" onclick="openWalletModal()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Wallet Balance</p>
                                    <p class="text-2xl font-bold text-green-400">$${(Auth.currentUser.walletBalance || 0).toFixed(2)}</p>
                                </div>
                                <i class="fas fa-wallet text-3xl text-green-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Search Bar -->
                    <div class="bg-gray-800 rounded-xl p-4 mb-6 border border-gray-700">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div class="flex-1 min-w-[200px]">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="userSearchInput" placeholder="Search by Task ID..."
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 focus:border-orange-500 focus:outline-none"
                                        onkeyup="handleUserSearch()">
                                </div>
                            </div>
                            <button onclick="clearUserSearch()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg transition">
                                <i class="fas fa-times mr-2"></i>Clear
                            </button>
                        </div>
                        <div id="userSearchResults" class="hidden mt-4"></div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="flex space-x-2 mb-6 border-b border-gray-700 pb-2 overflow-x-auto">
                        <button onclick="switchUserTab('available')" 
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${activeTab === 'available' ? 'bg-orange-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-list mr-2"></i>Available Tasks
                        </button>
                        <button onclick="switchUserTab('active')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${activeTab === 'active' ? 'bg-orange-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-hourglass-half mr-2"></i>My Active Tasks
                            ${myReservedTasks.length > 0 ? `<span class="ml-2 bg-red-500 text-xs px-2 py-0.5 rounded-full">${myReservedTasks.length}</span>` : ''}
                        </button>
                        <button onclick="switchUserTab('history')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${activeTab === 'history' ? 'bg-orange-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-history mr-2"></i>Submission History
                        </button>
                        <button onclick="switchUserTab('withdrawals')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${activeTab === 'withdrawals' ? 'bg-orange-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-money-bill-wave mr-2"></i>Withdrawals
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div id="tabContent">
                        ${activeTab === 'available' ? renderAvailableTasks(availableTasks, eligible, dailyCounts) : ''}
                        ${activeTab === 'active' ? renderActiveTasks(myReservedTasks) : ''}
                        ${activeTab === 'history' ? renderSubmissionHistory(mySubmissions, allTasks) : ''}
                        ${activeTab === 'withdrawals' ? renderUserWithdrawals(myWithdrawals) : ''}
                    </div>
                </div>
                
                ${renderSubmitModal()}
                ${renderWalletModal()}
            `;
        }

        function renderAvailableTasks(tasks, eligible, dailyCounts) {
            if (tasks.length === 0) {
                return `
                    <div class="text-center py-16 bg-gray-800 rounded-xl border border-gray-700">
                        <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-xl">No tasks available right now</p>
                        <p class="text-gray-500 mt-2">Check back later for new tasks!</p>
                    </div>
                `;
            }
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${tasks.map(task => {
                        const canAccept = eligible && TaskManager.canAcceptTask(task.type, dailyCounts);
                        const limitReached = eligible && !TaskManager.canAcceptTask(task.type, dailyCounts);
                        let buttonText = '';
                        let buttonClass = '';
                        
                        if (!eligible) {
                            buttonText = '<i class="fas fa-lock mr-2"></i>Not Eligible';
                            buttonClass = 'bg-gray-600 cursor-not-allowed text-gray-400';
                        } else if (limitReached) {
                            buttonText = '<i class="fas fa-ban mr-2"></i>Daily Limit Reached';
                            buttonClass = 'bg-red-900 cursor-not-allowed text-red-300';
                        } else {
                            buttonText = '<i class="fas fa-hand-pointer mr-2"></i>Accept Task';
                            buttonClass = 'bg-orange-600 hover:bg-orange-700';
                        }
                        
                        return `
                        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 task-card transition hover:border-orange-500">
                            <div class="flex items-start justify-between mb-3">
                                <span class="px-3 py-1 ${task.type === 'post' ? 'bg-blue-600' : 'bg-purple-600'} rounded-full text-xs font-semibold">
                                    ${task.type === 'post' ? '<i class="fas fa-file-alt mr-1"></i>Post Task' : '<i class="fas fa-comment mr-1"></i>Comment Task'}
                                </span>
                                <span class="text-green-400 font-bold text-lg">$${task.price.toFixed(2)}</span>
                            </div>
                            
                            <div class="mb-4">
                                <p class="text-xs text-gray-500 mb-1">Task ID: #${task.taskId}</p>
                                ${task.type === 'post' ? `
                                    <h3 class="font-semibold text-lg mb-2">${task.title}</h3>
                                    <p class="text-gray-400 text-sm line-clamp-2">${task.body}</p>
                                    ${task.image ? `<p class="text-xs text-gray-500 mt-2"><i class="fas fa-image mr-1"></i>Has image attachment</p>` : ''}
                                ` : `
                                    <p class="text-gray-400 text-sm mb-2"><i class="fas fa-link mr-1"></i>${task.postLink}</p>
                                    <div class="bg-gray-700 rounded-lg p-3 mt-2">
                                        <p class="text-sm italic">"${task.commentText}"</p>
                                    </div>
                                `}
                            </div>
                            
                            <button onclick="acceptTask('${task.taskId}')" 
                                ${!canAccept ? 'disabled' : ''}
                                class="w-full py-2 rounded-lg font-semibold transition ${buttonClass}">
                                ${buttonText}
                            </button>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function renderActiveTasks(tasks) {
            if (tasks.length === 0) {
                return `
                    <div class="text-center py-16 bg-gray-800 rounded-xl border border-gray-700">
                        <i class="fas fa-clipboard-list text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-xl">No active tasks</p>
                        <p class="text-gray-500 mt-2">Accept a task to get started!</p>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-4">
                    ${tasks.map(task => {
                        const remaining = TaskManager.getRemainingTime(task);
                        const isUrgent = remaining < 5 * 60 * 1000;
                        
                        // Escape quotes for onclick handlers
                        const escapedTitle = (task.title || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const escapedBody = (task.body || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const escapedComment = (task.commentText || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                        
                        return `
                            <div class="bg-gray-800 rounded-xl p-5 border ${isUrgent ? 'border-red-500' : 'border-gray-700'}">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 ${task.type === 'post' ? 'bg-blue-600' : 'bg-purple-600'} rounded-full text-xs font-semibold">
                                            ${task.type === 'post' ? 'Post Task' : 'Comment Task'}
                                        </span>
                                        <span class="text-xs text-gray-500">#${task.taskId}</span>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <span class="text-green-400 font-bold text-lg">$${task.price.toFixed(2)}</span>
                                        <div class="flex items-center space-x-2 ${isUrgent ? 'text-red-400 timer-warning' : 'text-yellow-400'}">
                                            <i class="fas fa-clock"></i>
                                            <span class="font-mono font-bold" id="timer-${task.taskId}">${formatTime(remaining)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                                    ${task.type === 'post' ? `
                                        <!-- Post Title with Copy -->
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <label class="text-xs text-gray-400 uppercase tracking-wide mb-1 block">Title</label>
                                                <h3 class="font-semibold text-lg" id="title-${task.taskId}">${task.title}</h3>
                                            </div>
                                            <button onclick="copyToClipboard('${escapedTitle}', this)" 
                                                class="ml-3 bg-gray-600 hover:bg-gray-500 p-2 rounded-lg transition group" title="Copy Title">
                                                <i class="fas fa-copy text-gray-300 group-hover:text-white"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Post Body with Copy -->
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <label class="text-xs text-gray-400 uppercase tracking-wide mb-1 block">Body</label>
                                                <p class="text-gray-300 text-sm whitespace-pre-wrap" id="body-${task.taskId}">${task.body}</p>
                                            </div>
                                            <button onclick="copyToClipboard(\`${escapedBody}\`, this)" 
                                                class="ml-3 bg-gray-600 hover:bg-gray-500 p-2 rounded-lg transition group" title="Copy Body">
                                                <i class="fas fa-copy text-gray-300 group-hover:text-white"></i>
                                            </button>
                                        </div>
                                        
                                        ${task.image ? `
                                            <div class="mt-3 pt-3 border-t border-gray-600">
                                                <label class="text-xs text-gray-400 uppercase tracking-wide mb-2 block">Image</label>
                                                <div class="flex items-start justify-between">
                                                    <img src="${task.image}" alt="Task image" class="rounded-lg max-h-48 object-cover">
                                                    <button onclick="copyToClipboard('${task.image}', this)" 
                                                        class="ml-3 bg-gray-600 hover:bg-gray-500 p-2 rounded-lg transition group" title="Copy Image URL">
                                                        <i class="fas fa-link text-gray-300 group-hover:text-white"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ` : ''}
                                    ` : `
                                        <!-- Post Link with Copy -->
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <label class="text-xs text-gray-400 uppercase tracking-wide mb-1 block">Post Link</label>
                                                <a href="${task.postLink}" target="_blank" class="text-blue-400 hover:underline break-all">${task.postLink}</a>
                                            </div>
                                            <button onclick="copyToClipboard('${task.postLink}', this)" 
                                                class="ml-3 bg-gray-600 hover:bg-gray-500 p-2 rounded-lg transition group" title="Copy Link">
                                                <i class="fas fa-copy text-gray-300 group-hover:text-white"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Comment Text with Copy -->
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <label class="text-xs text-gray-400 uppercase tracking-wide mb-1 block">Comment to Post</label>
                                                <div class="bg-gray-600 rounded p-3 text-gray-200" id="comment-${task.taskId}">${task.commentText}</div>
                                            </div>
                                            <button onclick="copyToClipboard(\`${escapedComment}\`, this)" 
                                                class="ml-3 bg-gray-600 hover:bg-gray-500 p-2 rounded-lg transition group" title="Copy Comment">
                                                <i class="fas fa-copy text-gray-300 group-hover:text-white"></i>
                                            </button>
                                        </div>
                                    `}
                                </div>
                                
                                <button onclick="openSubmitModal('${task.taskId}')"
                                    class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold transition">
                                    <i class="fas fa-paper-plane mr-2"></i>Submit Reddit Link
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderSubmissionHistory(submissions, allTasks) {
            if (submissions.length === 0) {
                return `
                    <div class="text-center py-16 bg-gray-800 rounded-xl border border-gray-700">
                        <i class="fas fa-history text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-xl">No submission history</p>
                        <p class="text-gray-500 mt-2">Your completed tasks will appear here</p>
                    </div>
                `;
            }
            
            return `
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm">Task ID</th>
                                <th class="px-4 py-3 text-left text-sm">Reddit Link</th>
                                <th class="px-4 py-3 text-left text-sm">Submitted</th>
                                <th class="px-4 py-3 text-left text-sm">Status</th>
                                <th class="px-4 py-3 text-right text-sm">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submissions.map(sub => {
                                const task = allTasks.find(t => t.taskId === sub.taskId);
                                const statusColors = {
                                    pending: 'bg-yellow-600',
                                    approved: 'bg-green-600',
                                    rejected: 'bg-red-600'
                                };
                                return `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                                        <td class="px-4 py-3 text-sm font-mono">${sub.taskId}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <a href="${sub.redditLink}" target="_blank" class="text-blue-400 hover:underline">
                                                ${sub.redditLink.substring(0, 40)}...
                                            </a>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-400">${formatDate(sub.submittedAt)}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 ${statusColors[sub.status]} rounded-full text-xs capitalize">
                                                ${sub.status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-right font-semibold ${sub.status === 'approved' ? 'text-green-400' : 'text-gray-400'}">
                                            ${sub.status === 'approved' ? '+' : ''}$${task ? task.price.toFixed(2) : '0.00'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderUserWithdrawals(withdrawals) {
            if (withdrawals.length === 0) {
                return `
                    <div class="text-center py-16 bg-gray-800 rounded-xl border border-gray-700">
                        <i class="fas fa-money-bill-wave text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-xl">No withdrawal history</p>
                        <p class="text-gray-500 mt-2">Your withdrawal requests will appear here</p>
                        <button onclick="openWalletModal()" class="mt-4 bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-wallet mr-2"></i>Request Withdrawal
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm">ID</th>
                                <th class="px-4 py-3 text-left text-sm">Amount</th>
                                <th class="px-4 py-3 text-left text-sm">Method</th>
                                <th class="px-4 py-3 text-left text-sm">Details</th>
                                <th class="px-4 py-3 text-left text-sm">Date</th>
                                <th class="px-4 py-3 text-left text-sm">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${withdrawals.map(wd => {
                                const statusColors = {
                                    pending: 'bg-yellow-600',
                                    approved: 'bg-green-600',
                                    rejected: 'bg-red-600'
                                };
                                return `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                                        <td class="px-4 py-3 text-sm font-mono">${wd.id}</td>
                                        <td class="px-4 py-3 font-semibold text-green-400">$${wd.amount.toFixed(2)}</td>
                                        <td class="px-4 py-3">
                                            <span class="flex items-center">
                                                ${wd.method === 'binance' 
                                                    ? '<i class="fab fa-bitcoin text-yellow-400 mr-2"></i>Binance'
                                                    : '<i class="fas fa-mobile-alt text-purple-400 mr-2"></i>UPI'
                                                }
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-400">${wd.details}</td>
                                        <td class="px-4 py-3 text-sm text-gray-400">${formatDate(wd.createdAt)}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 ${statusColors[wd.status]} rounded-full text-xs capitalize">
                                                ${wd.status}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderSubmitModal() {
            return `
                <div id="submitModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop flex items-center justify-center z-50 px-4">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Submit Task</h3>
                            <button onclick="closeSubmitModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <input type="hidden" id="submitTaskId">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Reddit Link</label>
                                <input type="url" id="redditLink"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-orange-500 focus:outline-none"
                                    placeholder="https://reddit.com/r/...">
                                <p class="text-xs text-gray-500 mt-1">Paste the Reddit post or comment permalink</p>
                            </div>
                            <div id="submitError" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg text-sm"></div>
                            <button onclick="submitTask()"
                                class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-check mr-2"></i>Submit for Review
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWalletModal() {
            const balance = Auth.currentUser.walletBalance || 0;
            return `
                <div id="walletModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop flex items-center justify-center z-50 px-4">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold"><i class="fas fa-wallet text-green-400 mr-2"></i>Wallet</h3>
                            <button onclick="closeWalletModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Balance Display -->
                        <div class="bg-gradient-to-r from-green-900 to-green-800 rounded-xl p-6 mb-6 text-center">
                            <p class="text-gray-300 text-sm mb-1">Available Balance</p>
                            <p class="text-4xl font-bold text-green-400">$${balance.toFixed(2)}</p>
                        </div>
                        
                        ${balance >= 2 ? `
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-300">Withdraw Funds</h4>
                                <p class="text-xs text-yellow-500"><i class="fas fa-info-circle mr-1"></i>Minimum withdrawal: $2.00</p>
                                
                                <!-- Amount -->
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Amount ($)</label>
                                    <input type="number" id="withdrawAmount" step="0.01" min="2" max="${balance}"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-green-500 focus:outline-none"
                                        placeholder="Enter amount" value="${balance.toFixed(2)}">
                                </div>
                                
                                <!-- Method Selection -->
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Withdrawal Method</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="selectWithdrawMethod('binance')" id="methodBinance"
                                            class="p-4 rounded-lg border-2 border-gray-600 hover:border-yellow-500 transition flex flex-col items-center">
                                            <i class="fab fa-bitcoin text-3xl text-yellow-400 mb-2"></i>
                                            <span class="font-semibold">Binance</span>
                                            <span class="text-xs text-gray-500">Pay ID / USDT</span>
                                        </button>
                                        <button onclick="selectWithdrawMethod('upi')" id="methodUpi"
                                            class="p-4 rounded-lg border-2 border-gray-600 hover:border-purple-500 transition flex flex-col items-center">
                                            <i class="fas fa-mobile-alt text-3xl text-purple-400 mb-2"></i>
                                            <span class="font-semibold">UPI</span>
                                            <span class="text-xs text-gray-500">UPI ID</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Binance Details -->
                                <div id="binanceDetails" class="hidden">
                                    <label class="block text-sm text-gray-400 mb-1">
                                        <i class="fab fa-bitcoin text-yellow-400 mr-1"></i>Binance Pay ID or USDT Address
                                    </label>
                                    <input type="text" id="binanceId"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-yellow-500 focus:outline-none"
                                        placeholder="Enter Binance Pay ID or TRC20/BEP20 address">
                                </div>
                                
                                <!-- UPI Details -->
                                <div id="upiDetails" class="hidden">
                                    <label class="block text-sm text-gray-400 mb-1">
                                        <i class="fas fa-mobile-alt text-purple-400 mr-1"></i>UPI ID
                                    </label>
                                    <input type="text" id="upiId"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none"
                                        placeholder="yourname@upi">
                                </div>
                                
                                <div id="withdrawError" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg text-sm"></div>
                                
                                <button onclick="requestWithdrawal()" id="withdrawBtn" disabled
                                    class="w-full bg-gray-600 py-3 rounded-lg font-semibold transition cursor-not-allowed">
                                    <i class="fas fa-paper-plane mr-2"></i>Select a withdrawal method
                                </button>
                            </div>
                        ` : `
                            <div class="text-center py-6">
                                <i class="fas fa-piggy-bank text-5xl text-gray-600 mb-4"></i>
                                <p class="text-gray-400">Minimum balance required: <strong class="text-green-400">$2.00</strong></p>
                                <p class="text-gray-500 text-sm mt-2">Complete more tasks to reach the minimum withdrawal amount!</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ============================================
        // ADMIN PANEL
        // ============================================
        async function renderAdminPanel() {
            const allTasks = await AdminManager.getAllTasks();
            const allSubmissions = await AdminManager.getAllSubmissions();
            const allUsers = await AdminManager.getAllUsers();
            const allWithdrawals = await WithdrawalManager.getAllWithdrawals();
            
            return `
                ${renderNavbar(true)}
                
                <div class="max-w-7xl mx-auto px-4 py-6">
                    <!-- Admin Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Tasks</p>
                                    <p class="text-2xl font-bold">${allTasks.length}</p>
                                </div>
                                <i class="fas fa-tasks text-3xl text-blue-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Pending Reviews</p>
                                    <p class="text-2xl font-bold">${allSubmissions.filter(s => s.status === 'pending').length}</p>
                                </div>
                                <i class="fas fa-hourglass-half text-3xl text-yellow-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Users</p>
                                    <p class="text-2xl font-bold">${allUsers.length}</p>
                                </div>
                                <i class="fas fa-users text-3xl text-green-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Approved Tasks</p>
                                    <p class="text-2xl font-bold">${allSubmissions.filter(s => s.status === 'approved').length}</p>
                                </div>
                                <i class="fas fa-check-circle text-3xl text-green-400"></i>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 border border-yellow-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Pending Withdrawals</p>
                                    <p class="text-2xl font-bold text-yellow-400">${allWithdrawals.filter(w => w.status === 'pending').length}</p>
                                </div>
                                <i class="fas fa-money-bill-wave text-3xl text-yellow-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Search Bar -->
                    <div class="bg-gray-800 rounded-xl p-4 mb-6 border border-gray-700">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div class="flex-1 min-w-[200px]">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="adminSearchInput" placeholder="Search by Task ID, Username, or User ID..."
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 focus:border-purple-500 focus:outline-none"
                                        onkeyup="handleAdminSearch()">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <select id="adminStatusFilter" onchange="handleAdminSearch()"
                                    class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                    <option value="all">All Status</option>
                                    <option value="available">Available</option>
                                    <option value="reserved">Reserved</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button onclick="clearAdminSearch()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg transition">
                                    <i class="fas fa-times mr-2"></i>Clear
                                </button>
                            </div>
                        </div>
                        <div id="adminSearchResults" class="hidden mt-4"></div>
                    </div>
                    
                    <!-- Admin Tabs -->
                    <div class="flex space-x-2 mb-6 border-b border-gray-700 pb-2 overflow-x-auto">
                        <button onclick="switchAdminTab('tasks')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${adminTab === 'tasks' ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-tasks mr-2"></i>Manage Tasks
                        </button>
                        <button onclick="switchAdminTab('submissions')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${adminTab === 'submissions' ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-file-alt mr-2"></i>Submissions
                            ${allSubmissions.filter(s => s.status === 'pending').length > 0 ? 
                                `<span class="ml-2 bg-red-500 text-xs px-2 py-0.5 rounded-full">${allSubmissions.filter(s => s.status === 'pending').length}</span>` : ''}
                        </button>
                        <button onclick="switchAdminTab('withdrawals')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${adminTab === 'withdrawals' ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-money-bill-wave mr-2"></i>Withdrawals
                            ${allWithdrawals.filter(w => w.status === 'pending').length > 0 ? 
                                `<span class="ml-2 bg-yellow-500 text-xs px-2 py-0.5 rounded-full">${allWithdrawals.filter(w => w.status === 'pending').length}</span>` : ''}
                        </button>
                        <button onclick="switchAdminTab('users')"
                            class="px-4 py-2 rounded-t-lg whitespace-nowrap ${adminTab === 'users' ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            <i class="fas fa-users mr-2"></i>Users
                        </button>
                    </div>
                    
                    <!-- Admin Tab Content -->
                    <div id="adminTabContent">
                        ${adminTab === 'tasks' ? renderAdminTasks(allTasks) : ''}
                        ${adminTab === 'submissions' ? renderAdminSubmissions(allSubmissions) : ''}
                        ${adminTab === 'withdrawals' ? renderAdminWithdrawals(allWithdrawals) : ''}
                        ${adminTab === 'users' ? renderAdminUsers(allUsers) : ''}
                    </div>
                </div>
                
                ${renderTaskModal()}
                ${renderUserProfileModal()}
            `;
        }
        
        function renderUserProfileModal() {
            return `
                <div id="userProfileModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop flex items-center justify-center z-50 px-4 overflow-y-auto py-8">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold"><i class="fas fa-user-circle text-purple-400 mr-2"></i>User Profile</h3>
                            <button onclick="closeUserProfileModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div id="userProfileContent">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-400 mt-2">Loading user profile...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminTasks(tasks) {
            return `
                <div class="mb-4">
                    <button onclick="openTaskModal()"
                        class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition">
                        <i class="fas fa-plus mr-2"></i>Create New Task
                    </button>
                </div>
                
                ${tasks.length === 0 ? `
                    <div class="text-center py-16 bg-gray-800 rounded-xl border border-gray-700">
                        <i class="fas fa-tasks text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-xl">No tasks created yet</p>
                    </div>
                ` : `
                    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm">Task ID</th>
                                    <th class="px-4 py-3 text-left text-sm">Type</th>
                                    <th class="px-4 py-3 text-left text-sm">Details</th>
                                    <th class="px-4 py-3 text-left text-sm">Price</th>
                                    <th class="px-4 py-3 text-left text-sm">Status</th>
                                    <th class="px-4 py-3 text-right text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tasks.map(task => {
                                    const statusColors = {
                                        available: 'bg-green-600',
                                        reserved: 'bg-yellow-600',
                                        submitted: 'bg-blue-600',
                                        approved: 'bg-purple-600',
                                        rejected: 'bg-red-600'
                                    };
                                    return `
                                        <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                                            <td class="px-4 py-3 text-sm font-mono">${task.taskId}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 ${task.type === 'post' ? 'bg-blue-600' : 'bg-purple-600'} rounded text-xs capitalize">
                                                    ${task.type}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-gray-400 max-w-xs truncate">
                                                ${task.type === 'post' ? task.title : (task.commentText || '').substring(0, 50) + '...'}
                                            </td>
                                            <td class="px-4 py-3 font-semibold text-green-400">$${task.price.toFixed(2)}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 ${statusColors[task.status]} rounded-full text-xs capitalize">
                                                    ${task.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-right">
                                                ${task.status === 'available' ? `
                                                    <button onclick="editTask('${task.taskId}')" class="text-blue-400 hover:text-blue-300 mr-3">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteTask('${task.taskId}')" class="text-red-400 hover:text-red-300">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                ` : '<span class="text-gray-500 text-sm">Locked</span>'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }

        function renderAdminSubmissions(submissions) {
            const pendingSubmissions = submissions.filter(s => s.status === 'pending');
            const processedSubmissions = submissions.filter(s => s.status !== 'pending');
            
            return `
                <div class="space-y-6">
                    ${pendingSubmissions.length > 0 ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-hourglass-half text-yellow-400 mr-2"></i>
                                Pending Reviews (${pendingSubmissions.length})
                            </h3>
                            <div class="grid gap-4">
                                ${pendingSubmissions.map(sub => `
                                    <div class="bg-gray-800 rounded-xl p-5 border border-yellow-600">
                                        <div class="flex items-start justify-between mb-4">
                                            <div>
                                                <p class="font-mono text-sm text-gray-400">${sub.taskId}</p>
                                                <p class="font-semibold flex items-center">
                                                    By: ${sub.user?.username || 'Unknown'}
                                                    ${sub.user?.authProvider === 'google' ? '<i class="fab fa-google text-xs text-blue-400 ml-2"></i>' : ''}
                                                </p>
                                            </div>
                                            <span class="text-green-400 font-bold">$${sub.task?.price?.toFixed(2) || '0.00'}</span>
                                        </div>
                                        
                                        <div class="bg-gray-700 rounded-lg p-3 mb-4">
                                            <p class="text-sm text-gray-400 mb-1">Task: ${sub.task?.type === 'post' ? sub.task.title : 'Comment Task'}</p>
                                            <p class="text-sm"><strong>Submitted Link:</strong></p>
                                            <a href="${sub.redditLink}" target="_blank" class="text-blue-400 hover:underline break-all">
                                                ${sub.redditLink}
                                            </a>
                                        </div>
                                        
                                        <div class="flex space-x-3">
                                            <button onclick="approveSubmission('${sub.id}')"
                                                class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold transition">
                                                <i class="fas fa-check mr-2"></i>Approve (+$${sub.task?.price?.toFixed(2) || '0'})
                                            </button>
                                            <button onclick="rejectSubmission('${sub.id}')"
                                                class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg font-semibold transition">
                                                <i class="fas fa-times mr-2"></i>Reject
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-8 bg-gray-800 rounded-xl border border-gray-700">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-2"></i>
                            <p class="text-gray-400">No pending submissions to review</p>
                        </div>
                    `}
                    
                    ${processedSubmissions.length > 0 ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Processed Submissions</h3>
                            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm">Task ID</th>
                                            <th class="px-4 py-3 text-left text-sm">User</th>
                                            <th class="px-4 py-3 text-left text-sm">Status</th>
                                            <th class="px-4 py-3 text-left text-sm">Processed</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${processedSubmissions.map(sub => `
                                            <tr class="border-t border-gray-700">
                                                <td class="px-4 py-3 font-mono text-sm">${sub.taskId}</td>
                                                <td class="px-4 py-3">
                                                    ${sub.user?.username || 'Unknown'}
                                                    ${sub.user?.authProvider === 'google' ? '<i class="fab fa-google text-xs text-blue-400 ml-1"></i>' : ''}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 ${sub.status === 'approved' ? 'bg-green-600' : 'bg-red-600'} rounded-full text-xs capitalize">
                                                        ${sub.status}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-400">${formatDate(sub.submittedAt)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAdminWithdrawals(withdrawals) {
            const pendingWithdrawals = withdrawals.filter(w => w.status === 'pending');
            const processedWithdrawals = withdrawals.filter(w => w.status !== 'pending');
            
            return `
                <div class="space-y-6">
                    ${pendingWithdrawals.length > 0 ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-money-bill-wave text-yellow-400 mr-2"></i>
                                Pending Withdrawals (${pendingWithdrawals.length})
                            </h3>
                            <div class="grid gap-4">
                                ${pendingWithdrawals.map(wd => `
                                    <div class="bg-gray-800 rounded-xl p-5 border border-yellow-600">
                                        <div class="flex items-start justify-between mb-4">
                                            <div>
                                                <p class="font-mono text-sm text-gray-400">${wd.id}</p>
                                                <p class="font-semibold">${wd.username}</p>
                                            </div>
                                            <span class="text-green-400 font-bold text-xl">$${wd.amount.toFixed(2)}</span>
                                        </div>
                                        
                                        <div class="bg-gray-700 rounded-lg p-4 mb-4">
                                            <div class="flex items-center mb-2">
                                                ${wd.method === 'binance' 
                                                    ? '<span class="binance-gradient text-gray-900 px-3 py-1 rounded-full text-sm font-semibold"><i class="fab fa-bitcoin mr-1"></i>Binance</span>'
                                                    : '<span class="upi-gradient text-white px-3 py-1 rounded-full text-sm font-semibold"><i class="fas fa-mobile-alt mr-1"></i>UPI</span>'
                                                }
                                            </div>
                                            <p class="text-sm text-gray-300 mt-2">
                                                <strong>${wd.method === 'binance' ? 'Pay ID / Address:' : 'UPI ID:'}</strong>
                                            </p>
                                            <p class="font-mono text-white bg-gray-600 px-3 py-2 rounded mt-1 break-all">${wd.details}</p>
                                        </div>
                                        
                                        <div class="flex space-x-3">
                                            <button onclick="approveWithdrawal('${wd.id}')"
                                                class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold transition">
                                                <i class="fas fa-check mr-2"></i>Mark as Paid
                                            </button>
                                            <button onclick="rejectWithdrawal('${wd.id}')"
                                                class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg font-semibold transition">
                                                <i class="fas fa-times mr-2"></i>Reject
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-8 bg-gray-800 rounded-xl border border-gray-700">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-2"></i>
                            <p class="text-gray-400">No pending withdrawal requests</p>
                        </div>
                    `}
                    
                    ${processedWithdrawals.length > 0 ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Processed Withdrawals</h3>
                            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm">ID</th>
                                            <th class="px-4 py-3 text-left text-sm">User</th>
                                            <th class="px-4 py-3 text-left text-sm">Amount</th>
                                            <th class="px-4 py-3 text-left text-sm">Method</th>
                                            <th class="px-4 py-3 text-left text-sm">Status</th>
                                            <th class="px-4 py-3 text-left text-sm">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${processedWithdrawals.map(wd => `
                                            <tr class="border-t border-gray-700">
                                                <td class="px-4 py-3 font-mono text-sm">${wd.id}</td>
                                                <td class="px-4 py-3">${wd.username}</td>
                                                <td class="px-4 py-3 font-semibold text-green-400">$${wd.amount.toFixed(2)}</td>
                                                <td class="px-4 py-3">
                                                    ${wd.method === 'binance' 
                                                        ? '<span class="text-yellow-400"><i class="fab fa-bitcoin mr-1"></i>Binance</span>'
                                                        : '<span class="text-purple-400"><i class="fas fa-mobile-alt mr-1"></i>UPI</span>'
                                                    }
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 ${wd.status === 'approved' ? 'bg-green-600' : 'bg-red-600'} rounded-full text-xs capitalize">
                                                        ${wd.status === 'approved' ? 'Paid' : 'Rejected'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-400">${formatDate(wd.processedAt || wd.createdAt)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAdminUsers(users) {
            return `
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm">Username</th>
                                <th class="px-4 py-3 text-left text-sm">Reddit Profile</th>
                                <th class="px-4 py-3 text-left text-sm">Auth</th>
                                <th class="px-4 py-3 text-left text-sm">Karma</th>
                                <th class="px-4 py-3 text-left text-sm">Age</th>
                                <th class="px-4 py-3 text-left text-sm">Status</th>
                                <th class="px-4 py-3 text-right text-sm">Balance</th>
                                <th class="px-4 py-3 text-center text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.length === 0 ? `
                                <tr>
                                    <td colspan="8" class="px-4 py-8 text-center text-gray-400">No users registered yet</td>
                                </tr>
                            ` : users.map(user => {
                                const eligible = (user.redditKarma || 0) >= 200 && (user.accountAge || 0) >= 1;
                                const isBanned = user.banned || false;
                                return `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700/50 ${isBanned ? 'bg-red-900/20' : ''}">
                                        <td class="px-4 py-3">
                                            <div class="flex items-center space-x-2">
                                                ${user.photoURL 
                                                    ? `<img src="${user.photoURL}" class="w-6 h-6 rounded-full">`
                                                    : `<i class="fas fa-user text-gray-400"></i>`
                                                }
                                                <span class="font-semibold">${user.username}</span>
                                                ${isBanned ? '<span class="bg-red-600 text-xs px-1 rounded">BANNED</span>' : ''}
                                            </div>
                                        </td>
                                        <td class="px-4 py-3">
                                            ${user.redditProfileLink 
                                                ? `<a href="${user.redditProfileLink}" target="_blank" class="text-orange-400 hover:underline text-sm">
                                                    <i class="fab fa-reddit mr-1"></i>View
                                                   </a>`
                                                : '<span class="text-gray-500 text-sm">-</span>'
                                            }
                                        </td>
                                        <td class="px-4 py-3">
                                            ${user.authProvider === 'google' 
                                                ? '<i class="fab fa-google text-blue-400"></i>'
                                                : '<i class="fas fa-key text-gray-400"></i>'
                                            }
                                        </td>
                                        <td class="px-4 py-3 ${(user.redditKarma || 0) >= 200 ? 'text-green-400' : 'text-red-400'}">
                                            ${user.redditKarma || 0}
                                        </td>
                                        <td class="px-4 py-3 ${(user.accountAge || 0) >= 1 ? 'text-green-400' : 'text-red-400'}">
                                            ${user.accountAge || 0}m
                                        </td>
                                        <td class="px-4 py-3">
                                            ${eligible 
                                                ? '<span class="text-green-400"><i class="fas fa-check-circle"></i></span>'
                                                : '<span class="text-red-400"><i class="fas fa-times-circle"></i></span>'}
                                        </td>
                                        <td class="px-4 py-3 text-right font-semibold text-green-400">$${(user.walletBalance || 0).toFixed(2)}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick="viewUserProfile('${user.id}')" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition">
                                                <i class="fas fa-eye mr-1"></i>Profile
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTaskModal() {
            return `
                <div id="taskModal" class="hidden fixed inset-0 bg-black/70 modal-backdrop flex items-center justify-center z-50 px-4">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-lg w-full border border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold" id="taskModalTitle">Create New Task</h3>
                            <button onclick="closeTaskModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <input type="hidden" id="editingTaskId">
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Task Type</label>
                                <select id="taskType" onchange="toggleTaskFields()"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                    <option value="post">Post Task</option>
                                    <option value="comment">Comment Task</option>
                                </select>
                            </div>
                            
                            <div id="postFields">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Post Title</label>
                                        <input type="text" id="taskTitle"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                            placeholder="Enter post title">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Post Body</label>
                                        <textarea id="taskBody" rows="3"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                            placeholder="Enter post body content"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Image URL (optional)</label>
                                        <input type="url" id="taskImage"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                            placeholder="https://example.com/image.jpg">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="commentFields" class="hidden">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Reddit Post Link</label>
                                        <input type="url" id="taskPostLink"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                            placeholder="https://reddit.com/r/...">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Exact Comment Text</label>
                                        <textarea id="taskCommentText" rows="3"
                                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                            placeholder="Enter the exact comment to post"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Price ($)</label>
                                <input type="number" id="taskPrice" step="0.01" min="0.01"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                                    placeholder="e.g. 5.00">
                            </div>
                            
                            <div id="taskError" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg text-sm"></div>
                            
                            <button onclick="saveTask()"
                                class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-save mr-2"></i><span id="taskModalBtn">Create Task</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        let timerInterval = null;
        let selectedWithdrawMethod = null;
        
        // Copy to clipboard function
        window.copyToClipboard = async function(text, buttonEl) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Show success feedback
                const icon = buttonEl.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check text-green-400';
                buttonEl.classList.add('bg-green-600');
                buttonEl.classList.remove('bg-gray-600');
                
                // Show toast notification
                showCopyToast('Copied to clipboard!');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    icon.className = originalClass;
                    buttonEl.classList.remove('bg-green-600');
                    buttonEl.classList.add('bg-gray-600');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                showCopyToast('Copied to clipboard!');
            }
        };
        
        function showCopyToast(message) {
            // Remove existing toast
            const existingToast = document.getElementById('copyToast');
            if (existingToast) existingToast.remove();
            
            // Create toast
            const toast = document.createElement('div');
            toast.id = 'copyToast';
            toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-[200] flex items-center space-x-2 animate-fade-in';
            toast.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            document.body.appendChild(toast);
            
            // Remove after 2 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        function attachEventListeners() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(async () => {
                if (Auth.currentUser && Auth.currentUser.role !== 'admin') {
                    const myReservedTasks = await TaskManager.getMyReservedTasks(Auth.currentUser.id);
                    myReservedTasks.forEach(task => {
                        const timerEl = document.getElementById(`timer-${task.taskId}`);
                        if (timerEl) {
                            const remaining = TaskManager.getRemainingTime(task);
                            timerEl.textContent = formatTime(remaining);
                            if (remaining === 0) {
                                render();
                            }
                        }
                    });
                }
            }, 1000);
        }

        // Auth handlers
        window.switchAuthTab = function(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginTab.className = 'flex-1 py-2 text-center border-b-2 border-orange-500 text-orange-500 font-semibold';
                registerTab.className = 'flex-1 py-2 text-center border-b-2 border-gray-600 text-gray-400 hover:text-white';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerTab.className = 'flex-1 py-2 text-center border-b-2 border-orange-500 text-orange-500 font-semibold';
                loginTab.className = 'flex-1 py-2 text-center border-b-2 border-gray-600 text-gray-400 hover:text-white';
            }
        };

        window.handleLogin = async function() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('authError');
            
            const result = await Auth.login(username, password);
            if (result.success) {
                render();
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
            }
        };

        window.handleGoogleLogin = async function() {
            const errorEl = document.getElementById('authError');
            errorEl.classList.add('hidden');
            
            const result = await Auth.loginWithGoogle();
            
            if (result.success) {
                render();
            } else {
                errorEl.innerHTML = '<strong>Error:</strong> ' + result.error;
                errorEl.classList.remove('hidden');
            }
        };

        window.handleRegister = async function() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const redditProfile = document.getElementById('regRedditProfile').value;
            const karma = document.getElementById('regKarma').value;
            const age = document.getElementById('regAge').value;
            const errorEl = document.getElementById('authError');
            
            if (!username || !password || !redditProfile || !karma || !age) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.classList.remove('hidden');
                return;
            }
            
            const result = await Auth.register(username, password, redditProfile, karma, age);
            if (result.success) {
                render();
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
            }
        };

        window.saveRedditInfo = async function() {
            const redditProfileLink = document.getElementById('redditProfileLink').value;
            const karma = document.getElementById('redditKarma').value;
            const age = document.getElementById('redditAge').value;
            const errorEl = document.getElementById('redditInfoError');
            
            if (!redditProfileLink || !karma || !age) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.classList.remove('hidden');
                return;
            }
            
            const result = await Auth.updateRedditInfo(redditProfileLink, karma, age);
            if (result.success) {
                render();
            } else {
                errorEl.textContent = result.error || 'Failed to update Reddit info';
                errorEl.classList.remove('hidden');
            }
        };

        window.handleLogout = function() {
            Auth.logout();
            render();
        };

        // Tab handlers
        window.switchUserTab = function(tab) {
            activeTab = tab;
            render();
        };

        window.switchAdminTab = function(tab) {
            adminTab = tab;
            render();
        };

        // Task handlers
        window.acceptTask = async function(taskId) {
            showLoading('Accepting task...');
            const result = await TaskManager.acceptTask(taskId, Auth.currentUser.id);
            hideLoading();
            
            if (result.success) {
                activeTab = 'active';
                render();
            } else {
                alert(result.error);
            }
        };

        window.openSubmitModal = function(taskId) {
            document.getElementById('submitTaskId').value = taskId;
            document.getElementById('redditLink').value = '';
            document.getElementById('submitError').classList.add('hidden');
            document.getElementById('submitModal').classList.remove('hidden');
        };

        window.closeSubmitModal = function() {
            document.getElementById('submitModal').classList.add('hidden');
        };

        window.submitTask = async function() {
            const taskId = document.getElementById('submitTaskId').value;
            const redditLink = document.getElementById('redditLink').value;
            const errorEl = document.getElementById('submitError');
            
            if (!redditLink) {
                errorEl.textContent = 'Please enter a Reddit link';
                errorEl.classList.remove('hidden');
                return;
            }
            
            showLoading('Submitting task...');
            const result = await TaskManager.submitTask(taskId, Auth.currentUser.id, redditLink);
            hideLoading();
            
            if (result.success) {
                closeSubmitModal();
                activeTab = 'history';
                render();
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
            }
        };

        // Wallet handlers
        window.openWalletModal = function() {
            selectedWithdrawMethod = null;
            render().then(() => {
                document.getElementById('walletModal').classList.remove('hidden');
            });
        };

        window.closeWalletModal = function() {
            document.getElementById('walletModal').classList.add('hidden');
        };

        window.selectWithdrawMethod = function(method) {
            selectedWithdrawMethod = method;
            
            document.getElementById('methodBinance').classList.remove('border-yellow-500');
            document.getElementById('methodUpi').classList.remove('border-purple-500');
            document.getElementById('binanceDetails').classList.add('hidden');
            document.getElementById('upiDetails').classList.add('hidden');
            
            if (method === 'binance') {
                document.getElementById('methodBinance').classList.add('border-yellow-500');
                document.getElementById('binanceDetails').classList.remove('hidden');
            } else {
                document.getElementById('methodUpi').classList.add('border-purple-500');
                document.getElementById('upiDetails').classList.remove('hidden');
            }
            
            const btn = document.getElementById('withdrawBtn');
            btn.disabled = false;
            btn.className = 'w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold transition cursor-pointer';
            btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Request Withdrawal';
        };

        window.requestWithdrawal = async function() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const errorEl = document.getElementById('withdrawError');
            
            let details = '';
            if (selectedWithdrawMethod === 'binance') {
                details = document.getElementById('binanceId').value;
            } else {
                details = document.getElementById('upiId').value;
            }
            
            if (!details) {
                errorEl.textContent = 'Please enter your ' + (selectedWithdrawMethod === 'binance' ? 'Binance Pay ID or address' : 'UPI ID');
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (amount < 2) {
                errorEl.textContent = 'Minimum withdrawal is $2.00';
                errorEl.classList.remove('hidden');
                return;
            }
            
            showLoading('Processing withdrawal request...');
            const result = await WithdrawalManager.createWithdrawal(
                Auth.currentUser.id,
                amount,
                selectedWithdrawMethod,
                details
            );
            hideLoading();
            
            if (result.success) {
                closeWalletModal();
                activeTab = 'withdrawals';
                render();
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
            }
        };

        // Admin handlers
        window.openTaskModal = async function(taskId = null) {
            let task = null;
            if (taskId) {
                task = await FirestoreDB.getTask(taskId);
            }
            
            document.getElementById('editingTaskId').value = task?.taskId || '';
            document.getElementById('taskModalTitle').textContent = task ? 'Edit Task' : 'Create New Task';
            document.getElementById('taskModalBtn').textContent = task ? 'Update Task' : 'Create Task';
            
            if (task) {
                document.getElementById('taskType').value = task.type;
                document.getElementById('taskTitle').value = task.title || '';
                document.getElementById('taskBody').value = task.body || '';
                document.getElementById('taskImage').value = task.image || '';
                document.getElementById('taskPostLink').value = task.postLink || '';
                document.getElementById('taskCommentText').value = task.commentText || '';
                document.getElementById('taskPrice').value = task.price;
            } else {
                document.getElementById('taskType').value = 'post';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskBody').value = '';
                document.getElementById('taskImage').value = '';
                document.getElementById('taskPostLink').value = '';
                document.getElementById('taskCommentText').value = '';
                document.getElementById('taskPrice').value = '';
            }
            
            toggleTaskFields();
            document.getElementById('taskError').classList.add('hidden');
            document.getElementById('taskModal').classList.remove('hidden');
        };

        window.closeTaskModal = function() {
            document.getElementById('taskModal').classList.add('hidden');
        };

        window.toggleTaskFields = function() {
            const type = document.getElementById('taskType').value;
            document.getElementById('postFields').classList.toggle('hidden', type !== 'post');
            document.getElementById('commentFields').classList.toggle('hidden', type !== 'comment');
        };

        window.saveTask = async function() {
            const editingId = document.getElementById('editingTaskId').value;
            const type = document.getElementById('taskType').value;
            const price = document.getElementById('taskPrice').value;
            const errorEl = document.getElementById('taskError');
            
            let taskData = { type, price: parseFloat(price) };
            
            if (type === 'post') {
                taskData.title = document.getElementById('taskTitle').value;
                taskData.body = document.getElementById('taskBody').value;
                taskData.image = document.getElementById('taskImage').value;
                
                if (!taskData.title || !taskData.body) {
                    errorEl.textContent = 'Please fill in title and body';
                    errorEl.classList.remove('hidden');
                    return;
                }
            } else {
                taskData.postLink = document.getElementById('taskPostLink').value;
                taskData.commentText = document.getElementById('taskCommentText').value;
                
                if (!taskData.postLink || !taskData.commentText) {
                    errorEl.textContent = 'Please fill in post link and comment text';
                    errorEl.classList.remove('hidden');
                    return;
                }
            }
            
            if (!price || parseFloat(price) <= 0) {
                errorEl.textContent = 'Please enter a valid price';
                errorEl.classList.remove('hidden');
                return;
            }
            
            showLoading(editingId ? 'Updating task...' : 'Creating task...');
            
            let result;
            if (editingId) {
                result = await TaskManager.updateTask(editingId, taskData);
            } else {
                result = await TaskManager.createTask(taskData);
            }
            
            hideLoading();
            
            if (!result.success) {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
                return;
            }
            
            closeTaskModal();
            render();
        };

        window.editTask = function(taskId) {
            openTaskModal(taskId);
        };

        window.deleteTask = async function(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                showLoading('Deleting task...');
                const result = await TaskManager.deleteTask(taskId);
                hideLoading();
                
                if (result.success) {
                    render();
                } else {
                    alert(result.error);
                }
            }
        };

        window.approveSubmission = async function(submissionId) {
            showLoading('Approving submission...');
            const result = await AdminManager.approveSubmission(submissionId);
            hideLoading();
            
            if (result.success) {
                render();
            } else {
                alert(result.error);
            }
        };

        window.rejectSubmission = async function(submissionId) {
            if (confirm('Are you sure you want to reject this submission?')) {
                showLoading('Rejecting submission...');
                const result = await AdminManager.rejectSubmission(submissionId);
                hideLoading();
                
                if (result.success) {
                    render();
                } else {
                    alert(result.error);
                }
            }
        };

        window.approveWithdrawal = async function(withdrawalId) {
            if (confirm('Confirm that you have sent the payment?')) {
                showLoading('Processing...');
                const result = await WithdrawalManager.approveWithdrawal(withdrawalId);
                hideLoading();
                
                if (result.success) {
                    render();
                } else {
                    alert(result.error);
                }
            }
        };

        window.rejectWithdrawal = async function(withdrawalId) {
            if (confirm('Are you sure you want to reject this withdrawal?')) {
                showLoading('Processing...');
                const result = await WithdrawalManager.rejectWithdrawal(withdrawalId);
                hideLoading();
                
                if (result.success) {
                    render();
                } else {
                    alert(result.error);
                }
            }
        };

        // ============================================
        // ADMIN SEARCH FUNCTIONALITY
        // ============================================
        window.handleAdminSearch = async function() {
            const searchInput = document.getElementById('adminSearchInput').value.trim().toLowerCase();
            const statusFilter = document.getElementById('adminStatusFilter').value;
            const resultsDiv = document.getElementById('adminSearchResults');
            
            if (!searchInput && statusFilter === 'all') {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div></div>';
            
            const allTasks = await FirestoreDB.getAllTasks();
            const allSubmissions = await FirestoreDB.getAllSubmissions();
            const allUsers = await FirestoreDB.getAllUsers();
            
            let filteredTasks = allTasks;
            let filteredUsers = allUsers;
            
            // Filter by search term
            if (searchInput) {
                filteredTasks = allTasks.filter(t => 
                    t.taskId.toLowerCase().includes(searchInput) ||
                    (t.title && t.title.toLowerCase().includes(searchInput))
                );
                filteredUsers = allUsers.filter(u => 
                    u.username.toLowerCase().includes(searchInput) ||
                    u.id.toLowerCase().includes(searchInput) ||
                    (u.email && u.email.toLowerCase().includes(searchInput))
                );
            }
            
            // Filter by status
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(t => t.status === statusFilter);
            }
            
            let html = '<div class="space-y-4">';
            
            // Show matching users
            if (filteredUsers.length > 0 && searchInput) {
                html += '<div class="mb-4"><h4 class="text-sm font-semibold text-purple-400 mb-2"><i class="fas fa-users mr-2"></i>Users Found (${filteredUsers.length})</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">';
                filteredUsers.slice(0, 6).forEach(user => {
                    html += `
                        <div class="bg-gray-700 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                ${user.photoURL ? `<img src="${user.photoURL}" class="w-8 h-8 rounded-full">` : '<i class="fas fa-user-circle text-2xl text-gray-400"></i>'}
                                <div>
                                    <p class="font-semibold">${user.username}</p>
                                    <p class="text-xs text-gray-400">${user.id}</p>
                                </div>
                            </div>
                            <button onclick="viewUserProfile('${user.id}')" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // Show matching tasks
            if (filteredTasks.length > 0) {
                html += '<div><h4 class="text-sm font-semibold text-blue-400 mb-2"><i class="fas fa-tasks mr-2"></i>Tasks Found (' + filteredTasks.length + ')</h4>';
                html += '<div class="bg-gray-700 rounded-lg overflow-hidden"><table class="w-full"><thead class="bg-gray-600"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs">Task ID</th>';
                html += '<th class="px-4 py-2 text-left text-xs">Type</th>';
                html += '<th class="px-4 py-2 text-left text-xs">Price</th>';
                html += '<th class="px-4 py-2 text-left text-xs">Status</th>';
                html += '<th class="px-4 py-2 text-left text-xs">Reserved By</th>';
                html += '</tr></thead><tbody>';
                
                filteredTasks.slice(0, 10).forEach(task => {
                    const statusColors = {
                        available: 'bg-green-600',
                        reserved: 'bg-yellow-600',
                        submitted: 'bg-blue-600',
                        approved: 'bg-purple-600',
                        rejected: 'bg-red-600'
                    };
                    const reservedUser = task.reservedBy ? allUsers.find(u => u.id === task.reservedBy) : null;
                    html += `<tr class="border-t border-gray-600">
                        <td class="px-4 py-2 font-mono text-sm">${task.taskId}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 ${task.type === 'post' ? 'bg-blue-600' : 'bg-purple-600'} rounded text-xs">${task.type}</span></td>
                        <td class="px-4 py-2 text-green-400">$${task.price.toFixed(2)}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 ${statusColors[task.status]} rounded-full text-xs capitalize">${task.status}</span></td>
                        <td class="px-4 py-2 text-sm">${reservedUser ? `<a href="#" onclick="viewUserProfile('${reservedUser.id}')" class="text-blue-400 hover:underline">${reservedUser.username}</a>` : '-'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            if (filteredTasks.length === 0 && filteredUsers.length === 0) {
                html = '<div class="text-center py-8 text-gray-400"><i class="fas fa-search text-4xl mb-2"></i><p>No results found</p></div>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        };

        window.clearAdminSearch = function() {
            document.getElementById('adminSearchInput').value = '';
            document.getElementById('adminStatusFilter').value = 'all';
            document.getElementById('adminSearchResults').classList.add('hidden');
        };

        // ============================================
        // USER SEARCH FUNCTIONALITY
        // ============================================
        window.handleUserSearch = async function() {
            const searchInput = document.getElementById('userSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('userSearchResults');
            
            if (!searchInput) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = '<div class="text-center py-4"><div class="loading-spinner mx-auto"></div></div>';
            
            const availableTasks = await TaskManager.getAvailableTasks();
            const mySubmissions = await FirestoreDB.getUserSubmissions(Auth.currentUser.id);
            const allTasks = await FirestoreDB.getAllTasks();
            
            // Search in available tasks
            const matchingAvailable = availableTasks.filter(t => 
                t.taskId.toLowerCase().includes(searchInput)
            );
            
            // Search in my submissions
            const matchingSubmissions = mySubmissions.filter(s => 
                s.taskId.toLowerCase().includes(searchInput)
            );
            
            let html = '<div class="space-y-4">';
            
            if (matchingAvailable.length > 0) {
                html += '<div><h4 class="text-sm font-semibold text-green-400 mb-2"><i class="fas fa-check-circle mr-2"></i>Available Tasks (' + matchingAvailable.length + ')</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">';
                matchingAvailable.forEach(task => {
                    html += `
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-mono text-sm">#${task.taskId}</span>
                                <span class="text-green-400 font-bold">$${task.price.toFixed(2)}</span>
                            </div>
                            <p class="text-sm text-gray-300 mb-2">${task.type === 'post' ? task.title : 'Comment Task'}</p>
                            <span class="px-2 py-1 ${task.type === 'post' ? 'bg-blue-600' : 'bg-purple-600'} rounded text-xs">${task.type}</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            if (matchingSubmissions.length > 0) {
                html += '<div><h4 class="text-sm font-semibold text-yellow-400 mb-2"><i class="fas fa-file-alt mr-2"></i>My Submissions (' + matchingSubmissions.length + ')</h4>';
                html += '<div class="bg-gray-700 rounded-lg overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-600"><tr>';
                html += '<th class="px-3 py-2 text-left">Task ID</th>';
                html += '<th class="px-3 py-2 text-left">Link</th>';
                html += '<th class="px-3 py-2 text-left">Status</th>';
                html += '</tr></thead><tbody>';
                
                matchingSubmissions.forEach(sub => {
                    const statusColors = { pending: 'bg-yellow-600', approved: 'bg-green-600', rejected: 'bg-red-600' };
                    html += `<tr class="border-t border-gray-600">
                        <td class="px-3 py-2 font-mono">${sub.taskId}</td>
                        <td class="px-3 py-2"><a href="${sub.redditLink}" target="_blank" class="text-blue-400 hover:underline">${sub.redditLink.substring(0, 30)}...</a></td>
                        <td class="px-3 py-2"><span class="px-2 py-1 ${statusColors[sub.status]} rounded-full text-xs capitalize">${sub.status}</span></td>
                    </tr>`;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            if (matchingAvailable.length === 0 && matchingSubmissions.length === 0) {
                html = '<div class="text-center py-8 text-gray-400"><i class="fas fa-search text-4xl mb-2"></i><p>No tasks found matching "' + searchInput + '"</p></div>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        };

        window.clearUserSearch = function() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').classList.add('hidden');
        };

        // ============================================
        // USER PROFILE MODAL (ADMIN VIEW)
        // ============================================
        window.viewUserProfile = async function(userId) {
            document.getElementById('userProfileModal').classList.remove('hidden');
            const contentDiv = document.getElementById('userProfileContent');
            contentDiv.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="text-gray-400 mt-2">Loading user profile...</p></div>';
            
            const user = await FirestoreDB.getUser(userId);
            if (!user) {
                contentDiv.innerHTML = '<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-circle text-4xl mb-2"></i><p>User not found</p></div>';
                return;
            }
            
            const allTasks = await FirestoreDB.getAllTasks();
            const userSubmissions = await FirestoreDB.getUserSubmissions(userId);
            const userWithdrawals = await WithdrawalManager.getUserWithdrawals(userId);
            
            const userReservedTasks = allTasks.filter(t => t.reservedBy === userId);
            const approvedSubmissions = userSubmissions.filter(s => s.status === 'approved');
            const rejectedSubmissions = userSubmissions.filter(s => s.status === 'rejected');
            const pendingSubmissions = userSubmissions.filter(s => s.status === 'pending');
            
            const eligible = (user.redditKarma || 0) >= 200 && (user.accountAge || 0) >= 1;
            const isBanned = user.banned || false;
            
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <!-- User Header -->
                    <div class="bg-gradient-to-r ${isBanned ? 'from-red-900 to-red-800' : 'from-gray-700 to-gray-600'} rounded-xl p-6">
                        <div class="flex items-start justify-between flex-wrap gap-4">
                            <div class="flex items-center space-x-4">
                                ${user.photoURL 
                                    ? `<img src="${user.photoURL}" alt="Profile" class="w-16 h-16 rounded-full border-4 ${isBanned ? 'border-red-500' : 'border-purple-500'}">`
                                    : `<div class="w-16 h-16 rounded-full ${isBanned ? 'bg-red-700' : 'bg-gray-600'} flex items-center justify-center"><i class="fas fa-user text-3xl text-gray-400"></i></div>`
                                }
                                <div>
                                    <h3 class="text-2xl font-bold flex items-center">
                                        ${user.username}
                                        ${user.authProvider === 'google' ? '<i class="fab fa-google text-blue-400 ml-2 text-sm"></i>' : ''}
                                        ${isBanned ? '<span class="ml-2 bg-red-600 text-xs px-2 py-1 rounded-full">BANNED</span>' : ''}
                                    </h3>
                                    <p class="text-gray-300 text-sm">${user.email || 'No email'}</p>
                                    <p class="text-gray-400 text-xs mt-1">ID: ${user.id}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${isBanned 
                                    ? `<button onclick="unbanUser('${user.id}')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition"><i class="fas fa-unlock mr-2"></i>Unban User</button>`
                                    : `<button onclick="banUser('${user.id}')" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold transition"><i class="fas fa-ban mr-2"></i>Ban User</button>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-700 rounded-xl p-4 text-center">
                            <i class="fas fa-wallet text-green-400 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold text-green-400">$${(user.walletBalance || 0).toFixed(2)}</p>
                            <p class="text-xs text-gray-400">Wallet Balance</p>
                        </div>
                        <div class="bg-gray-700 rounded-xl p-4 text-center">
                            <i class="fas fa-check-circle text-purple-400 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold">${approvedSubmissions.length}</p>
                            <p class="text-xs text-gray-400">Approved Tasks</p>
                        </div>
                        <div class="bg-gray-700 rounded-xl p-4 text-center">
                            <i class="fas fa-times-circle text-red-400 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold">${rejectedSubmissions.length}</p>
                            <p class="text-xs text-gray-400">Rejected Tasks</p>
                        </div>
                        <div class="bg-gray-700 rounded-xl p-4 text-center">
                            <i class="fas fa-clock text-yellow-400 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold">${pendingSubmissions.length}</p>
                            <p class="text-xs text-gray-400">Pending Tasks</p>
                        </div>
                    </div>
                    
                    <!-- User Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Reddit Info -->
                        <div class="bg-gray-700 rounded-xl p-4">
                            <h4 class="font-semibold mb-3 flex items-center"><i class="fab fa-reddit text-orange-500 mr-2"></i>Reddit Info</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Profile Link:</span>
                                    <a href="${user.redditProfileLink || '#'}" target="_blank" class="text-orange-400 hover:underline">
                                        ${user.redditProfileLink ? 'View Profile' : 'Not provided'}
                                    </a>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Karma:</span>
                                    <span class="${(user.redditKarma || 0) >= 200 ? 'text-green-400' : 'text-red-400'}">${user.redditKarma || 0}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Account Age:</span>
                                    <span class="${(user.accountAge || 0) >= 1 ? 'text-green-400' : 'text-red-400'}">${user.accountAge || 0} months</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Eligible:</span>
                                    <span class="${eligible ? 'text-green-400' : 'text-red-400'}">${eligible ? 'Yes' : 'No'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Info -->
                        <div class="bg-gray-700 rounded-xl p-4">
                            <h4 class="font-semibold mb-3 flex items-center"><i class="fas fa-info-circle text-blue-400 mr-2"></i>Account Info</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Auth Provider:</span>
                                    <span>${user.authProvider === 'google' ? '<i class="fab fa-google text-blue-400 mr-1"></i>Google' : '<i class="fas fa-key text-gray-400 mr-1"></i>Local'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Submissions:</span>
                                    <span>${userSubmissions.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Withdrawals:</span>
                                    <span>${userWithdrawals.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Status:</span>
                                    <span class="${isBanned ? 'text-red-400' : 'text-green-400'}">${isBanned ? 'Banned' : 'Active'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Submissions -->
                    <div class="bg-gray-700 rounded-xl p-4">
                        <h4 class="font-semibold mb-3 flex items-center"><i class="fas fa-file-alt text-yellow-400 mr-2"></i>Submissions (${userSubmissions.length})</h4>
                        ${userSubmissions.length === 0 ? `
                            <p class="text-center text-gray-400 py-4">No submissions yet</p>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-600">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Task ID</th>
                                            <th class="px-3 py-2 text-left">Reddit Link</th>
                                            <th class="px-3 py-2 text-left">Status</th>
                                            <th class="px-3 py-2 text-left">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${userSubmissions.slice(0, 10).map(sub => {
                                            const statusColors = { pending: 'bg-yellow-600', approved: 'bg-green-600', rejected: 'bg-red-600' };
                                            return `
                                                <tr class="border-t border-gray-600">
                                                    <td class="px-3 py-2 font-mono">${sub.taskId}</td>
                                                    <td class="px-3 py-2"><a href="${sub.redditLink}" target="_blank" class="text-blue-400 hover:underline">${sub.redditLink.substring(0, 30)}...</a></td>
                                                    <td class="px-3 py-2"><span class="px-2 py-1 ${statusColors[sub.status]} rounded-full text-xs capitalize">${sub.status}</span></td>
                                                    <td class="px-3 py-2 text-gray-400">${formatDate(sub.submittedAt)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                    
                    <!-- User Withdrawals -->
                    <div class="bg-gray-700 rounded-xl p-4">
                        <h4 class="font-semibold mb-3 flex items-center"><i class="fas fa-money-bill-wave text-green-400 mr-2"></i>Withdrawals (${userWithdrawals.length})</h4>
                        ${userWithdrawals.length === 0 ? `
                            <p class="text-center text-gray-400 py-4">No withdrawals yet</p>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-600">
                                        <tr>
                                            <th class="px-3 py-2 text-left">ID</th>
                                            <th class="px-3 py-2 text-left">Amount</th>
                                            <th class="px-3 py-2 text-left">Method</th>
                                            <th class="px-3 py-2 text-left">Details</th>
                                            <th class="px-3 py-2 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${userWithdrawals.slice(0, 10).map(wd => {
                                            const statusColors = { pending: 'bg-yellow-600', approved: 'bg-green-600', rejected: 'bg-red-600' };
                                            return `
                                                <tr class="border-t border-gray-600">
                                                    <td class="px-3 py-2 font-mono text-xs">${wd.id}</td>
                                                    <td class="px-3 py-2 text-green-400 font-semibold">$${wd.amount.toFixed(2)}</td>
                                                    <td class="px-3 py-2">${wd.method === 'binance' ? '<i class="fab fa-bitcoin text-yellow-400"></i> Binance' : '<i class="fas fa-mobile-alt text-purple-400"></i> UPI'}</td>
                                                    <td class="px-3 py-2 text-gray-400">${wd.details}</td>
                                                    <td class="px-3 py-2"><span class="px-2 py-1 ${statusColors[wd.status]} rounded-full text-xs capitalize">${wd.status === 'approved' ? 'Paid' : wd.status}</span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
        };

        window.closeUserProfileModal = function() {
            document.getElementById('userProfileModal').classList.add('hidden');
        };

        window.banUser = async function(userId) {
            if (confirm('Are you sure you want to ban this user? They will not be able to submit tasks or withdraw funds.')) {
                showLoading('Banning user...');
                await FirestoreDB.updateUser(userId, { banned: true });
                hideLoading();
                viewUserProfile(userId);
            }
        };

        window.unbanUser = async function(userId) {
            if (confirm('Are you sure you want to unban this user?')) {
                showLoading('Unbanning user...');
                await FirestoreDB.updateUser(userId, { banned: false });
                hideLoading();
                viewUserProfile(userId);
            }
        };

        // ============================================
        // INITIALIZE APP
        // ============================================
        async function initApp() {
            try {
                console.log('Initializing app with Firebase...');
                
                await FirestoreDB.initAdmin();
                await Auth.init();
                
                updateFirebaseStatus(true, 'Connected to Firebase');
                
                render();
                
                setInterval(async () => {
                    await FirestoreDB.checkExpiredReservations();
                }, 30000);
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                updateFirebaseStatus(false, 'Connection failed: ' + error.message);
            }
        }

        initApp();
    </script>
</body>
</html>
