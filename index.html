<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reddit Tasks — Admin & User Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    .glass { background: rgba(15, 23, 42, 0.55); backdrop-filter: blur(10px); }
    .gridbg {
      background-image:
        radial-gradient(closest-side, rgba(99,102,241,.25), transparent 70%),
        radial-gradient(closest-side, rgba(34,197,94,.18), transparent 70%),
        linear-gradient(to bottom, rgba(2,6,23,1), rgba(2,6,23,.9));
      background-position: 10% 0%, 90% 20%, 0 0;
      background-size: 900px 900px, 900px 900px, 100% 100%;
      background-repeat: no-repeat;
    }
    .spinner {
      width: 18px; height: 18px; border-radius: 999px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.9);
      animation: spin 800ms linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-full gridbg text-slate-100">
  <div class="min-h-screen">
    <!-- Top bar -->
    <header class="sticky top-0 z-30 border-b border-white/10 bg-slate-950/60 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-indigo-500 to-emerald-400 grid place-items-center shadow-lg shadow-indigo-500/20">
            <span class="font-black text-slate-950">R</span>
          </div>
          <div>
            <div class="text-sm tracking-wide text-white/80">Earn with Simple Tasks</div>
            <div class="text-lg font-semibold">Reddit Tasks</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div id="netBadge" class="hidden sm:flex items-center gap-2 rounded-full border border-white/10 px-3 py-1 text-xs text-white/70">
            <span class="inline-block h-2 w-2 rounded-full bg-emerald-400" id="netDot"></span>
            <span id="netText">Online</span>
          </div>

          <button id="btnLogin" class="inline-flex items-center gap-2 rounded-xl bg-white text-slate-950 px-3 py-2 text-sm font-semibold hover:bg-white/90">
            <span class="hidden sm:inline">Login with Google</span>
            <span class="sm:hidden">Login</span>
          </button>

          <div id="userMenu" class="hidden items-center gap-2">
            <div class="hidden md:block text-right">
              <div id="userName" class="text-sm font-semibold leading-5">—</div>
              <div id="userEmail" class="text-xs text-white/60">—</div>
            </div>
            <img id="userPhoto" alt="" class="h-9 w-9 rounded-full border border-white/10" />
            <button id="btnLogout" class="rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-6">
      <!-- Hero (logged out) -->
      <section id="hero" class="rounded-2xl border border-white/10 glass p-6 md:p-8">
        <div class="grid md:grid-cols-2 gap-6 items-center">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold leading-tight">
              Reddit <span class="text-indigo-300">Post</span> / <span class="text-emerald-300">Comment</span> tasks.
              <span class="block mt-2 text-white/80 text-lg font-semibold">User Panel + Admin Panel</span>
            </h1>
            <p class="mt-3 text-sm md:text-base text-white/70">
              After Google login, a user can claim a task (30 min lock), and must submit a proof link within the time window.
              Admin panel can create tasks and view users/submissions.
            </p>
            <div class="mt-5 flex flex-wrap gap-3">
              <button id="btnLoginHero" class="inline-flex items-center gap-2 rounded-xl bg-indigo-500 px-4 py-2 text-sm font-semibold hover:bg-indigo-400">
                <span>Start — Google Login</span>
              </button>
              <a href="#" id="btnDemoScroll" class="inline-flex items-center gap-2 rounded-xl border border-white/10 px-4 py-2 text-sm hover:bg-white/5">UI Preview</a>
            </div>
            <div class="mt-6 grid grid-cols-3 gap-3 text-center">
              <div class="rounded-xl border border-white/10 p-3">
                <div class="text-xs text-white/60">Lock</div>
                <div class="mt-1 font-semibold">30 min</div>
              </div>
              <div class="rounded-xl border border-white/10 p-3">
                <div class="text-xs text-white/60">Eligibility</div>
                <div class="mt-1 font-semibold">Karma 200+</div>
              </div>
              <div class="rounded-xl border border-white/10 p-3">
                <div class="text-xs text-white/60">Backend</div>
                <div class="mt-1 font-semibold">Firebase</div>
              </div>
            </div>
          </div>
          <div class="rounded-2xl border border-white/10 p-5 bg-slate-950/40">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Flow</div>
              <div class="text-xs text-white/60">v2</div>
            </div>
            <ol class="mt-3 space-y-2 text-sm text-white/75 list-decimal list-inside">
              <li>Login</li>
              <li>Fill Reddit profile + karma (min 200)</li>
              <li>Claim a task (locked for claim window)</li>
              <li>Submit proof link within the claim window</li>
              <li>Admin manages tasks and views users/submissions</li>
            </ol>
            <div class="mt-4 rounded-xl border border-white/10 p-3 text-xs text-white/60">
              Note: Configure Firestore security rules for production.
            </div>
          </div>
        </div>
      </section>

      <!-- App -->
      <section id="app" class="hidden mt-6">
        <!-- Panel switch + quick status -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
          <div class="flex flex-col md:flex-row md:items-center gap-3">
            <div class="inline-flex rounded-2xl border border-white/10 bg-slate-950/40 p-1">
              <button id="btnPanelUser" class="rounded-xl px-4 py-2 text-sm font-semibold bg-white/10">User Panel</button>
              <button id="btnPanelAdmin" class="hidden rounded-xl px-4 py-2 text-sm font-semibold hover:bg-white/5">Admin Panel</button>
            </div>

            <div id="profileStatus" class="rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-white/70 flex items-center gap-2">
              <span id="profileDot" class="inline-block h-2 w-2 rounded-full bg-amber-300"></span>
              <span id="profileText">Profile: pending</span>
              <button id="btnEditProfile" class="ml-1 text-xs underline text-indigo-200 hover:text-indigo-100">Edit</button>
            </div>

            <div id="activeClaimPill" class="hidden rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm text-white/70">
              <span class="text-white/60">Active claim:</span>
              <span id="activeClaimTime" class="ml-1 font-semibold">—</span>
              <button id="btnOpenActiveClaim" class="ml-2 text-xs underline text-emerald-200 hover:text-emerald-100">Open</button>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <div class="w-full sm:w-auto rounded-2xl border border-white/10 bg-slate-950/40 p-2 flex items-center gap-2">
              <input id="searchInput" class="min-w-0 w-full sm:w-56 bg-transparent outline-none text-sm placeholder:text-white/40" placeholder="Search title/subreddit/task id..." />
              <button id="btnClearSearch" class="shrink-0 text-xs text-white/60 hover:text-white">Clear</button>
            </div>

            <select id="typeFilter" class="w-full sm:w-auto rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none">
              <option value="all">All Types</option>
              <option value="post">Post</option>
              <option value="comment">Comment</option>
            </select>

            <select id="adminStatusFilter" class="hidden w-full sm:w-auto rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none">
              <option value="all">All Status</option>
              <option value="open">Open</option>
              <option value="submitted">Submitted</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>

        <!-- USER PANEL -->
        <div id="panelUser" class="mt-4">
          <div id="userEligibilityBanner" class="hidden rounded-2xl border border-amber-400/20 bg-amber-500/10 p-4 text-sm text-amber-100">
            <div class="font-semibold">Reddit profile required</div>
            <div class="mt-1 text-amber-100/90">To claim tasks you must fill your Reddit username and have minimum karma <b>200+</b>.</div>
            <div class="mt-3">
              <button id="btnOpenProfileFromBanner" class="rounded-xl bg-amber-300 text-slate-950 px-4 py-2 text-sm font-semibold hover:bg-amber-200">Fill Profile</button>
            </div>
          </div>

          <div id="activeClaimCard" class="hidden mt-4 rounded-2xl border border-white/10 glass p-5">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <div class="text-sm text-white/60">Your active claim</div>
                <div id="activeClaimTitle" class="mt-1 text-lg font-semibold">—</div>
                <div id="activeClaimMeta" class="mt-1 text-xs text-white/60">—</div>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                <div class="rounded-xl border border-white/10 px-3 py-2 text-sm">
                  <span class="text-white/60">Time left</span>
                  <span id="activeClaimCountdown" class="ml-2 font-semibold">—</span>
                </div>
                <button id="btnOpenClaimModal" class="rounded-xl bg-white text-slate-950 px-4 py-2 text-sm font-semibold hover:bg-white/90">Open</button>
              </div>
            </div>
            <div class="mt-3 text-xs text-white/60">Note: While you have an active claim, you cannot claim another task.</div>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-white/70">Available tasks</div>
            <div id="tasksLoading" class="hidden items-center gap-2 text-xs text-white/60"><span class="spinner"></span><span>Loading...</span></div>
          </div>

          <div id="tasksEmpty" class="hidden mt-4 rounded-2xl border border-white/10 p-6 text-center text-white/70">
            No tasks available right now.
          </div>

          <div id="tasksList" class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3"></div>

          <div class="mt-10">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">My Submissions</div>
                <div class="text-xs text-white/60">Your submitted proofs</div>
              </div>
              <div id="mineLoading" class="hidden items-center gap-2 text-xs text-white/60"><span class="spinner"></span><span>Loading...</span></div>
            </div>
            <div id="mineEmpty" class="hidden mt-4 rounded-2xl border border-white/10 p-6 text-center text-white/70">
              You have not submitted any proof yet.
            </div>
            <div id="mineList" class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3"></div>
          </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="panelAdmin" class="hidden mt-4">
          <div class="rounded-2xl border border-white/10 bg-slate-950/40 p-1 inline-flex flex-wrap">
            <button data-admin-tab="create" class="adminTab rounded-xl px-4 py-2 text-sm font-semibold bg-white/10">Create Task</button>
            <button data-admin-tab="tasks" class="adminTab rounded-xl px-4 py-2 text-sm font-semibold hover:bg-white/5">Manage Tasks</button>
            <button data-admin-tab="users" class="adminTab rounded-xl px-4 py-2 text-sm font-semibold hover:bg-white/5">Users</button>
            <button data-admin-tab="subs" class="adminTab rounded-xl px-4 py-2 text-sm font-semibold hover:bg-white/5">Submissions</button>
          </div>

          <!-- Admin: Create -->
          <div id="adminCreate" class="mt-4">
            <div class="grid lg:grid-cols-3 gap-4">
              <div class="lg:col-span-2 rounded-2xl border border-white/10 glass p-5">
                <div class="flex items-center justify-between">
                  <h2 class="text-lg font-semibold">Create a Reddit Task (Admin)</h2>
                  <div class="text-xs text-white/60">Firestore: tasks (ID starts from 1010)</div>
                </div>

                <form id="createForm" class="mt-4 grid md:grid-cols-2 gap-3">
                  <label class="block">
                    <div class="text-xs text-white/60">Task Type</div>
                    <select id="ctType" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" required>
                      <option value="post">Post</option>
                      <option value="comment">Comment</option>
                    </select>
                  </label>

                  <label class="block">
                    <div class="text-xs text-white/60">Subreddit</div>
                    <input id="ctSubreddit" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="e.g. AskReddit" required />
                  </label>

                  <label id="ctTitleWrap" class="block md:col-span-2">
                    <div class="text-xs text-white/60">Title (Post only)</div>
                    <input id="ctTitle" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="Post title..." />
                    <div class="mt-1 text-[11px] text-white/45">For comment tasks, a title is auto-generated.</div>
                  </label>

                  <!-- Post fields -->
                  <div id="postFields" class="md:col-span-2 grid gap-3">
                    <label class="block">
                      <div class="text-xs text-white/60">Body (Post content)</div>
                      <textarea id="ctBody" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" rows="5" placeholder="Post body..." required></textarea>
                    </label>
                    <label class="block">
                      <div class="text-xs text-white/60">Image URL (optional)</div>
                      <input id="ctImage" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="https://..." />
                      <div class="mt-1 text-[11px] text-white/45">Optional preview image (reference only).</div>
                    </label>
                  </div>

                  <!-- Comment fields -->
                  <div id="commentFields" class="md:col-span-2 hidden grid gap-3">
                    <div class="rounded-xl border border-white/10 bg-slate-950/30 p-3 text-xs text-white/60">
                      Comment tasks do not require a title. A title will be generated automatically.
                    </div>
                    <label class="block">
                      <div class="text-xs text-white/60">Target Link (post URL)</div>
                      <input id="ctTargetLink" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="https://www.reddit.com/..." />
                    </label>
                    <label class="block">
                      <div class="text-xs text-white/60">Comment Text / Instructions</div>
                      <textarea id="ctInstructions" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" rows="4" placeholder="What to comment / rules..." required></textarea>
                    </label>
                  </div>

                  <label class="block">
                    <div class="text-xs text-white/60">Price (USD)</div>
                    <input id="ctReward" type="number" min="0" step="0.01" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" value="1" required />
                    <div class="mt-1 text-[11px] text-white/45">Amount in USD ($).</div>
                  </label>

                  <label class="block">
                    <div class="text-xs text-white/60">Status</div>
                    <select id="ctStatus" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" required>
                      <option value="open">Open</option>
                      <option value="closed">Closed</option>
                    </select>
                  </label>

                  <label class="block">
                    <div class="text-xs text-white/60">Claim window (minutes)</div>
                    <input id="ctClaimMins" type="number" min="1" step="1" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" value="30" required />
                    <div class="mt-1 text-[11px] text-white/45">Default 30 minutes.</div>
                  </label>

                  <label class="block">
                    <div class="text-xs text-white/60">Expire in (days)</div>
                    <input id="ctExpireDays" type="number" min="0" step="1" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" value="0" />
                    <div class="mt-1 text-[11px] text-white/45">0 = no expiry</div>
                  </label>

                  <div class="md:col-span-2 flex items-center justify-between gap-3 pt-2">
                    <div id="createHint" class="text-xs text-white/60">Tip: Write clear instructions. User must submit proof within the claim window.</div>
                    <button id="btnCreateTask" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">
                      <span id="createBtnText">Create Task</span>
                      <span id="createSpinner" class="hidden spinner" aria-hidden="true"></span>
                    </button>
                  </div>
                </form>
              </div>

              <aside class="rounded-2xl border border-white/10 bg-slate-950/40 p-5">
                <div class="text-sm font-semibold">Admin Notes</div>
                <ul class="mt-3 space-y-2 text-sm text-white/70">
                  <li>After a claim, the task is locked for the configured window.</li>
                  <li>When the lock expires, the task becomes available again (with client-side cleanup).</li>
                  <li>Users list shows Reddit profile + karma.</li>
                </ul>
                <div class="mt-5 rounded-xl border border-white/10 p-3 text-xs text-white/60">
                  Collections:
                  <div class="mt-2 font-mono text-[11px] text-white/70">users / tasks / submissions / meta</div>
                  <div class="mt-2 text-[11px] text-white/45">Counter doc: meta/counters → nextTaskId (starts at 1010)</div>
                </div>
              </aside>
            </div>
          </div>

          <!-- Admin: Tasks -->
          <div id="adminTasks" class="hidden mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">Manage Tasks</div>
                <div class="text-xs text-white/60">Open/Close, Force Unlock</div>
              </div>
              <div id="adminTasksLoading" class="hidden items-center gap-2 text-xs text-white/60"><span class="spinner"></span><span>Loading...</span></div>
            </div>
            <div id="adminTasksList" class="mt-4 grid gap-3"></div>
          </div>

          <!-- Admin: Users -->
          <div id="adminUsers" class="hidden mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">Users</div>
                <div class="text-xs text-white/60">Account + Reddit profile details</div>
              </div>
              <div id="usersLoading" class="hidden items-center gap-2 text-xs text-white/60"><span class="spinner"></span><span>Loading...</span></div>
            </div>
            <div id="usersList" class="mt-4 grid gap-3"></div>
          </div>

          <!-- Admin: Submissions -->
          <div id="adminSubs" class="hidden mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">Submissions</div>
                <div class="text-xs text-white/60">Latest proofs</div>
              </div>
              <div id="subsLoading" class="hidden items-center gap-2 text-xs text-white/60"><span class="spinner"></span><span>Loading...</span></div>
            </div>
            <div id="subsList" class="mt-4 grid gap-3"></div>
          </div>
        </div>
      </section>

      <footer class="mt-10 pb-10 text-center text-xs text-white/45">
        Firebase Auth + Firestore. Configure Firestore rules/indexes for production.
      </footer>
    </main>
  </div>

  <!-- Task modal (details + claim/submit) -->
  <div id="modalOverlay" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative mx-auto max-w-3xl px-4 py-6 sm:py-10">
      <div class="rounded-2xl border border-white/10 bg-slate-950/80 backdrop-blur p-5">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div id="modalType" class="text-xs text-white/60">—</div>
            <div id="modalTitle" class="mt-1 text-lg font-semibold break-words">—</div>
            <div id="modalMeta" class="mt-1 text-xs text-white/60">—</div>
          </div>
          <button id="btnCloseModal" class="rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5">Close</button>
        </div>

        <div class="mt-4 grid gap-3">
          <div id="modalImageWrap" class="hidden rounded-xl border border-white/10 overflow-hidden bg-slate-950/40">
            <img id="modalImage" alt="" class="w-full max-h-80 object-cover" />
          </div>

          <div class="rounded-xl border border-white/10 p-3">
            <div class="text-xs text-white/60">Details</div>
            <div id="modalDetails" class="mt-1 whitespace-pre-wrap text-sm text-white/80">—</div>
          </div>

          <div class="rounded-xl border border-white/10 p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-xs text-white/60">Target / Reference Link</div>
              <a id="modalLink" href="#" target="_blank" rel="noreferrer" class="mt-1 text-sm text-indigo-300 hover:underline break-all">—</a>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-white/60">Price:</span>
              <span id="modalReward" class="text-sm font-semibold">—</span>
              <span class="text-xs text-white/60">USD</span>
            </div>
          </div>

          <div class="rounded-xl border border-white/10 p-3">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">Claim / Submit</div>
                <div id="modalLockInfo" class="text-xs text-white/60 mt-0.5">—</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnClaim" class="hidden rounded-xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">Claim</button>
                <button id="btnForceUnlock" class="hidden rounded-xl border border-white/10 px-4 py-2 text-sm hover:bg-white/5">Force Unlock</button>
              </div>
            </div>

            <form id="submitForm" class="mt-3 grid gap-3">
              <label class="block">
                <div class="text-xs text-white/60">Completion Proof Link (Reddit post/comment URL)</div>
                <input id="proofLink" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="https://www.reddit.com/..." required />
              </label>
              <label class="block">
                <div class="text-xs text-white/60">Note (optional)</div>
                <textarea id="proofNote" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" rows="3" placeholder="Any extra info..."></textarea>
              </label>
              <div class="flex items-center justify-between gap-3">
                <div id="submitHint" class="text-xs text-white/60"></div>
                <button id="btnSubmitProof" class="inline-flex items-center gap-2 rounded-xl bg-indigo-500 px-4 py-2 text-sm font-semibold hover:bg-indigo-400">
                  <span id="submitBtnText">Submit</span>
                  <span id="submitSpinner" class="hidden spinner" aria-hidden="true"></span>
                </button>
              </div>
            </form>
          </div>

          <div class="rounded-xl border border-white/10 p-3">
            <div class="text-sm font-semibold">Recent Submissions (this task)</div>
            <div id="taskSubs" class="mt-2 grid gap-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileOverlay" class="fixed inset-0 z-[55] hidden overflow-y-auto">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative mx-auto max-w-xl px-4 py-6 sm:py-10">
      <div class="rounded-2xl border border-white/10 bg-slate-950/85 backdrop-blur p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs text-white/60">User Profile</div>
            <div class="mt-1 text-lg font-semibold">Reddit Profile (Manual)</div>
            <div class="mt-1 text-xs text-white/60">Minimum karma: <b>200+</b></div>
          </div>
          <button id="btnCloseProfile" class="rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5">Close</button>
        </div>

        <form id="profileForm" class="mt-4 grid gap-3">
          <label class="block">
            <div class="text-xs text-white/60">Reddit Username</div>
            <input id="rpUsername" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="e.g. someUser" required />
          </label>
          <label class="block">
            <div class="text-xs text-white/60">Reddit Profile Link (optional)</div>
            <input id="rpLink" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="https://www.reddit.com/user/..." />
          </label>
          <label class="block">
            <div class="text-xs text-white/60">Karma</div>
            <input id="rpKarma" type="number" min="0" step="1" class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 text-sm outline-none" placeholder="200" required />
          </label>
          <div class="flex items-center justify-between gap-3 pt-2">
            <div id="profileHint" class="text-xs text-white/60">Karma must be 200+ to claim tasks.</div>
            <button id="btnSaveProfile" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">
              <span id="profileBtnText">Save</span>
              <span id="profileSpinner" class="hidden spinner" aria-hidden="true"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] hidden">
    <div class="rounded-2xl border border-white/10 bg-slate-950/80 backdrop-blur px-4 py-3 text-sm shadow-xl">
      <div class="flex items-start gap-3">
        <div id="toastDot" class="mt-1 h-2 w-2 rounded-full bg-emerald-400"></div>
        <div>
          <div id="toastTitle" class="font-semibold">—</div>
          <div id="toastMsg" class="text-xs text-white/70 mt-0.5">—</div>
        </div>
        <button id="toastClose" class="ml-2 text-xs text-white/60 hover:text-white">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      serverTimestamp,
      query,
      where,
      orderBy,
      limit,
      onSnapshot,
      runTransaction,
      increment
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- Firebase config (provided) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBRJEmHXbHysb0weZfsVNTzUl0TDTjyuVI",
      authDomain: "earnwithsimpletasks.firebaseapp.com",
      projectId: "earnwithsimpletasks",
      storageBucket: "earnwithsimpletasks.firebasestorage.app",
      messagingSenderId: "942400388770",
      appId: "1:942400388770:web:47475e0a0b60c1fb1b21fb",
      measurementId: "G-132E8PF7LT"
    };

    // --- Admin allowlist (EDIT THIS) ---
    const ADMIN_EMAILS = [
      // "youradmin@gmail.com"
    ];
    const ADMIN_UIDS = [
      // "yourAdminUid"
    ];

    // --- Task counter ---
    const TASK_ID_START = 1010;
    const COUNTER_DOC = { col: 'meta', doc: 'counters', field: 'nextTaskId' };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM helpers ---
    const el = (id) => document.getElementById(id);
    const safe = (v) => (v ?? '').toString();

    const hero = el('hero');
    const appSection = el('app');

    const btnLogin = el('btnLogin');
    const btnLoginHero = el('btnLoginHero');
    const btnLogout = el('btnLogout');

    const userMenu = el('userMenu');
    const userName = el('userName');
    const userEmail = el('userEmail');
    const userPhoto = el('userPhoto');

    const netBadge = el('netBadge');
    const netText = el('netText');
    const netDot = el('netDot');

    const btnPanelUser = el('btnPanelUser');
    const btnPanelAdmin = el('btnPanelAdmin');
    const panelUser = el('panelUser');
    const panelAdmin = el('panelAdmin');

    const typeFilter = el('typeFilter');
    const searchInput = el('searchInput');
    const btnClearSearch = el('btnClearSearch');
    const adminStatusFilter = el('adminStatusFilter');

    const tasksLoading = el('tasksLoading');
    const tasksEmpty = el('tasksEmpty');
    const tasksList = el('tasksList');

    const mineLoading = el('mineLoading');
    const mineEmpty = el('mineEmpty');
    const mineList = el('mineList');

    const profileDot = el('profileDot');
    const profileText = el('profileText');
    const btnEditProfile = el('btnEditProfile');

    const userEligibilityBanner = el('userEligibilityBanner');
    const btnOpenProfileFromBanner = el('btnOpenProfileFromBanner');

    const activeClaimPill = el('activeClaimPill');
    const activeClaimTime = el('activeClaimTime');
    const btnOpenActiveClaim = el('btnOpenActiveClaim');

    const activeClaimCard = el('activeClaimCard');
    const activeClaimTitle = el('activeClaimTitle');
    const activeClaimMeta = el('activeClaimMeta');
    const activeClaimCountdown = el('activeClaimCountdown');
    const btnOpenClaimModal = el('btnOpenClaimModal');

    // Admin UI
    const adminTabs = Array.from(document.querySelectorAll('.adminTab'));
    const adminCreate = el('adminCreate');
    const adminTasks = el('adminTasks');
    const adminUsers = el('adminUsers');
    const adminSubs = el('adminSubs');

    const adminTasksLoading = el('adminTasksLoading');
    const adminTasksList = el('adminTasksList');

    const usersLoading = el('usersLoading');
    const usersList = el('usersList');

    const subsLoading = el('subsLoading');
    const subsList = el('subsList');

    // Create form
    const createForm = el('createForm');
    const ctType = el('ctType');
    const postFields = el('postFields');
    const commentFields = el('commentFields');

    const btnCreateTask = el('btnCreateTask');
    const createSpinner = el('createSpinner');
    const createBtnText = el('createBtnText');

    // Task modal
    const modalOverlay = el('modalOverlay');
    const btnCloseModal = el('btnCloseModal');
    const modalType = el('modalType');
    const modalTitle = el('modalTitle');
    const modalMeta = el('modalMeta');
    const modalImageWrap = el('modalImageWrap');
    const modalImage = el('modalImage');
    const modalDetails = el('modalDetails');
    const modalLink = el('modalLink');
    const modalReward = el('modalReward');
    const modalLockInfo = el('modalLockInfo');
    const btnClaim = el('btnClaim');
    const btnForceUnlock = el('btnForceUnlock');

    const submitForm = el('submitForm');
    const proofLink = el('proofLink');
    const proofNote = el('proofNote');
    const btnSubmitProof = el('btnSubmitProof');
    const submitSpinner = el('submitSpinner');
    const submitBtnText = el('submitBtnText');
    const submitHint = el('submitHint');
    const taskSubs = el('taskSubs');

    // Profile modal
    const profileOverlay = el('profileOverlay');
    const btnCloseProfile = el('btnCloseProfile');
    const profileForm = el('profileForm');
    const rpUsername = el('rpUsername');
    const rpLink = el('rpLink');
    const rpKarma = el('rpKarma');
    const btnSaveProfile = el('btnSaveProfile');
    const profileSpinner = el('profileSpinner');
    const profileBtnText = el('profileBtnText');
    const profileHint = el('profileHint');

    // Toast
    const toast = el('toast');
    const toastTitle = el('toastTitle');
    const toastMsg = el('toastMsg');
    const toastDot = el('toastDot');
    const toastClose = el('toastClose');

    // --- State ---
    let currentUser = null;
    let currentUserDoc = null;
    let isAdmin = false;

    let tasksCache = [];
    let openTask = null;

    let unsubTasks = null;
    let unsubMine = null;
    let unsubUsers = null;
    let unsubSubs = null;
    let unsubTaskSubs = null;
    let unsubUserDoc = null;

    let uiPanel = 'user';
    let adminTab = 'create';

    // --- Utils ---
    const fmtTime = (ts) => {
      if (!ts) return '—';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    };

    const nowMs = () => Date.now();

    const toMs = (ts) => {
      if (!ts) return 0;
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.getTime();
    };

    const msToClock = (ms) => {
      const s = Math.max(0, Math.floor(ms / 1000));
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return `${mm}:${ss}`;
    };

    const escapeHtml = (str) => {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    };
    const escapeAttr = (str) => escapeHtml(str).replaceAll('`', '&#096;');

    function showToast({ title, message, type = 'success' }) {
      toastTitle.textContent = title;
      toastMsg.textContent = message;
      toastDot.className = `mt-1 h-2 w-2 rounded-full ${type === 'error' ? 'bg-rose-400' : type === 'warn' ? 'bg-amber-300' : 'bg-emerald-400'}`;
      toast.classList.remove('hidden');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.add('hidden'), 3500);
    }
    toastClose.addEventListener('click', () => toast.classList.add('hidden'));

    function setBusy(button, busy, spinnerEl, textEl, busyText) {
      button.disabled = busy;
      button.classList.toggle('opacity-60', busy);
      button.classList.toggle('cursor-not-allowed', busy);
      if (spinnerEl) spinnerEl.classList.toggle('hidden', !busy);
      if (textEl) {
        if (!textEl.dataset.orig) textEl.dataset.orig = textEl.textContent;
        textEl.textContent = busy ? busyText : textEl.dataset.orig;
      }
    }

    function setOnlineBadge() {
      netBadge.classList.remove('hidden');
      const online = navigator.onLine;
      netText.textContent = online ? 'Online' : 'Offline';
      netDot.className = `inline-block h-2 w-2 rounded-full ${online ? 'bg-emerald-400' : 'bg-rose-400'}`;
    }
    window.addEventListener('online', setOnlineBadge);
    window.addEventListener('offline', setOnlineBadge);
    setOnlineBadge();

    // --- Panel switching ---
    function setPanel(panel) {
      uiPanel = panel;
      const userActive = panel === 'user';
      btnPanelUser.classList.toggle('bg-white/10', userActive);
      btnPanelUser.classList.toggle('hover:bg-white/5', !userActive);
      btnPanelAdmin.classList.toggle('bg-white/10', !userActive);
      btnPanelAdmin.classList.toggle('hover:bg-white/5', userActive);

      panelUser.classList.toggle('hidden', !userActive);
      panelAdmin.classList.toggle('hidden', userActive);

      adminStatusFilter.classList.toggle('hidden', userActive || !isAdmin);

      // Optimization: stop admin listeners when leaving admin panel
      if (userActive) {
        if (unsubUsers) { unsubUsers(); unsubUsers = null; }
        if (unsubSubs) { unsubSubs(); unsubSubs = null; }
        usersLoading.classList.add('hidden');
        subsLoading.classList.add('hidden');
      } else if (isAdmin) {
        startUsersListener();
        startAdminSubsListener();
      }

      renderAll();
    }

    btnPanelUser.addEventListener('click', () => setPanel('user'));
    btnPanelAdmin.addEventListener('click', () => isAdmin && setPanel('admin'));

    function setAdminTab(tab) {
      adminTab = tab;
      adminTabs.forEach(b => {
        const active = b.dataset.adminTab === tab;
        b.classList.toggle('bg-white/10', active);
        b.classList.toggle('hover:bg-white/5', !active);
      });
      adminCreate.classList.toggle('hidden', tab !== 'create');
      adminTasks.classList.toggle('hidden', tab !== 'tasks');
      adminUsers.classList.toggle('hidden', tab !== 'users');
      adminSubs.classList.toggle('hidden', tab !== 'subs');

      adminStatusFilter.classList.toggle('hidden', tab !== 'tasks');
      renderAll();
    }
    adminTabs.forEach(b => b.addEventListener('click', () => setAdminTab(b.dataset.adminTab)));

    // --- Hero scroll ---
    el('btnDemoScroll')?.addEventListener('click', (e) => {
      e.preventDefault();
      window.scrollTo({ top: hero.offsetTop + hero.offsetHeight + 8, behavior: 'smooth' });
    });

    // Filters
    btnClearSearch.addEventListener('click', () => { searchInput.value = ''; renderAll(); });
    searchInput.addEventListener('input', () => renderAll());
    typeFilter.addEventListener('change', () => renderAll());
    adminStatusFilter.addEventListener('change', () => renderAll());

    // --- Auth ---
    async function googleLogin() {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        showToast({ title: 'Login failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    }
    btnLogin.addEventListener('click', googleLogin);
    btnLoginHero.addEventListener('click', googleLogin);

    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        showToast({ title: 'Logout failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      currentUserDoc = null;
      isAdmin = false;

      stopAllListeners();
      closeModal();

      if (!user) {
        hero.classList.remove('hidden');
        appSection.classList.add('hidden');
        btnLogin.classList.remove('hidden');
        userMenu.classList.add('hidden');
        return;
      }

      // UI basics
      hero.classList.add('hidden');
      appSection.classList.remove('hidden');
      btnLogin.classList.add('hidden');
      userMenu.classList.remove('hidden');

      userName.textContent = user.displayName || 'User';
      userEmail.textContent = user.email || '';
      userPhoto.src = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';

      // Ensure user doc exists
      try {
        const uref = doc(db, 'users', user.uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          await setDoc(uref, {
            uid: user.uid,
            name: user.displayName || null,
            email: user.email || null,
            photoURL: user.photoURL || null,
            redditUsername: null,
            redditProfileLink: null,
            redditKarma: null,
            createdAt: serverTimestamp(),
            lastLoginAt: serverTimestamp(),
            activeClaimTaskId: null,
            activeClaimUntil: null,
            isAdmin: false
          });
        } else {
          await updateDoc(uref, {
            name: user.displayName || null,
            email: user.email || null,
            photoURL: user.photoURL || null,
            lastLoginAt: serverTimestamp()
          });
        }
      } catch (err) {
        console.warn('User doc write failed', err);
      }

      // Listen user doc (for profile + active claim)
      startUserDocListener();

      // Start common listeners
      startTasksListener();
      startMineListener();

      // Default view
      setPanel('user');
      setAdminTab('create');

      showToast({ title: 'Logged in', message: `Welcome ${user.displayName || ''}`.trim() });
    });

    function stopAllListeners() {
      if (unsubTasks) { unsubTasks(); unsubTasks = null; }
      if (unsubMine) { unsubMine(); unsubMine = null; }
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      if (unsubSubs) { unsubSubs(); unsubSubs = null; }
      if (unsubTaskSubs) { unsubTaskSubs(); unsubTaskSubs = null; }
      if (unsubUserDoc) { unsubUserDoc(); unsubUserDoc = null; }
    }

    // --- User doc listener ---
    function startUserDocListener() {
      if (!currentUser) return;
      if (unsubUserDoc) { unsubUserDoc(); unsubUserDoc = null; }

      const uref = doc(db, 'users', currentUser.uid);
      unsubUserDoc = onSnapshot(uref, (snap) => {
        currentUserDoc = snap.exists() ? snap.data() : null;

        isAdmin = Boolean(
          ADMIN_UIDS.includes(currentUser.uid) ||
          (currentUser.email && ADMIN_EMAILS.includes(currentUser.email)) ||
          currentUserDoc?.isAdmin === true
        );

        btnPanelAdmin.classList.toggle('hidden', !isAdmin);

        // Update profile status UI
        const karma = Number(currentUserDoc?.redditKarma ?? 0);
        const hasUsername = !!safe(currentUserDoc?.redditUsername).trim();
        const eligible = hasUsername && karma >= 200;

        profileText.textContent = eligible
          ? `Profile: OK (u/${safe(currentUserDoc.redditUsername)} • karma ${karma})`
          : 'Profile: pending (fill Reddit + karma 200+)';

        profileDot.className = `inline-block h-2 w-2 rounded-full ${eligible ? 'bg-emerald-400' : 'bg-amber-300'}`;

        userEligibilityBanner.classList.toggle('hidden', eligible);

        // Active claim UI
        const activeId = safe(currentUserDoc?.activeClaimTaskId).trim() || null;
        const untilMs = toMs(currentUserDoc?.activeClaimUntil);
        const active = activeId && untilMs > nowMs();

        activeClaimPill.classList.toggle('hidden', !active);
        activeClaimCard.classList.toggle('hidden', !active);

        if (active) {
          activeClaimTime.textContent = msToClock(untilMs - nowMs());
        } else {
          activeClaimTime.textContent = '—';
        }

        // cleanup expired claim fields if needed
        maybeCleanupExpiredClaim();

        renderAll();
      }, (err) => {
        console.error(err);
        showToast({ title: 'Profile load failed', message: err?.message || 'Check Firestore rules', type: 'error' });
      });
    }

    // --- Tasks listener ---
    function startTasksListener() {
      if (!currentUser) return;
      if (unsubTasks) { unsubTasks(); unsubTasks = null; }

      tasksLoading.classList.remove('hidden');
      adminTasksLoading.classList.remove('hidden');

      const q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'), limit(300));
      unsubTasks = onSnapshot(q, (snap) => {
        tasksCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        tasksLoading.classList.add('hidden');
        adminTasksLoading.classList.add('hidden');

        // Keep modal in sync without extra reads
        if (!modalOverlay.classList.contains('hidden') && openTask) {
          const updated = tasksCache.find(x => x.id === openTask.id);
          if (updated) {
            openTask = updated;
            updateModalDynamic(openTask);
          }
        }

        renderAll();
      }, (err) => {
        console.error(err);
        tasksLoading.classList.add('hidden');
        adminTasksLoading.classList.add('hidden');
        showToast({ title: 'Tasks load failed', message: err?.message || 'Check Firestore rules/indexes', type: 'error' });
      });
    }

    // --- My submissions ---
    function startMineListener() {
      if (!currentUser) return;
      if (unsubMine) { unsubMine(); unsubMine = null; }

      mineLoading.classList.remove('hidden');
      mineEmpty.classList.add('hidden');

      const q = query(collection(db, 'submissions'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'), limit(200));
      unsubMine = onSnapshot(q, (snap) => {
        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMine(list);
        mineLoading.classList.add('hidden');
      }, (err) => {
        console.error(err);
        mineLoading.classList.add('hidden');
        showToast({ title: 'My submissions load failed', message: err?.message || 'Check Firestore rules/index', type: 'error' });
      });
    }

    function renderMine(list) {
      mineList.innerHTML = '';
      if (!list.length) {
        mineEmpty.classList.remove('hidden');
        return;
      }
      mineEmpty.classList.add('hidden');

      for (const s of list) {
        const node = document.createElement('div');
        node.className = 'rounded-2xl border border-white/10 bg-slate-950/40 p-4';
        node.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                ${badgeForType(s.taskType)}
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">${escapeHtml(s.status || 'pending')}</span>
                <span class="text-xs text-white/50">${fmtTime(s.createdAt)}</span>
                ${s.taskId ? `<span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">Task #${escapeHtml(s.taskId)}</span>` : ''}
              </div>
              <div class="mt-2 font-semibold break-words">${escapeHtml(s.taskTitle || 'Task')}</div>
              <a class="mt-2 block text-sm text-indigo-300 hover:underline break-all" href="${escapeAttr(s.proofLink || '#')}" target="_blank" rel="noreferrer">${escapeHtml(s.proofLink || '')}</a>
              ${s.note ? `<div class="mt-2 text-xs text-white/70 whitespace-pre-wrap">${escapeHtml(s.note)}</div>` : ''}
            </div>
            <div class="shrink-0 rounded-xl border border-white/10 px-3 py-2 text-sm">
              <span class="text-white/60">Price</span>
              <span class="ml-2 font-semibold">$${Number(s.reward ?? 0).toFixed(2)}</span>
            </div>
          </div>
        `;
        mineList.appendChild(node);
      }
    }

    // --- Admin: users list ---
    function startUsersListener() {
      if (!currentUser || !isAdmin) return;
      if (unsubUsers) return; // already running

      usersLoading.classList.remove('hidden');
      const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'), limit(300));
      unsubUsers = onSnapshot(q, (snap) => {
        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsers(list);
        usersLoading.classList.add('hidden');
      }, (err) => {
        console.error(err);
        usersLoading.classList.add('hidden');
        showToast({ title: 'Users load failed', message: err?.message || 'Check rules/index', type: 'error' });
      });
    }

    function renderUsers(list) {
      usersList.innerHTML = '';
      if (!list.length) {
        usersList.innerHTML = `<div class="text-sm text-white/60">No users.</div>`;
        return;
      }

      for (const u of list) {
        const karma = Number(u.redditKarma ?? 0);
        const ok = safe(u.redditUsername).trim() && karma >= 200;
        const activeUntil = toMs(u.activeClaimUntil);
        const hasActive = u.activeClaimTaskId && activeUntil > nowMs();

        const node = document.createElement('div');
        node.className = 'rounded-2xl border border-white/10 bg-slate-950/40 p-4';
        node.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <img class="h-9 w-9 rounded-full border border-white/10" src="${escapeAttr(u.photoURL || 'https://www.gravatar.com/avatar/?d=mp')}" alt="" />
                <div class="min-w-0">
                  <div class="font-semibold break-words">${escapeHtml(u.name || 'User')}</div>
                  <div class="text-xs text-white/60 break-words">${escapeHtml(u.email || '')}</div>
                </div>
              </div>
              <div class="mt-3 grid sm:grid-cols-2 gap-2 text-xs text-white/70">
                <div class="rounded-xl border border-white/10 p-2">
                  <div class="text-white/50">Created</div>
                  <div>${fmtTime(u.createdAt)}</div>
                </div>
                <div class="rounded-xl border border-white/10 p-2">
                  <div class="text-white/50">Last login</div>
                  <div>${fmtTime(u.lastLoginAt)}</div>
                </div>
                <div class="rounded-xl border border-white/10 p-2">
                  <div class="text-white/50">Reddit</div>
                  <div>${ok ? `u/${escapeHtml(u.redditUsername)} • karma ${karma}` : 'Not eligible / not filled'}</div>
                  ${u.redditProfileLink ? `<a class="mt-1 block text-indigo-300 hover:underline break-all" target="_blank" rel="noreferrer" href="${escapeAttr(u.redditProfileLink)}">${escapeHtml(u.redditProfileLink)}</a>` : ''}
                </div>
                <div class="rounded-xl border border-white/10 p-2">
                  <div class="text-white/50">Active claim</div>
                  <div>${hasActive ? `Task #${escapeHtml(u.activeClaimTaskId)} • left ${msToClock(activeUntil - nowMs())}` : '—'}</div>
                </div>
              </div>
            </div>

            <div class="shrink-0 flex items-center gap-2">
              <span class="text-[11px] rounded-full border ${ok ? 'border-emerald-400/20 bg-emerald-500/10 text-emerald-200' : 'border-amber-400/20 bg-amber-500/10 text-amber-200'} px-2 py-1">${ok ? 'ELIGIBLE' : 'PENDING'}</span>
              <span class="text-[11px] rounded-full border border-white/10 px-2 py-1 text-white/60">${u.isAdmin ? 'ADMIN' : 'USER'}</span>
            </div>
          </div>
        `;
        usersList.appendChild(node);
      }
    }

    // --- Admin: submissions list ---
    function startAdminSubsListener() {
      if (!currentUser || !isAdmin) return;
      if (unsubSubs) return;

      subsLoading.classList.remove('hidden');
      const q = query(collection(db, 'submissions'), orderBy('createdAt', 'desc'), limit(300));
      unsubSubs = onSnapshot(q, (snap) => {
        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderAdminSubs(list);
        subsLoading.classList.add('hidden');
      }, (err) => {
        console.error(err);
        subsLoading.classList.add('hidden');
        showToast({ title: 'Submissions load failed', message: err?.message || 'Check rules/index', type: 'error' });
      });
    }

    function renderAdminSubs(list) {
      subsList.innerHTML = '';
      if (!list.length) {
        subsList.innerHTML = `<div class="text-sm text-white/60">No submissions.</div>`;
        return;
      }

      for (const s of list) {
        const node = document.createElement('div');
        node.className = 'rounded-2xl border border-white/10 bg-slate-950/40 p-4';
        node.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                ${badgeForType(s.taskType)}
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">${escapeHtml(s.status || 'pending')}</span>
                <span class="text-xs text-white/50">${fmtTime(s.createdAt)}</span>
                ${s.taskId ? `<span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">Task #${escapeHtml(s.taskId)}</span>` : ''}
              </div>
              <div class="mt-2 font-semibold break-words">${escapeHtml(s.taskTitle || 'Task')}</div>
              <div class="mt-1 text-xs text-white/60">By: ${escapeHtml(s.userName || 'User')} • ${escapeHtml(s.userEmail || '')}</div>
              <a class="mt-2 block text-sm text-indigo-300 hover:underline break-all" href="${escapeAttr(s.proofLink || '#')}" target="_blank" rel="noreferrer">${escapeHtml(s.proofLink || '')}</a>
              ${s.note ? `<div class="mt-2 text-xs text-white/70 whitespace-pre-wrap">${escapeHtml(s.note)}</div>` : ''}
            </div>
            <div class="shrink-0 rounded-xl border border-white/10 px-3 py-2 text-sm">
              <span class="text-white/60">Price</span>
              <span class="ml-2 font-semibold">$${Number(s.reward ?? 0).toFixed(2)}</span>
            </div>
          </div>
        `;
        subsList.appendChild(node);
      }
    }

    // --- Create task (admin only) ---
    function syncCreateFields() {
      const type = ctType.value;
      const post = type === 'post';

      postFields.classList.toggle('hidden', !post);
      commentFields.classList.toggle('hidden', post);

      // Title is only needed for post tasks
      const titleWrap = el('ctTitleWrap');
      titleWrap?.classList.toggle('hidden', !post);
      el('ctTitle').required = post;
      if (!post) el('ctTitle').value = '';

      // Required toggles
      el('ctBody').required = post;
      el('ctTargetLink').required = !post; // for comment tasks
      el('ctInstructions').required = !post;
    }
    ctType.addEventListener('change', syncCreateFields);
    syncCreateFields();

    function autoTitleForComment({ subreddit, instructions }) {
      const s = safe(instructions).trim().replace(/\s+/g, ' ');
      const short = s.length > 50 ? s.slice(0, 50).trim() + '…' : s;
      return `Comment in r/${subreddit}${short ? ` — ${short}` : ''}`;
    }

    async function allocateNextTaskId(tx) {
      const counterRef = doc(db, COUNTER_DOC.col, COUNTER_DOC.doc);
      const snap = await tx.get(counterRef);

      let next = TASK_ID_START;
      if (snap.exists()) {
        const raw = snap.data()?.[COUNTER_DOC.field];
        const n = Number(raw);
        next = Number.isFinite(n) && n >= TASK_ID_START ? n : TASK_ID_START;
      }

      // Persist next+1
      tx.set(counterRef, { [COUNTER_DOC.field]: next + 1 }, { merge: true });
      return next;
    }

    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser || !isAdmin) {
        showToast({ title: 'Not allowed', message: 'Admin only', type: 'warn' });
        return;
      }

      const type = el('ctType').value;
      const subreddit = el('ctSubreddit').value.trim();
      const rawTitle = el('ctTitle').value.trim();
      const reward = Number(el('ctReward').value);
      const status = el('ctStatus').value;
      const claimMins = Number(el('ctClaimMins').value || 30);
      const expireDays = Number(el('ctExpireDays').value || 0);

      const body = el('ctBody').value.trim();
      const imageUrl = el('ctImage').value.trim();
      const targetLink = el('ctTargetLink').value.trim();
      const instructions = el('ctInstructions').value.trim();

      if (!subreddit) {
        showToast({ title: 'Missing fields', message: 'Subreddit is required.', type: 'warn' });
        return;
      }

      const title = type === 'post' ? rawTitle : autoTitleForComment({ subreddit, instructions });
      if (type === 'post' && !title) {
        showToast({ title: 'Missing fields', message: 'Post tasks require a title.', type: 'warn' });
        return;
      }
      if (!Number.isFinite(reward) || reward < 0) {
        showToast({ title: 'Invalid price', message: 'Please enter a valid USD price.', type: 'warn' });
        return;
      }
      if (!Number.isFinite(claimMins) || claimMins < 1) {
        showToast({ title: 'Invalid claim window', message: 'Minutes must be at least 1.', type: 'warn' });
        return;
      }

      if (type === 'post' && !body) {
        showToast({ title: 'Missing body', message: 'Post tasks require a body.', type: 'warn' });
        return;
      }
      if (type === 'comment' && (!targetLink || !instructions)) {
        showToast({ title: 'Missing fields', message: 'Comment tasks require target link + instructions.', type: 'warn' });
        return;
      }

      setBusy(btnCreateTask, true, createSpinner, createBtnText, 'Creating...');
      try {
        const expiresAt = expireDays > 0 ? new Date(Date.now() + expireDays * 24 * 60 * 60 * 1000) : null;

        let createdTaskId = null;
        await runTransaction(db, async (tx) => {
          const taskNo = await allocateNextTaskId(tx);
          const taskId = String(taskNo); // integer-only doc id (as string)

          const taskRef = doc(db, 'tasks', taskId);
          const existing = await tx.get(taskRef);
          if (existing.exists()) throw new Error(`Task ID collision (#${taskId}). Try again.`);

          tx.set(taskRef, {
            taskNo,
            type,
            subreddit,
            title,
            reward,
            status,
            claimMins,

            // post-specific
            body: type === 'post' ? body : null,
            imageUrl: type === 'post' ? (imageUrl || null) : null,

            // comment-specific
            targetLink: type === 'comment' ? targetLink : null,
            instructions: type === 'comment' ? instructions : null,

            // locking
            lockedByUid: null,
            lockedByName: null,
            lockedUntil: null,
            lockedAt: null,

            // stats
            submittedCount: 0,

            createdByUid: currentUser.uid,
            createdByName: currentUser.displayName || null,
            createdByEmail: currentUser.email || null,
            createdAt: serverTimestamp(),
            expiresAt: expiresAt ? expiresAt : null
          });

          createdTaskId = taskId;
        });

        createForm.reset();
        el('ctReward').value = 1;
        el('ctClaimMins').value = 30;
        el('ctExpireDays').value = 0;
        syncCreateFields();

        showToast({ title: 'Task created', message: `Task #${createdTaskId} saved successfully.` });
        setAdminTab('tasks');
        setPanel('admin');
      } catch (err) {
        console.error(err);
        showToast({ title: 'Create failed', message: err?.message || 'Check Firestore rules', type: 'error' });
      } finally {
        setBusy(btnCreateTask, false, createSpinner, createBtnText, 'Create Task');
      }
    });

    // --- Rendering ---
    function badgeForType(type) {
      if (type === 'post') return '<span class="inline-flex items-center rounded-full bg-indigo-500/15 text-indigo-200 border border-indigo-400/20 px-2 py-0.5 text-xs">POST</span>';
      return '<span class="inline-flex items-center rounded-full bg-emerald-500/15 text-emerald-200 border border-emerald-400/20 px-2 py-0.5 text-xs">COMMENT</span>';
    }

    function isTaskExpired(t) {
      const exp = toMs(t.expiresAt);
      return exp ? exp <= nowMs() : false;
    }

    function lockInfo(t) {
      const until = toMs(t.lockedUntil);
      const locked = until && until > nowMs();
      return { locked, until };
    }

    function userEligible() {
      const karma = Number(currentUserDoc?.redditKarma ?? 0);
      const hasUsername = !!safe(currentUserDoc?.redditUsername).trim();
      return hasUsername && karma >= 200;
    }

    function getActiveClaim() {
      const id = safe(currentUserDoc?.activeClaimTaskId).trim() || null;
      const until = toMs(currentUserDoc?.activeClaimUntil);
      if (!id || !until) return null;
      if (until <= nowMs()) return null;
      return { id, until };
    }

    function renderAll() {
      if (!currentUser) return;

      if (uiPanel === 'user') {
        renderUserTasks();
        renderActiveClaimCard();
      } else {
        renderAdminTasks();
      }
    }

    function renderActiveClaimCard() {
      const ac = getActiveClaim();
      if (!ac) {
        activeClaimCard.classList.add('hidden');
        activeClaimPill.classList.add('hidden');
        return;
      }
      activeClaimCard.classList.remove('hidden');
      activeClaimPill.classList.remove('hidden');

      const t = tasksCache.find(x => x.id === ac.id);
      activeClaimTitle.textContent = t?.title || `Task #${ac.id}`;
      const sub = t?.subreddit ? `r/${t.subreddit}` : '—';
      activeClaimMeta.textContent = `Task #${ac.id} • ${(t?.type || 'task').toUpperCase()} • ${sub} • Price $${Number(t?.reward ?? 0).toFixed(2)}`;
      activeClaimCountdown.textContent = msToClock(ac.until - nowMs());
    }

    function applyCommonFilters(list) {
      const t = typeFilter.value;
      const s = searchInput.value.trim().toLowerCase();

      let out = [...list];
      if (t !== 'all') out = out.filter(x => x.type === t);
      if (s) out = out.filter(x => safe(x.title).toLowerCase().includes(s) || safe(x.subreddit).toLowerCase().includes(s) || safe(x.id).toLowerCase().includes(s));
      return out;
    }

    function renderUserTasks() {
      tasksList.innerHTML = '';

      const eligible = userEligible();
      userEligibilityBanner.classList.toggle('hidden', eligible);

      const activeClaim = getActiveClaim();
      if (activeClaim) {
        tasksEmpty.classList.add('hidden');
        tasksList.innerHTML = `<div class="rounded-2xl border border-white/10 bg-slate-950/40 p-6 text-white/70 text-center sm:col-span-2 xl:col-span-3">You have an active claim. Complete it and submit proof first.</div>`;
        return;
      }

      const base = tasksCache
        .filter(t => !isTaskExpired(t))
        .filter(t => (t.status || 'open') === 'open');

      // hide tasks locked by other users
      const visible = base.filter(t => {
        const { locked } = lockInfo(t);
        if (!locked) return true;
        return t.lockedByUid === currentUser.uid;
      });

      const list = applyCommonFilters(visible);

      if (!list.length) {
        tasksEmpty.classList.remove('hidden');
        return;
      }
      tasksEmpty.classList.add('hidden');

      for (const t of list) {
        const { locked, until } = lockInfo(t);
        const lockedByMe = locked && t.lockedByUid === currentUser.uid;

        const canClaim = eligible && !locked;

        const node = document.createElement('div');
        node.className = 'rounded-2xl border border-white/10 bg-slate-950/40 p-4 hover:bg-white/[0.04] transition';

        const extra = t.type === 'post'
          ? `<div class="mt-2 text-xs text-white/60 line-clamp-2">${escapeHtml(safe(t.body))}</div>`
          : `<div class="mt-2 text-xs text-white/60 line-clamp-2">${escapeHtml(safe(t.instructions))}</div>`;

        node.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                ${badgeForType(t.type)}
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">Task #${escapeHtml(t.id)}</span>
                <span class="text-xs text-white/60">r/${escapeHtml(safe(t.subreddit))}</span>
                ${t.expiresAt ? `<span class="text-xs text-white/50">Exp: ${fmtTime(t.expiresAt)}</span>` : ''}
              </div>
              <div class="mt-2 font-semibold leading-snug break-words">${escapeHtml(safe(t.title))}</div>
              ${extra}
              <div class="mt-2 text-xs text-white/60">Created: ${fmtTime(t.createdAt)} • By: ${escapeHtml(safe(t.createdByName || '—'))}</div>
              ${locked ? `<div class="mt-2 text-xs text-amber-200">Locked ${lockedByMe ? '(you)' : ''} • unlocks at ${new Date(until).toLocaleTimeString()}</div>` : ''}
            </div>

            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 shrink-0">
              <div class="rounded-xl border border-white/10 px-3 py-2 text-sm">
                <span class="text-white/60">Price</span>
                <span class="ml-2 font-semibold">$${Number(t.reward ?? 0).toFixed(2)}</span>
              </div>
              <button class="btnDetails rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5" data-task-id="${t.id}">
                Details
              </button>
              <button class="btnClaim rounded-xl bg-emerald-500 px-3 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400 ${canClaim ? '' : 'opacity-50 cursor-not-allowed'}" data-task-id="${t.id}" ${canClaim ? '' : 'disabled'}>
                Claim
              </button>
            </div>
          </div>
        `;
        tasksList.appendChild(node);
      }

      tasksList.querySelectorAll('.btnDetails').forEach(b => b.addEventListener('click', () => openTaskModal(b.dataset.taskId)));
      tasksList.querySelectorAll('.btnClaim').forEach(b => b.addEventListener('click', () => claimTask(b.dataset.taskId)));
    }

    function renderAdminTasks() {
      if (!isAdmin) return;
      adminTasksList.innerHTML = '';

      let list = [...tasksCache].filter(t => !isTaskExpired(t));
      const st = adminStatusFilter.value;
      if (st !== 'all') list = list.filter(t => (t.status || 'open') === st);
      list = applyCommonFilters(list);

      if (!list.length) {
        adminTasksList.innerHTML = `<div class="rounded-2xl border border-white/10 bg-slate-950/40 p-6 text-white/70 text-center">No tasks.</div>`;
        return;
      }

      for (const t of list) {
        const { locked, until } = lockInfo(t);
        const lockedText = locked
          ? `Locked by: ${escapeHtml(safe(t.lockedByName || t.lockedByUid || '—'))} • left ${msToClock(until - nowMs())}`
          : 'Not locked';

        const node = document.createElement('div');
        node.className = 'rounded-2xl border border-white/10 bg-slate-950/40 p-4';
        node.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                ${badgeForType(t.type)}
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">Task #${escapeHtml(t.id)}</span>
                <span class="text-xs text-white/60">r/${escapeHtml(safe(t.subreddit))}</span>
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">${escapeHtml(safe(t.status || 'open'))}</span>
                <span class="text-xs rounded-full border border-white/10 px-2 py-0.5 text-white/60">Price: $${Number(t.reward ?? 0).toFixed(2)}</span>
                ${t.expiresAt ? `<span class="text-xs text-white/50">Exp: ${fmtTime(t.expiresAt)}</span>` : ''}
              </div>
              <div class="mt-2 font-semibold leading-snug break-words">${escapeHtml(safe(t.title))}</div>
              <div class="mt-2 text-xs text-white/60">Created: ${fmtTime(t.createdAt)} • By: ${escapeHtml(safe(t.createdByName || '—'))}</div>
              <div class="mt-2 text-xs ${locked ? 'text-amber-200' : 'text-white/60'}">${lockedText}</div>
            </div>

            <div class="shrink-0 flex flex-wrap items-center gap-2">
              <button class="btnAdminOpen rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5" data-task-id="${t.id}">Open</button>
              <button class="btnAdminToggle rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5" data-task-id="${t.id}" data-next="${(t.status || 'open') === 'open' ? 'closed' : 'open'}">${(t.status || 'open') === 'open' ? 'Close' : 'Re-open'}</button>
              <button class="btnAdminUnlock rounded-xl border border-white/10 px-3 py-2 text-sm hover:bg-white/5 ${locked ? '' : 'opacity-50 cursor-not-allowed'}" data-task-id="${t.id}" ${locked ? '' : 'disabled'}>Force Unlock</button>
            </div>
          </div>
        `;
        adminTasksList.appendChild(node);
      }

      adminTasksList.querySelectorAll('.btnAdminOpen').forEach(b => b.addEventListener('click', () => openTaskModal(b.dataset.taskId)));
      adminTasksList.querySelectorAll('.btnAdminToggle').forEach(b => b.addEventListener('click', () => toggleTaskStatus(b.dataset.taskId, b.dataset.next)));
      adminTasksList.querySelectorAll('.btnAdminUnlock').forEach(b => b.addEventListener('click', () => forceUnlockTask(b.dataset.taskId)));
    }

    // --- Claim logic ---
    async function claimTask(taskId) {
      if (!currentUser) return;
      if (!userEligible()) {
        showToast({ title: 'Not eligible', message: 'Reddit profile + karma 200+ required.', type: 'warn' });
        openProfile();
        return;
      }

      const existing = getActiveClaim();
      if (existing) {
        showToast({ title: 'Already claimed', message: 'You already have an active claim.', type: 'warn' });
        return;
      }

      let claimMinsUsed = 30;
      try {
        await runTransaction(db, async (tx) => {
          const taskRef = doc(db, 'tasks', taskId);
          const userRef = doc(db, 'users', currentUser.uid);

          const [tSnap, uSnap] = await Promise.all([tx.get(taskRef), tx.get(userRef)]);
          if (!tSnap.exists()) throw new Error('Task not found');
          if (!uSnap.exists()) throw new Error('User document missing');

          const t = tSnap.data();
          const u = uSnap.data();

          if ((t.status || 'open') !== 'open') throw new Error('Task is not open');
          if (t.expiresAt && toMs(t.expiresAt) <= nowMs()) throw new Error('Task expired');

          const karma = Number(u.redditKarma ?? 0);
          const hasUsername = !!safe(u.redditUsername).trim();
          if (!hasUsername || karma < 200) throw new Error('Reddit profile/karma not eligible');

          const uUntil = toMs(u.activeClaimUntil);
          if (u.activeClaimTaskId && uUntil > nowMs()) throw new Error('User already has an active claim');

          const tUntil = toMs(t.lockedUntil);
          const tLocked = tUntil && tUntil > nowMs();
          if (tLocked) throw new Error('Task already locked');

          claimMinsUsed = Number(t.claimMins ?? 30);
          const lockUntil = new Date(Date.now() + claimMinsUsed * 60 * 1000);

          tx.update(taskRef, {
            lockedByUid: currentUser.uid,
            lockedByName: currentUser.displayName || null,
            lockedAt: serverTimestamp(),
            lockedUntil: lockUntil
          });

          tx.update(userRef, {
            activeClaimTaskId: taskId,
            activeClaimUntil: lockUntil
          });
        });

        showToast({ title: 'Claimed', message: `Task locked for ${claimMinsUsed} minutes. Submit proof before time runs out.` });
        await openTaskModal(taskId, true);
      } catch (err) {
        console.error(err);
        showToast({ title: 'Claim failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    }

    async function toggleTaskStatus(taskId, next) {
      if (!currentUser || !isAdmin) return;
      try {
        await updateDoc(doc(db, 'tasks', taskId), { status: next });
        showToast({ title: 'Updated', message: `Task status: ${next}` });
      } catch (err) {
        console.error(err);
        showToast({ title: 'Update failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    }

    async function forceUnlockTask(taskId) {
      if (!currentUser || !isAdmin) return;
      try {
        await updateDoc(doc(db, 'tasks', taskId), {
          lockedByUid: null,
          lockedByName: null,
          lockedAt: null,
          lockedUntil: null
        });
        showToast({ title: 'Unlocked', message: `Task #${taskId} has been force unlocked.` });
      } catch (err) {
        console.error(err);
        showToast({ title: 'Unlock failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    }

    // --- Modal open/close ---
    function openModal() {
      modalOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      modalOverlay.classList.add('hidden');
      document.body.style.overflow = '';
      openTask = null;
      submitForm.reset();
      submitHint.textContent = '';
      taskSubs.innerHTML = '';
      if (unsubTaskSubs) { unsubTaskSubs(); unsubTaskSubs = null; }
    }

    btnCloseModal.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalOverlay.classList.contains('hidden')) closeModal();
    });

    function updateModalDynamic(t) {
      if (!currentUser || !t) return;

      const { locked, until } = lockInfo(t);
      const lockedByMe = locked && t.lockedByUid === currentUser.uid;
      const canClaim = (t.status !== 'closed') && (t.status !== 'submitted') && !locked && userEligible() && !getActiveClaim();

      // Admin actions
      btnForceUnlock.classList.toggle('hidden', !(isAdmin && locked));
      btnForceUnlock.onclick = () => forceUnlockTask(t.id);

      // Claim action
      btnClaim.classList.toggle('hidden', !canClaim);
      btnClaim.onclick = () => claimTask(t.id);

      if (locked) {
        modalLockInfo.textContent = lockedByMe
          ? `Locked by you • time left ${msToClock(until - nowMs())}`
          : `Locked by ${t.lockedByName || t.lockedByUid || 'someone'} • available in ${msToClock(until - nowMs())}`;
      } else {
        modalLockInfo.textContent = (t.status === 'closed')
          ? 'Task is closed.'
          : (t.status === 'submitted')
            ? 'Task is already submitted.'
            : 'Not locked. You can claim if eligible.';
      }

      // Submit form visibility/enable
      const canSubmit = lockedByMe && (until > nowMs());
      submitHint.textContent = canSubmit
        ? `Submit within ${msToClock(until - nowMs())}`
        : (lockedByMe ? 'Lock expired. You may need to claim again if available.' : 'Claim required to submit.');

      submitForm.classList.toggle('opacity-60', !canSubmit);
      proofLink.disabled = !canSubmit;
      proofNote.disabled = !canSubmit;
      btnSubmitProof.disabled = !canSubmit;
      btnSubmitProof.classList.toggle('opacity-50', !canSubmit);
      btnSubmitProof.classList.toggle('cursor-not-allowed', !canSubmit);
    }

    async function openTaskModal(taskId, forceFetch = false) {
      if (!currentUser) return;
      try {
        let t = null;
        if (!forceFetch) {
          t = tasksCache.find(x => x.id === taskId) || null;
        }

        if (!t) {
          const ref = doc(db, 'tasks', taskId);
          const snap = await getDoc(ref);
          if (!snap.exists()) {
            showToast({ title: 'Not found', message: 'This task was deleted.', type: 'warn' });
            return;
          }
          t = { id: taskId, ...snap.data() };
        }

        openTask = t;

        // Basic
        modalType.textContent = `${(t.type || 'task').toUpperCase()} • ${t.status || 'open'} • Task #${t.id}`;
        modalTitle.textContent = t.title || '—';
        modalMeta.textContent = `Created: ${fmtTime(t.createdAt)} • r/${t.subreddit || '—'} • By: ${t.createdByName || '—'}`;

        // image
        if (t.imageUrl) {
          modalImageWrap.classList.remove('hidden');
          modalImage.src = t.imageUrl;
        } else {
          modalImageWrap.classList.add('hidden');
          modalImage.src = '';
        }

        // details
        if (t.type === 'post') {
          modalDetails.textContent = `POST BODY:\n${t.body || ''}`;
          modalLink.textContent = `https://www.reddit.com/r/${t.subreddit}/submit`;
          modalLink.href = `https://www.reddit.com/r/${t.subreddit}/submit`;
        } else {
          modalDetails.textContent = `INSTRUCTIONS:\n${t.instructions || ''}`;
          modalLink.textContent = t.targetLink || '—';
          modalLink.href = t.targetLink || '#';
        }

        modalReward.textContent = `$${Number(t.reward ?? 0).toFixed(2)}`;

        // dynamic
        updateModalDynamic(t);

        listenTaskSubmissions(taskId);
        openModal();
      } catch (err) {
        console.error(err);
        showToast({ title: 'Open failed', message: err?.message || 'Unknown error', type: 'error' });
      }
    }

    // Recent submissions for modal
    function listenTaskSubmissions(taskId) {
      if (unsubTaskSubs) { unsubTaskSubs(); unsubTaskSubs = null; }
      const q = query(collection(db, 'submissions'), where('taskId', '==', taskId), orderBy('createdAt', 'desc'), limit(10));
      unsubTaskSubs = onSnapshot(q, (snap) => {
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTaskSubmissions(items);
      }, (err) => {
        console.error(err);
        taskSubs.innerHTML = `<div class="text-xs text-rose-200">Submissions load failed: ${escapeHtml(err?.message || 'error')}</div>`;
      });
    }

    function renderTaskSubmissions(items) {
      taskSubs.innerHTML = '';
      if (!items.length) {
        taskSubs.innerHTML = `<div class="text-xs text-white/60">No submissions yet.</div>`;
        return;
      }
      for (const s of items) {
        const mine = currentUser && s.uid === currentUser.uid;
        const node = document.createElement('div');
        node.className = 'rounded-xl border border-white/10 bg-slate-950/40 p-3';
        node.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-white/60">${escapeHtml(s.userName || 'User')} ${mine ? '<span class="ml-1 text-[11px] text-indigo-200">(you)</span>' : ''} • ${fmtTime(s.createdAt)}</div>
              <a class="mt-1 block text-sm text-indigo-300 hover:underline break-all" href="${escapeAttr(s.proofLink || '#')}" target="_blank" rel="noreferrer">${escapeHtml(s.proofLink || '')}</a>
              ${s.note ? `<div class="mt-1 text-xs text-white/70 whitespace-pre-wrap">${escapeHtml(s.note)}</div>` : ''}
            </div>
            <div class="text-[11px] rounded-full border border-white/10 px-2 py-1 text-white/60">${escapeHtml(s.status || 'pending')}</div>
          </div>
        `;
        taskSubs.appendChild(node);
      }
    }

    // Submit proof
    submitForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser || !openTask) return;

      const link = proofLink.value.trim();
      const note = proofNote.value.trim();
      if (!link) return;

      setBusy(btnSubmitProof, true, submitSpinner, submitBtnText, 'Submitting...');
      try {
        await runTransaction(db, async (tx) => {
          const taskRef = doc(db, 'tasks', openTask.id);
          const userRef = doc(db, 'users', currentUser.uid);

          const [tSnap, uSnap] = await Promise.all([tx.get(taskRef), tx.get(userRef)]);
          if (!tSnap.exists()) throw new Error('Task not found');
          if (!uSnap.exists()) throw new Error('User document missing');

          const t = tSnap.data();
          const u = uSnap.data();

          const until = toMs(t.lockedUntil);
          if (!t.lockedByUid || t.lockedByUid !== currentUser.uid) throw new Error('You did not claim this task');
          if (!until || until <= nowMs()) throw new Error('Claim time expired');

          // Ensure user claim matches
          const uUntil = toMs(u.activeClaimUntil);
          if (u.activeClaimTaskId !== openTask.id || !uUntil || uUntil <= nowMs()) throw new Error('Your active claim is not valid');

          // Prevent duplicates without query/index
          const subId = `${openTask.id}_${currentUser.uid}`;
          const subRef = doc(db, 'submissions', subId);
          const subSnap = await tx.get(subRef);
          if (subSnap.exists()) throw new Error('Already submitted for this task');

          tx.set(subRef, {
            taskId: openTask.id,
            taskTitle: t.title || null,
            taskType: t.type || null,
            reward: Number(t.reward ?? 0),
            uid: currentUser.uid,
            userName: currentUser.displayName || null,
            userEmail: currentUser.email || null,
            proofLink: link,
            note: note || null,
            status: 'pending',
            createdAt: serverTimestamp()
          });

          // Mark task as submitted (single-use) and clear lock
          tx.update(taskRef, {
            status: 'submitted',
            lockedByUid: null,
            lockedByName: null,
            lockedAt: null,
            lockedUntil: null,
            submittedCount: increment(1)
          });

          // Clear user active claim
          tx.update(userRef, {
            activeClaimTaskId: null,
            activeClaimUntil: null
          });
        });

        submitForm.reset();
        showToast({ title: 'Submitted', message: 'Proof submitted (pending review).' });
        closeModal();
      } catch (err) {
        console.error(err);
        showToast({ title: 'Submit failed', message: err?.message || 'Unknown error', type: 'error' });
      } finally {
        setBusy(btnSubmitProof, false, submitSpinner, submitBtnText, 'Submit');
      }
    });

    // --- Profile modal ---
    function openProfile() {
      if (!currentUser) return;
      const u = currentUserDoc || {};
      rpUsername.value = u.redditUsername || '';
      rpLink.value = u.redditProfileLink || '';
      rpKarma.value = (u.redditKarma ?? '') === null ? '' : (u.redditKarma ?? '');

      profileOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeProfile() {
      profileOverlay.classList.add('hidden');
      document.body.style.overflow = '';
      profileForm.reset();
      profileHint.textContent = 'Karma must be 200+ to claim tasks.';
    }

    btnEditProfile.addEventListener('click', openProfile);
    btnOpenProfileFromBanner.addEventListener('click', openProfile);
    btnCloseProfile.addEventListener('click', closeProfile);
    profileOverlay.addEventListener('click', (e) => {
      if (e.target === profileOverlay) closeProfile();
    });

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const username = rpUsername.value.trim();
      const link = rpLink.value.trim();
      const karma = Number(rpKarma.value);

      if (!username) {
        profileHint.textContent = 'Reddit username is required.';
        showToast({ title: 'Invalid', message: 'Reddit username is required.', type: 'warn' });
        return;
      }
      if (!Number.isFinite(karma) || karma < 0) {
        profileHint.textContent = 'Please enter a valid karma number.';
        showToast({ title: 'Invalid', message: 'Please enter a valid karma number.', type: 'warn' });
        return;
      }
      if (karma < 200) {
        profileHint.textContent = 'Minimum karma 200+ required.';
        showToast({ title: 'Not eligible', message: 'Minimum karma 200+ required.', type: 'warn' });
        return;
      }

      setBusy(btnSaveProfile, true, profileSpinner, profileBtnText, 'Saving...');
      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
          redditUsername: username,
          redditProfileLink: link || null,
          redditKarma: karma
        });
        showToast({ title: 'Saved', message: 'Profile updated successfully.' });
        closeProfile();
      } catch (err) {
        console.error(err);
        showToast({ title: 'Save failed', message: err?.message || 'Unknown error', type: 'error' });
      } finally {
        setBusy(btnSaveProfile, false, profileSpinner, profileBtnText, 'Save');
      }
    });

    // Active claim open
    btnOpenActiveClaim.addEventListener('click', async () => {
      const ac = getActiveClaim();
      if (!ac) return;
      await openTaskModal(ac.id);
    });

    btnOpenClaimModal.addEventListener('click', async () => {
      const ac = getActiveClaim();
      if (!ac) return;
      await openTaskModal(ac.id);
    });

    // Cleanup expired claims: clear user fields and unlock task if it was locked by user
    async function maybeCleanupExpiredClaim() {
      if (!currentUser || !currentUserDoc) return;
      const id = safe(currentUserDoc.activeClaimTaskId).trim();
      const until = toMs(currentUserDoc.activeClaimUntil);
      if (!id || !until) return;
      if (until > nowMs()) return;

      try {
        await runTransaction(db, async (tx) => {
          const userRef = doc(db, 'users', currentUser.uid);
          const taskRef = doc(db, 'tasks', id);

          const [uSnap, tSnap] = await Promise.all([tx.get(userRef), tx.get(taskRef)]);
          if (uSnap.exists()) {
            tx.update(userRef, { activeClaimTaskId: null, activeClaimUntil: null });
          }

          if (tSnap.exists()) {
            const t = tSnap.data();
            const tUntil = toMs(t.lockedUntil);
            const stillLockedByMe = t.lockedByUid === currentUser.uid;
            if (stillLockedByMe && tUntil && tUntil <= nowMs()) {
              tx.update(taskRef, { lockedByUid: null, lockedByName: null, lockedAt: null, lockedUntil: null });
            }
          }
        });
      } catch (err) {
        console.warn('Cleanup failed', err);
      }
    }

    // Lightweight tick: update countdown-only UI (no full re-render)
    setInterval(() => {
      if (!currentUser) return;

      const ac = getActiveClaim();
      if (ac) {
        const left = ac.until - nowMs();
        activeClaimTime.textContent = msToClock(left);
        activeClaimCountdown.textContent = msToClock(left);
      }

      if (!modalOverlay.classList.contains('hidden') && openTask) {
        updateModalDynamic(openTask);
      }

      // occasional cleanup if claim expired
      maybeCleanupExpiredClaim();
    }, 1000);

    // --- Initial UI state ---
    hero.classList.remove('hidden');
    appSection.classList.add('hidden');
  </script>
</body>
</html>
